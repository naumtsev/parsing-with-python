<!DOCTYPE html>
<html lang="ru" data-vue-meta="%7B%22lang%22:%7B%22ssr%22:%22ru%22%7D%7D">
<head >
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover">
  <title>Принципы работы протокола BGP / Хабр</title>
  <style>
    /* cyrillic-ext */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveSxf6TF0.woff2) format('woff2');
      unicode-range: U+0460-052F, U+1C80-1C88, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
    }

    /* cyrillic */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveQhf6TF0.woff2) format('woff2');
      unicode-range: U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
    }

    /* latin-ext */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveSBf6TF0.woff2) format('woff2');
      unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
    }

    /* latin */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveRhf6.woff2) format('woff2');
      unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
    }
  </style>
  <link rel="preload" href="https://assets.habr.com/habr-web/css/chunk-vendors.e7843cc0.css" as="style"><link rel="preload" href="https://assets.habr.com/habr-web/js/chunk-vendors.c2c3fc9a.js" as="script"><link rel="preload" href="https://assets.habr.com/habr-web/css/app.02ee25a4.css" as="style"><link rel="preload" href="https://assets.habr.com/habr-web/js/app.c0af73e7.js" as="script">
  <link rel="stylesheet" href="https://assets.habr.com/habr-web/css/chunk-vendors.e7843cc0.css"><link rel="stylesheet" href="https://assets.habr.com/habr-web/css/app.02ee25a4.css">
  <script>window.i18nFetch = new Promise((res, rej) => {
          const xhr = new XMLHttpRequest();
          xhr.open('GET', '/js/i18n/ru-compiled.85eb77f0b17c8235e7b64b9f81ea5ec2.json');
          xhr.responseType = 'json';
          xhr.onload = function(e) {
            if (this.status === 200) {
              res({ru: xhr.response});
            } else {
              rej(e);
            }
          };
          xhr.send();
        });</script>
  
  <script data-vue-meta="ssr" src="/js/ads.js" onload="window['zhY4i4nJ9K'] = true" data-vmid="checkad"></script><script data-vue-meta="ssr" type="application/ld+json" data-vmid="ldjson-schema">{"@context":"http:\/\/schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/habr.com\/ru\/post\/450814\/"},"headline":"Принципы работы протокола BGP","datePublished":"2019-05-08T09:35:50+03:00","dateModified":"2020-08-08T15:09:16+03:00","author":{"@type":"Person","name":"Руслан Мамедов"},"publisher":{"@type":"Organization","name":"Habr","logo":{"@type":"ImageObject","url":"https:\/\/habrastorage.org\/webt\/a_\/lk\/9m\/a_lk9mjkccjox-zccjrpfolmkmq.png"}},"description":"Сегодня мы рассмотрим протокол BGP. Не будем долго говорить зачем он и почему он используется как единственный протокол. Довольно много информации есть на этот с...","url":"https:\/\/habr.com\/ru\/post\/450814\/#post-content-body","about":["h_cisconetworks","h_network_technologies","f_admin"],"image":["https:\/\/habrastorage.org\/getpro\/habr\/post_images\/3fa\/da6\/dd3\/3fada6dd3c41923367af475da9b0ae10.jpg","https:\/\/habrastorage.org\/getpro\/habr\/post_images\/d9d\/231\/607\/d9d2316070de22049a24da6d86cecb2b.jpg","https:\/\/habrastorage.org\/getpro\/habr\/post_images\/853\/f42\/1f0\/853f421f0a69f407c5ae4eae3423240c.jpg","https:\/\/habrastorage.org\/getpro\/habr\/post_images\/cea\/5f8\/2b0\/cea5f82b050662b2632cab01f3de8e24.jpg","https:\/\/habrastorage.org\/getpro\/habr\/post_images\/5e7\/80b\/ca0\/5e780bca084e8f42dab14d03f62723b6.jpg","https:\/\/habrastorage.org\/getpro\/habr\/post_images\/d55\/6a8\/741\/d556a874120b70319381332cdddf739b.jpg"]}</script>
  <script src="//www.googletagservices.com/tag/js/gpt.js" async></script>
  <style>.grecaptcha-badge{visibility: hidden;}</style>
  <meta name="habr-version" content="2.49.0">
  
  <meta data-vue-meta="ssr" property="fb:app_id" content="444736788986613"><meta data-vue-meta="ssr" property="fb:pages" content="472597926099084"><meta data-vue-meta="ssr" name="twitter:card" content="summary_large_image"><meta data-vue-meta="ssr" name="twitter:site" content="@habr_eng"><meta data-vue-meta="ssr" property="og:title" content="Принципы работы протокола BGP" data-vmid="og:title"><meta data-vue-meta="ssr" name="twitter:title" content="Принципы работы протокола BGP" data-vmid="twitter:title"><meta data-vue-meta="ssr" name="aiturec:title" content="Принципы работы протокола BGP" data-vmid="aiturec:title"><meta data-vue-meta="ssr" name="description" content="Сегодня мы рассмотрим протокол BGP. Не будем долго говорить зачем он и почему он используется как единственный протокол. Довольно много информации есть на этот счет, например тут. 

Итак, что такое..." data-vmid="description"><meta data-vue-meta="ssr" itemprop="description" content="Сегодня мы рассмотрим протокол BGP. Не будем долго говорить зачем он и почему он используется как единственный протокол. Довольно много информации есть на этот счет, например тут. 

Итак, что такое..." data-vmid="description:itemprop"><meta data-vue-meta="ssr" property="og:description" content="Сегодня мы рассмотрим протокол BGP. Не будем долго говорить зачем он и почему он используется как единственный протокол. Довольно много информации есть на этот счет, например тут. 

Итак, что такое..." data-vmid="og:description"><meta data-vue-meta="ssr" name="twitter:description" content="Сегодня мы рассмотрим протокол BGP. Не будем долго говорить зачем он и почему он используется как единственный протокол. Довольно много информации есть на этот счет, например тут. 

Итак, что такое..." data-vmid="twitter:description"><meta data-vue-meta="ssr" property="aiturec:description" content="Сегодня мы рассмотрим протокол BGP. Не будем долго говорить зачем он и почему он используется как единственный протокол. Довольно много информации есть на этот счет, например тут. 

Итак, что такое..." data-vmid="aiturec:description"><meta data-vue-meta="ssr" itemprop="image" content="https://habr.com/share/publication/450814/f464f1584538946e24ce1d53b2693aba/" data-vmid="image:itemprop"><meta data-vue-meta="ssr" property="og:image" content="https://habr.com/share/publication/450814/f464f1584538946e24ce1d53b2693aba/" data-vmid="og:image"><meta data-vue-meta="ssr" property="aiturec:image" content="https://habr.com/share/publication/450814/f464f1584538946e24ce1d53b2693aba/" data-vmid="aiturec:image"><meta data-vue-meta="ssr" name="twitter:image" content="https://habr.com/share/publication/450814/f464f1584538946e24ce1d53b2693aba/" data-vmid="twitter:image"><meta data-vue-meta="ssr" property="vk:image" content="https://habr.com/share/publication/450814/f464f1584538946e24ce1d53b2693aba/" data-vmid="vk:image"><meta data-vue-meta="ssr" property="aiturec:item_id" content="450814" data-vmid="aiturec:item_id"><meta data-vue-meta="ssr" property="aiturec:datetime" content="2019-05-08T06:35:50.000Z" data-vmid="aiturec:datetime"><meta data-vue-meta="ssr" property="og:type" content="article" data-vmid="og:type"><meta data-vue-meta="ssr" property="og:locale" content="ru_RU" data-vmid="og:locale"><meta data-vue-meta="ssr" property="og:image:width" content="1200" data-vmid="og:image:width"><meta data-vue-meta="ssr" property="og:image:height" content="630" data-vmid="og:image:height">
  <link data-vue-meta="ssr" href="https://habr.com/ru/rss/post/450814/?fl=ru" type="application/rss+xml" title="" rel="alternate" name="rss"><link data-vue-meta="ssr" href="https://habr.com/ru/post/450814/" rel="canonical" data-vmid="canonical"><link data-vue-meta="ssr" data-vmid="hreflang"><link data-vue-meta="ssr" image_src="image" href="https://habr.com/share/publication/450814/f464f1584538946e24ce1d53b2693aba/" data-vmid="image:href">
  <meta name="apple-mobile-web-app-status-bar-style" content="#303b44">
  <meta name="msapplication-TileColor" content="#629FBC">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <link
    rel="shortcut icon"
    type="image/png"
    sizes="16x16"
    href="https://assets.habr.com/habr-web/img/favicons/favicon-16.png"
  >
  <link
    rel="shortcut icon"
    type="image/png"
    sizes="32x32"
    href="https://assets.habr.com/habr-web/img/favicons/favicon-32.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="76x76"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-76.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="120x120"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-120.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="152x152"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-152.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="180x180"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-180.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="256x256"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-256.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1136x640.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2436x1125.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1792x828.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_828x1792.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1334x750.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1242x2668.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2208x1242.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1125x2436.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1242x2208.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2732x2048.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2688x1242.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2224x1668.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_750x1334.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2048x2732.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2388x1668.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1668x2224.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_640x1136.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1668x2388.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2048x1536.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1536x2048.png"
  >
  <link
    rel="mask-icon"
    color="#77a2b6"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-120.svg"
  >
  <link
    crossorigin="use-credentials"
    href="/manifest.webmanifest"
    rel="manifest"
  >
</head>
<body>


<div id="app" data-server-rendered="true" data-async-called="true"><div class="tm-layout__wrapper"><!----> <div></div> <!----> <header class="tm-header"><div class="tm-page-width"><div class="tm-header__container"><!----> <span class="tm-header__logo-wrap"><a href="/ru/" class="tm-header__logo tm-header__logo_ru"><svg height="16" width="16" class="tm-svg-img tm-header__icon"><title>Хабр</title> <use xlink:href="/img/habr-logo-ru.svg#logo"></use></svg></a> <span class="tm-header__beta-sign" style="display:none;">β</span></span> <div class="tm-dropdown tm-header__projects"><div class="tm-dropdown__head"><button class="tm-header__dropdown-toggle"><svg height="16" width="16" class="tm-svg-img tm-header__icon tm-header__icon_dropdown"><title>Открыть список</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#arrow-down"></use></svg></button></div> <!----></div> <a href="/ru/sandbox/start/" class="tm-header__become-author-btn">
            Как стать автором
          </a> <div class="tm-feature tm-header__feature tm-feature_variant-inline"><!----></div> <!----> <!----></div></div></header> <div class="tm-layout"><div class="tm-page-progress-bar"></div> <div data-menu-sticky="true" class="tm-base-layout__header tm-base-layout__header_is-sticky"><div class="tm-page-width"><div class="tm-base-layout__header-wrapper"><div class="tm-main-menu"><div class="tm-main-menu__section"><nav class="tm-main-menu__section-content"><!----> <a href="/ru/all/" class="tm-main-menu__item">
        Все потоки
      </a> <a href="/ru/flows/develop/" class="tm-main-menu__item">
          Разработка
        </a><a href="/ru/flows/admin/" class="tm-main-menu__item">
          Администрирование
        </a><a href="/ru/flows/design/" class="tm-main-menu__item">
          Дизайн
        </a><a href="/ru/flows/management/" class="tm-main-menu__item">
          Менеджмент
        </a><a href="/ru/flows/marketing/" class="tm-main-menu__item">
          Маркетинг
        </a><a href="/ru/flows/popsci/" class="tm-main-menu__item">
          Научпоп
        </a></nav></div></div> <div class="tm-header-user-menu tm-base-layout__user-menu"><a href="/ru/search/" class="tm-header-user-menu__item tm-header-user-menu__search"><svg height="24" width="24" class="tm-svg-img tm-header-user-menu__icon tm-header-user-menu__icon_search tm-header-user-menu__icon_dark"><title>Поиск</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#search"></use></svg></a> <!----> <!----> <!----> <div class="tm-header-user-menu__item tm-header-user-menu__user_desktop"><div class="tm-dropdown"><div class="tm-dropdown__head"><svg height="24" width="24" data-test-id="menu-toggle-guest" class="tm-svg-img tm-header-user-menu__icon"><title>Профиль</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#header-user"></use></svg> <!----></div> <!----></div> <!----></div> <!----></div></div></div></div> <!----> <div class="tm-page-width"></div> <main class="tm-layout__container"><div hl="ru" data-async-called="true" class="tm-page"><div class="tm-page-width"><!----> <div class="tm-page__wrapper"><div class="tm-page__main tm-page__main_has-sidebar"><div class="pull-down"><div class="pull-down__header" style="height:0px;"><div class="pull-down__content" style="bottom:10px;"><svg height="24" width="24" class="tm-svg-img pull-down__arrow"><title>Обновить</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#pull-arrow"></use></svg></div></div> <div class="tm-article-presenter"> <div class="tm-article-presenter__body"><div class="tm-misprint-area"><div class="tm-misprint-area__wrapper"><article class="tm-article-presenter__content tm-article-presenter__content_narrow"><div class="tm-article-presenter__header"> <div class="tm-article-snippet tm-article-presenter__snippet"><div class="tm-article-snippet__meta-container"><div class="tm-article-snippet__meta"><span class="tm-user-info tm-article-snippet__author"><a href="/ru/users/Ruslan_Mammadov/" title="Ruslan_Mammadov" class="tm-user-info__userpic"><div class="tm-entity-image"><img alt="" height="24" loading="lazy" src="//habrastorage.org/r/w32/getpro/habr/avatars/5f8/12c/fb5/5f812cfb51ea930aaaf44c03a752f162.jpg" width="24" class="tm-entity-image__pic"></div></a> <span class="tm-user-info__user"><a href="/ru/users/Ruslan_Mammadov/" class="tm-user-info__username">
      Ruslan_Mammadov
    </a> </span></span> <span class="tm-article-snippet__datetime-published"><time datetime="2019-05-08T06:35:50.000Z" title="2019-05-08, 09:35">8  мая  2019 в 09:35</time></span></div> <!----></div> <h1 lang="ru" class="tm-article-snippet__title tm-article-snippet__title_h1"><span>Принципы работы протокола BGP</span></h1> <div class="tm-article-snippet__hubs"><span class="tm-article-snippet__hubs-item"><a href="/ru/hub/cisconetworks/" class="tm-article-snippet__hubs-item-link"><span>Cisco</span> <span title="Профильный хаб" class="tm-article-snippet__profiled-hub">*</span></a></span><span class="tm-article-snippet__hubs-item"><a href="/ru/hub/network_technologies/" class="tm-article-snippet__hubs-item-link"><span>Сетевые технологии</span> <span title="Профильный хаб" class="tm-article-snippet__profiled-hub">*</span></a></span></div> <!----> <!----> <!----></div></div> <!----> <div data-gallery-root="" lang="ru" class="tm-article-body"><div id="post-content-body" class="article-formatted-body article-formatted-body_version-1"><div xmlns="http://www.w3.org/1999/xhtml">Сегодня мы рассмотрим протокол BGP. Не будем долго говорить зачем он и почему он используется как единственный протокол. Довольно много информации есть на этот счет, например <a href="https://habrahabr.ru/post/184350/" rel="nofollow">тут</a>. <br/>
<br/>
Итак, что такое BGP? BGP — это протокол динамической маршрутизации, являющийся единственным EGP( External Gateway Protocol) протоколом. Данный протокол используется для построения маршрутизации в интернете. Рассмотрим как строится соседство между двумя маршрутизаторами BGP.<br/>
<br/>
<a href="https://i.imgur.com/qm2GlXn.jpg" rel="nofollow"><img src="https://habrastorage.org/r/w780q1/getpro/habr/post_images/3fa/da6/dd3/3fada6dd3c41923367af475da9b0ae10.jpg" alt="My Image" data-src="https://habrastorage.org/getpro/habr/post_images/3fa/da6/dd3/3fada6dd3c41923367af475da9b0ae10.jpg" data-blurred="true"/></a><br/>
Рассмотрим соседство между Router1 и Router3. Настроим их при помощи следующих команд: <a name="habracut"></a><br/>
<pre><code class="plaintext">router bgp 10
  network 192.168.12.0
  network 192.168.13.0
  neighbor 192.168.13.3 remote-as 10

router bgp 10
  network 192.168.13.0
  network 192.168.24.0
  neighbor 192.168.13.1 remote-as 10</code></pre><br/>
Соседство внутри одной автономной системы — AS 10. После ввода данных на маршрутизаторе, например на Router1, данный маршрутизатор пытается настроить отношения соседства с маршрутизатором Router3. Начальное состояние, когда ничего не происходит называется <b>Idle</b>. Как только будет настроен bgp на Router1, он начнет слушать TCP порт 179 — перейдет в состояние <b>Connect</b>, а когда пытается открыть сессию с Router3, то перейдет в состояние <b>Active</b>. <br/>
<br/>
После того, как сессия установится между Router1 и Router3, то происходит обмен Open сообщениями. Когда данное сообщение отправит Router1, то данное состояние будет называться <b>Open Sent</b>. А когда получит Open сообщение от Router3, то перейдет в состояние <b>Open Confirm</b>. Рассмотрим более подробно сообщение Open:<br/>
<br/>
<a href="https://i.imgur.com/iwXv3hW.jpg" rel="nofollow"><img src="https://habrastorage.org/r/w780q1/getpro/habr/post_images/d9d/231/607/d9d2316070de22049a24da6d86cecb2b.jpg" alt="My Image" data-src="https://habrastorage.org/getpro/habr/post_images/d9d/231/607/d9d2316070de22049a24da6d86cecb2b.jpg" data-blurred="true"/></a><br/>
В данном сообщение передается информация о самом протоколе BGP, который использует маршрутизатор. Обмениваясь Open сообщениями, Router1 и Router3 сообщают друг другу информацию о своих настройках. Передаются следующие параметры:<br/>
<blockquote> <ul>
<li><b>Version</b>: this includes the BGP version that the router is using. The current version of BGP is version 4 which is described in RFC 4271. Two BGP routers will try to negotiate a compatible version, when there is a mismatch then there will be no BGP session.</li>
<li> <b> My AS</b>: this includes the AS number of the BGP router, the routers will have to agree on the AS number(s) and it also defines if they will be running iBGP or eBGP.</li>
<li> <b> Hold Time</b>: if BGP doesn’t receive any keepalive or update messages from the other side for the duration of the hold time then it will declare the other side ‘dead’ and it will tear down the BGP session. By default the hold time is set to 180 seconds on Cisco IOS routers, the keepalive message is sent every 60 seconds. Both routers have to agree on the hold time or there won’t be a BGP session.</li>
<li> <b> BGP Identifier</b>: this is the local BGP router ID which is elected just like OSPF does:<br/>
<ul>
<li> Use the router-ID that was configured manually with the bgp router-id command.</li>
<li> Use the highest IP address on a loopback interface.</li>
<li> Use the highest IP address on a physical interface.</li>
</ul></li>
<li> <b>Optional Parameters</b>: here you will find some optional capabilities of the BGP router. This field has been added so that new features could be added to BGP without having to create a new version.Things you might find here are:<br/>
<br/>
<ul>
<li> support for MP-BGP (Multi Protocol BGP).</li>
<li> support for Route Refresh.</li>
<li> support for 4-octet AS numbers.</li>
</ul></li>
</ul></blockquote> Для установления соседства необходимо выполнения следующих условий:<br/>
 <br/>
<ul>
<li>Номер версии. Нынешняя версия 4.</li>
<li> Номер AS должен совпадать с тем, что вы настроили <b>neighbor 192.168.13.3 remote-as 10</b>.</li>
<li> Router ID должен быть отличным от соседа. </li>
</ul><br/>
Если какой-то из параметров не удовлетворяет этим условиям, то маршрутизатор отправит <b>Notification </b>сообщение, где укажет ошибку. После отправки и получения Open сообщений, отношения соседства переходит в состояние <b>ESTABLISHED</b>. После этого уже маршрутизаторы могут обмениваться информацией о маршрутах и делают это при помощи <b>Update </b>сообщений. Вот такое Update сообщение отправляет Router1 к Router3:<br/>
<br/>
<a href="https://i.imgur.com/6pcJb93.jpg" rel="nofollow"><img src="https://habrastorage.org/r/w780q1/getpro/habr/post_images/853/f42/1f0/853f421f0a69f407c5ae4eae3423240c.jpg" alt="My Image" data-src="https://habrastorage.org/getpro/habr/post_images/853/f42/1f0/853f421f0a69f407c5ae4eae3423240c.jpg" data-blurred="true"/></a><br/>
<br/>
Здесь указывают сети, о которых сообщает Router1 и Path attributes, которые являются аналогом метрик. О Path attributes мы поговорим более подробно. Также внутри TCP сессии передаются Keepalive сообщения. Они передаются, по умолчанию, каждые 60 секунд. Это Keepalive Timer. Если в течении Hold Timer-а не будет получено Keepalive сообщение, то это будет означать потерю связи с соседом. По умолчанию, он равен — 180 секундам.<br/>
<br/>
Полезная табличка:<br/>
<br/>
<a href="https://i.imgur.com/6pcJb93.jpg" rel="nofollow"><img src="https://habrastorage.org/r/w780q1/getpro/habr/post_images/853/f42/1f0/853f421f0a69f407c5ae4eae3423240c.jpg" alt="My Image" data-src="https://habrastorage.org/getpro/habr/post_images/853/f42/1f0/853f421f0a69f407c5ae4eae3423240c.jpg" data-blurred="true"/></a><br/>
<br/>
Вроде бы разобрались как маршрутизаторы передают друг другу информацию, теперь попытаемся разобраться с логикой работы протокола BGP. <br/>
<br/>
Чтобы анонсировать какой-нибудь маршрут в таблицу BGP, как и в протоколах IGP, используется команда network, но логика работы отличается. Если в IGP, после указание маршрута в команде network, IGP смотрит — какие интерфейсы принадлежат данной подсети и включает их в свою таблицу, то команда network в BGP смотрит в таблицу маршрутизации и ищет <b>точное </b>совпадение с маршрутом в команде network. При нахождении таких, данные маршруты попадут в таблицу BGP.<br/>
<blockquote>Look for a route in the router’s current IP routing table that exactly matches the parameters of the network command; if the IP route exists, put the equivalent NLRI into the local BGP table.</blockquote> Теперь поднимем BGP на всех оставшихся и посмотрим как происходит выбор маршрута внутри одной AS. После того, как BGP маршрутизатор получит маршруты от соседа, то начинается выбор оптимального маршрута. Здесь надо понять какого вида соседи могут быть — внутренние и внешние. Маршрутизатор по конфигурации понимает является ли сконфигурированный сосед внутренним или внешним. Если в команде:<br/>
<br/>
<pre><code class="plaintext">neighbor 192.168.13.3 remote-as 10 </code></pre> <br/>
в качестве параметра remote-as указан AS, который сконфигурирован на самом маршрутизаторе в команде router bgp 10. Маршруты, пришедшие из внутренней AS считаются внутренними, а маршруты из внешней соответственно внешними. И по отношению к каждому работает разная логика получения и отправки. Рассмотрим такую топологию:<br/>
<br/>
<a href="https://i.imgur.com/GkFjpUM.jpg" rel="nofollow"><img src="https://habrastorage.org/r/w780q1/getpro/habr/post_images/cea/5f8/2b0/cea5f82b050662b2632cab01f3de8e24.jpg" alt="My Image" data-src="https://habrastorage.org/getpro/habr/post_images/cea/5f8/2b0/cea5f82b050662b2632cab01f3de8e24.jpg" data-blurred="true"/></a><br/>
<br/>
На каждом маршрутизаторы настроен loopback интрефейс с ip: x.x.x.x 255.255.255.0 — где x номер маршрутизатора. На Router9 у нас есть loopback интерфейс с адресом — 9.9.9.9 255.255.255.0. Его мы будем анонсировать по BGP и посмотрим как он распространяется. Данный маршрут будет передан на Router8 и Router12. С Router8 данный маршрут попадет на Router6, но на Router5 в таблице маршрутизации его не будет. Также и на Router12 данный маршрут попадет в таблицу, но на Router11 его также не будет. Попытаемся разобраться с этим. Рассмотрим какие данные и параметры передается Router9 своим соседям, сообщая об этом маршруте. Пакет внизу будет отправлен с Router9 на Router8.<br/>
<br/>
<a href="https://i.imgur.com/MCZqzIn.jpg" rel="nofollow"><img src="https://habrastorage.org/r/w780q1/getpro/habr/post_images/5e7/80b/ca0/5e780bca084e8f42dab14d03f62723b6.jpg" alt="My Image" data-src="https://habrastorage.org/getpro/habr/post_images/5e7/80b/ca0/5e780bca084e8f42dab14d03f62723b6.jpg" data-blurred="true"/></a><br/>
Информация о маршруте состоит из аттрибутов пути (Path attributes). <br/>
<br/>
Атрибуты пути разделены на 4 категории:<br/>
<br/>
<ol>
<li> <b> Well-known mandatory</b> — все маршрутизаторы, работающие по протоколу BGP, должны распознавать эти атрибуты. Должны присутствовать во всех обновлениях (update).</li>
<li> <b> Well-known discretionary</b> — все маршрутизаторы, работающие по протоколу BGP, должны распознавать эти атрибуты. Могут присутствовать в обновлениях (update), но их присутствие не обязательно.</li>
<li> <b>Optional transitive</b> — могут не распознаваться всеми реализациями BGP. Если маршрутизатор не распознал атрибут, он помечает обновление как частичное (partial) и отправляет его дальше соседям, сохраняя не распознанный атрибут.</li>
<li> <b>Optional non-transitive</b> — могут не распознаваться всеми реализациями BGP. Если маршрутизатор не распознал атрибут, то атрибут игнорируется и при передаче соседям отбрасывается.</li>
</ol><br/>
Примеры атрибутов BGP:<br/>
<br/>
<ul>
<li> <b>Well-known mandatory</b>:<br/>
<ul>
<li> Autonomous system path</li>
<li> Next-hop</li>
<li> Origin</li>
</ul><br/>
</li>
<li> <b>Well-known discretionary</b>:<br/>
<ul>
<li> Local preference</li>
<li> Atomic aggregate</li>
</ul></li>
<li> <b> Optional transitive</b>:<br/>
<ul>
<li> Aggregator</li>
<li> Communities</li>
</ul></li>
<li> <b> Optional non-transitive</b>:<br/>
<ul>
<li> Multi-exit discriminator (MED)</li>
<li> Originator ID</li>
<li> Cluster list</li>
</ul></li>
</ul><br/>
В данном случае нас пока будут интересовать Origin, Next-hop, AS Path. Так как маршрут передает между Router8 и Router9, то есть внутри одной AS, то он считается внутренним и обратим внимание на Origin.<br/>
<br/>
Атрибут Origin — указывает на то, каким образом был получен маршрут в обновлении. Возможные значения атрибута:<br/>
<br/>
<ul>
<li> 0 — IGP: NLRI получена внутри исходной автономной системы;</li>
<li> 1 — EGP: NLRI выучена по протоколу Exterior Gateway Protocol (EGP). Предшественник BGP, не используется</li>
<li> 2 — Incomplete: NLRI была выучена каким-то другим образом</li>
</ul><br/>
 В нашем случае, как видно из пакета равен 0. Когда данный маршрут будет передаваться к Router12, то данный код будет иметь код — 1.<br/>
<br/>
Далее, Next-hop. Атрибут Next-hop<br/>
<br/>
<ul>
<li> Это IP-адрес eBGP-маршрутизатора, через который идет путь к сети назначения.</li>
<li> Атрибут меняется при передаче префикса в другую AS.</li>
</ul><br/>
В случае же iBGP, то есть внутри одной AS, Next-hop будет указан тот, который узнал или рассказал об этом маршруте. В нашем случае, это будет 192.168.89.9. Но когда будет передавать данный маршрут от Router8 к Router6, Router8 его изменит и заменит на свой. Next-hop будет — 192.168.68.8. Это нас приводит к двум правилам:<br/>
<br/>
<ol>
<li> Если маршрутизатор передает маршрут своему внутреннему соседу, то он не меняет параметр Next-hop.</li>
<li> Если маршрутизатор передает маршрут своему внешнему соседу, то меняет Next-hop на ip интерфейса, с которого передает данный маршрутизатор.</li>
</ol><br/>
Это приводит нас к пониманию первой проблемы — Почему не будет маршрута в таблице маршрутизации на Router5 и Router11. Рассмотрим более детально. Итак, Router6 получил информацию о маршруте 9.9.9.0/24 и благополучно добавил ее в таблицу маршрутизации:<br/>
<br/>
<pre><code class="plaintext">Router6#show ip route bgp
Codes: L - local, C - connected, S - static, R - RIP, M - mobile, B - BGP
       D - EIGRP, EX - EIGRP external, O - OSPF, IA - OSPF inter area
       N1 - OSPF NSSA external type 1, N2 - OSPF NSSA external type 2
       E1 - OSPF external type 1, E2 - OSPF external type 2
       i - IS-IS, su - IS-IS summary, L1 - IS-IS level-1, L2 - IS-IS level-2
       ia - IS-IS inter area, * - candidate default, U - per-user static route
       o - ODR, P - periodic downloaded static route, H - NHRP, l - LISP
       a - application route
       + - replicated route, % - next hop override, p - overrides from PfR

Gateway of last resort is not set

      9.0.0.0/24 is subnetted, 1 subnets
B        9.9.9.0 [20/0] via 192.168.68.8, 00:38:25</code></pre><br/>
Теперь Router6 передал маршрут Router5 и первому правилу Next-hop не изменил. То есть, Router5 должен добавить <b>9.9.9.0 [20/0] via 192.168.68.8</b>, но у него нет маршрута до 192.168.68.8 и поэтому данный маршрут добавлен не будет, хотя информация о данном маршруте будет храниться в таблице BGP:<br/>
<br/>
<pre><code class="plaintext">&lt;b>Router5#show ip bgp
BGP table version is 1, local router ID is 5.5.5.5
Status codes: s suppressed, d damped, h history, * valid, > best, i - internal,
              r RIB-failure, S Stale, m multipath, b backup-path, f RT-Filter,
              x best-external, a additional-path, c RIB-compressed,
Origin codes: i - IGP, e - EGP, ? - incomplete
RPKI validation codes: V valid, I invalid, N Not found

     Network          Next Hop            Metric LocPrf Weight Path
 * i 9.9.9.0/24       192.168.68.8             0    100      0 45 i&lt;/b></code></pre><br/>
Та же самая ситуация произойдет и между Router11-Router12. Чтоб избежать такой ситуации необходимо настроить, чтоб Router6 или Router12, передавая маршрут своим внутренним соседям, подставляли в качестве Next-hop свой ip адрес. Делается при помощи команды:<br/>
<br/>
<pre><code class="plaintext">neighbor 192.168.56.5 next-hop-self</code></pre><br/>
После данной команды, Router6 отправит Update сообщение, где для маршрутов в качества Next-hop будет указан ip интерфейса Gi0/0 Router6 — 192.168.56.6, после чего данный маршрут уже попадет в таблицу маршрутизации. <br/>
<br/>
Пойдем дальше и посмотрим появиться ли этот маршрут на Router7 и Router10. В таблице маршрутизации его не окажется и мы могли бы подумать, что проблема как в первом с параметром Next-hop, но если мы посмотрим вывод команды show ip bgp, то увидим, что там маршрут не был получен даже с неправильным Next-hop, что означает, что маршрут даже не передавался. И это нас приведет к существованию еще одного правила:<br/>
<blockquote> Маршруты, полученные от внутренних соседей не передаются другим внутренним соседям. </blockquote> Так как, Router5 получил маршрут от Router6, то другому своему внутреннему соседу он передаваться не будет. Для того, чтобы передача произошла необходимо настроить функцию <a href="http://xgu.ru/wiki/BGP_route_reflector" rel="nofollow">Route Reflector</a>, либо настроить полносвязные отношения соседства ( Full Mesh), то есть Router5-7 каждый будет соседом с каждым. Мы будем в данном случае использовать Route Reflector. На Router5 необходимо использовать данную команду:<br/>
<br/>
<pre><code class="plaintext">neighbor 192.168.57.7 route-reflector-client</code></pre><br/>
Route-Reflector меняет поведение BGP при передаче маршрута внутреннему соседу. Если внутренний сосед указан как <b>route-reflector-client</b>, то данным клиентам будут анонсироваться внутренние маршруты.<br/>
<br/>
Маршрут не появился на Router7? Не забываем также и про Next-hop. После данных манипуляций маршрут должен и на Router7, но этого не происходит. Это нас подводит к еще одному правилу:<br/>
<blockquote>Правило next-hop работает только для External маршрутов. Для внутренних маршрутов замена атрибута next-hop не происходит.</blockquote><br/>
И мы получаем ситуацию, в которой необходимо создать среду при помощи статичной маршрутизации или протоколов IGP сообщить маршрутизаторам о всех маршрутах внутри AS. Пропишем статические маршруты на Router6 и Router7 и после этого получим нужный маршрут в таблице маршрутизаторе. В AS 678 же мы поступим немного иначе — пропишем статические маршруты для 192.168.112.0/24 на Router10 и 192.168.110.0/24 на Router12. Далее, установим отношения соседства между Router10 и Router12. Также настроим на Router12 отправку своего next-hop для Router10:<br/>
<br/>
<pre><code class="plaintext">neighbor 192.168.110.10 next-hop-self</code></pre><br/>
Итогом будет то, что Router10 будет получать маршрут 9.9.9.0/24, он будет получен и от Router7 и от Router12. Посмотрим какой выбор сделает Router10:<br/>
<br/>
<pre><code class="plaintext">Router10#show ip bgp
BGP table version is 3, local router ID is 6.6.6.6
Status codes: s suppressed, d damped, h history, * valid, > best, i - internal,
              r RIB-failure, S Stale, m multipath, b backup-path, f RT-Filter,
              x best-external, a additional-path, c RIB-compressed,
Origin codes: i - IGP, e - EGP, ? - incomplete
RPKI validation codes: V valid, I invalid, N Not found

     Network              Next Hop            Metric LocPrf Weight Path
 *>i 9.9.9.0/24       192.168.112.12           0    100       0      45 i

                               192.168.107.7                                0     123 45 i  </code></pre><br/>
Как мы видим, два маршрута и стрелка ( > ) означает, что выбран маршрут через 192.168.112.12. <br/>
Посмотрим как происходит процесс выбора маршрута:<br/>
<br/>
<ol>
<li> Первым делом при получении маршрута, проверяется доступность его Next-hop. Именно поэтому, когда мы получали маршрут на Router5 без настройки Next-hop-self, данный маршрут далее не отдавался на обработку.</li>
<li> Далее идет параметр Weight. Данный параметр не является Атрибутом пути ( PA ) и не передается в сообщениях BGP. Он настраивается локально на каждом маршрутизаторе и используется только для манипуляции выбора маршрута на самом маршрутизаторе. Рассмотрим пример. Чуть выше показано, что Router10 выбрал маршрут для 9.9.9.0/24 через Router12 ( 192.168.112.12 ). Чтоб изменить параметр Wieght, можно использовать route-map, чтоб задать для определенных маршрутов, либо присвоить его соседу вес при помощи команды:<br/>
<br/>
<pre><code class="plaintext"> neighbor 192.168.107.7 weight 200       </code></pre><br/>
Теперь все маршруты от данного соседа будут иметь такой вес. Посмотрим как изменится выбор маршрута после данной манипуляции:<br/>
<br/>
<pre><code class="plaintext">Router10#show bgp
*Mar  2 11:58:13.956: %SYS-5-CONFIG_I: Configured from console by console
BGP table version is 2, local router ID is 6.6.6.6
Status codes: s suppressed, d damped, h history, * valid, > best, i - internal,
              r RIB-failure, S Stale, m multipath, b backup-path, f RT-Filter,
              x best-external, a additional-path, c RIB-compressed,
Origin codes: i - IGP, e - EGP, ? - incomplete
RPKI validation codes: V valid, I invalid, N Not found

     Network          Next Hop            Metric LocPrf Weight      Path
 *>  9.9.9.0/24       192.168.107.7                        200      123 45 i
 * i                          192.168.112.12           0          100      0 45 i</code></pre><br/>
Как видите теперь выбран маршрут через Router7, но никакого эффекта на остальные маршрутизаторы это иметь не будет.</li>
<li> На третьей позиции у нас идет — Local Preference. Данный параметр является Well-known discretionary атрибутом, а это означает, что его присутствие необязательно. Данный параметр имеет силу только внутри одной AS и влияет на выбор пути только для внутренних соседей. Именно поэтому, он передается только в Update сообщениях предназначенных для внутреннего соседа. В Update сообщениях для внешних соседей он отсутствует. Поэтому он и был отнесен к Well-known discretionary. Попытаемся применить его на Router5. На Router5 у нас должно быть два маршрута для 9.9.9.0/24 — один через Router6 и второй через Router7.<br/>
<br/>
Смотрим:<br/>
<br/>
<pre><code class="plaintext">Router5#show bgp
BGP table version is 2, local router ID is 5.5.5.5
Status codes: s suppressed, d damped, h history, * valid, > best, i - internal,
              r RIB-failure, S Stale, m multipath, b backup-path, f RT-Filter,
              x best-external, a additional-path, c RIB-compressed,
Origin codes: i - IGP, e - EGP, ? - incomplete
RPKI validation codes: V valid, I invalid, N Not found

     Network          Next Hop            Metric LocPrf Weight Path
 *>i 9.9.9.0/24       192.168.56.6             0    100      0 45 i</code></pre><br/>
Но как видим один маршрут через Router6. А где же маршрут через Router7? Может и на Router7 его нет? Смотрим:<br/>
<br/>
<pre><code class="plaintext">Router#show bgp
BGP table version is 10, local router ID is 7.7.7.7
Status codes: s suppressed, d damped, h history, * valid, > best, i - internal,
              r RIB-failure, S Stale, m multipath, b backup-path, f RT-Filter,
              x best-external, a additional-path, c RIB-compressed,
Origin codes: i - IGP, e - EGP, ? - incomplete
RPKI validation codes: V valid, I invalid, N Not found

     Network                Next Hop            Metric LocPrf  Weight    Path
 *>i 9.9.9.0/24       192.168.56.6             0     100           0      45 i

                              192.168.107.10                                  0     678 45 i </code></pre><br/>
Странно, вроде все в порядке. Почему же он не передается на Router5? Все дело в том, что у BGP есть правило:<br/>
<blockquote>Маршрутизатор передает только те маршруты, которые использует сам.</blockquote><br/>
Router7 используется маршрут через Router5, поэтому маршрут через Router10 передаваться не будет. Вернемся к Local Preference. Давайте зададим Local Preference на Router7 и посмотрим как отреагирует на это Router5:<br/>
<br/>
<pre><code class="plaintext">route-map BGP permit 10
 match ip address 10
 set local-preference 250
access-list 10 permit any
router bgp 123
 neighbor 192.168.107.10 route-map BGP in&lt;/b></code></pre><br/>
Итак, мы создали route-map, в который попадаются все маршруты и сказали Router7, чтоб при получение он менял параметр Local Preference на 250, по умолчанию равен 100. Смотрим, что произошло на Router5:<br/>
<br/>
<pre><code class="plaintext">Router5#show bgp
BGP table version is 8, local router ID is 5.5.5.5
Status codes: s suppressed, d damped, h history, * valid, > best, i - internal,
              r RIB-failure, S Stale, m multipath, b backup-path, f RT-Filter,
              x best-external, a additional-path, c RIB-compressed,
Origin codes: i - IGP, e - EGP, ? - incomplete
RPKI validation codes: V valid, I invalid, N Not found

     Network          Next Hop            Metric LocPrf Weight        Path
 *>i 9.9.9.0/24       192.168.57.7             0          250      0 678 45 i</code></pre><br/>
Как мы видим теперь Router5 предпочитает маршрут через Router7. Такая же картина будет и на Router6, хотя ему выгодней выбрать маршрут через Router8. Добавим также, что изменения данного параметра требует рестарт соседства, чтобы изменение вошло в силу. Читать <a href="http://xgu.ru/wiki/BGP_%D0%B2_Cisco#.D0.9F.D1.80.D0.B8.D0.BC.D0.B5.D0.BD.D0.B5.D0.BD.D0.B8.D0.B5_.D0.B8.D0.B7.D0.BC.D0.B5.D0.BD.D0.B5.D0.BD.D0.B8.D0.B9_.D0.B2_.D0.BD.D0.B0.D1.81.D1.82.D1.80.D0.BE.D0.B9.D0.BA.D0.B0.D1.85_.D0.BF.D0.BE.D0.BB.D0.B8.D1.82.D0.B8.D0.BA_BGP" rel="nofollow">тут</a>. С Local Preference разобрались. Переходим к следующему параметру.</li>
<li> Предпочтение маршрута с параметром Next-hop 0.0.0.0, то есть локальные или агрегированные маршруты. Данным маршрутам автоматически после ввода команды network присуждается параметр Weight равный максимуму — 32678:<br/>
<br/>
<pre><code class="plaintext">Router#show bgp
BGP table version is 2, local router ID is 9.9.9.9
Status codes: s suppressed, d damped, h history, * valid, > best, i - internal,
              r RIB-failure, S Stale, m multipath, b backup-path, f RT-Filter,
              x best-external, a additional-path, c RIB-compressed,
Origin codes: i - IGP, e - EGP, ? - incomplete
RPKI validation codes: V valid, I invalid, N Not found

     Network          Next Hop            Metric LocPrf Weight    Path
 *>  9.9.9.0/24       0.0.0.0                  0            32768    i</code></pre></li>
<li> Кратчайший путь через AS. Выбирается самый короткий параметр AS_Path. Чем через меньшее количество количество AS проходит маршрут, тем он и лучше. Рассмотри маршрут к 9.9.9.0/24 на Router10:<br/>
<br/>
<pre><code class="plaintext">Router10#show bgp
BGP table version is 2, local router ID is 6.6.6.6
Status codes: s suppressed, d damped, h history, * valid, > best, i - internal,
              r RIB-failure, S Stale, m multipath, b backup-path, f RT-Filter,
              x best-external, a additional-path, c RIB-compressed,
Origin codes: i - IGP, e - EGP, ? - incomplete
RPKI validation codes: V valid, I invalid, N Not found

     Network          Next Hop            Metric LocPrf Weight Path
 *   9.9.9.0/24     192.168.107.7                           0           123 45 i
 *>i                     192.168.112.12           0    100       0       45 i</code></pre><br/>
Как видите, Router10 выбрал маршрут через 192.168.112.12 потому, что для данного маршрута параметр AS_Path содержит только 45, а в другом случае 123 и 45. Интуитивно понятно. </li>
<li>Следующий параметр — Origin. IGP ( маршрут получен при помощи BGP) лучше, чем EGP ( маршрут получен при помощи предшественника BGP, ныне не используется), а EGP лучше Incomplete? (получен каким-либо другим способ, например редистрибуцией).</li>
<li> Следующий параметр — MED. У нас был Wieght, который работал только локально на маршрутизаторе. Был Local Preference, который работал только в пределах одной автономной системе. Как нетрудно догадаться, MED — параметр, который будет передаваться между автономными системами. Очень хорошая <a href="http://xgu.ru/wiki/BGP_MED" rel="nofollow">статья</a> о данном параметре.</li>
</ol><br/>
Больше атрибутов использоваться не будет, но если у двух маршрутов они одинаковые, то используются следующие правила:<br/>
<br/>
<ol>
<li>Выбрать путь через ближайшего IGP-соседа.</li>
<li>Выбрать самый старый маршрут для eBGP-пути.</li>
<li>Выбрать путь через соседа с наименьшим BGP router ID.</li>
<li>Выбрать путь через соседа с наименьшим IP-адресом.</li>
</ol><br/>
<b>Теперь рассмотрим вопрос сходимости BGP. </b><br/>
<br/>
Посмотрим, что произойдет, если допустим Router6 потеряет маршрут 9.9.9.0/24 через Router9. Отключим интерфейс Gi0/1 Router6, который сразу поймет, что BGP сессия с Router8 оборвана и сосед пропал, а значит и маршрут, полученные от него не действительны. Router6 сразу отправляет Update сообщения, где указывает сеть 9.9.9.0/24 в поле Withdrawn Routes. Как только Router5 получит подобное сообщение, отправит его к Router7. Но так как у Router7 есть маршрут через Router10, то в ответ сразу отправит Update c новым маршрутом. Если детектировать падения соседа по состоянию интерфейса не получается, то придеться ждать срабатывания Hold Timer-а.<br/>
<br/>
<b>Конфедерация.</b><br/>
<br/>
Если помните, то мы говорили о том, что часто приходится использовать полносвязную топологию. С большим количеством маршрутизаторов в одной AS это может доставить большие проблемы, чтоб избежать этого необходимо использовать конфедерации. Одна AS разбивается на несколько sub-AS, что позволяет работать им без требования полносвязной топологии. <br/>
<br/>
<a href="https://i.imgur.com/ARoiylo.jpg" rel="nofollow"><img src="https://habrastorage.org/r/w780q1/getpro/habr/post_images/d55/6a8/741/d556a874120b70319381332cdddf739b.jpg" alt="My Image" data-src="https://habrastorage.org/getpro/habr/post_images/d55/6a8/741/d556a874120b70319381332cdddf739b.jpg" data-blurred="true"/></a><br/>
<br/>
Здесь ссылка на данную <a href="https://gns3vault.com/bgp/bgp-confederations" rel="nofollow">лабу</a>, а <a href="https://drive.google.com/file/d/1dxrFBK5tCKCJzHusQg_4KYcqCF-ZkKvQ/view?usp=sharing" rel="nofollow">тут </a>конфигурация для GNS3.<br/>
<br/>
Например, при такой топологии нам пришлось бы связывать все маршрутизаторы в AS 2345 между собой, но используя Confederation, мы можем установить отношения соседства только между маршрутизаторами непосредственно подключенных друг к другу. Поговорим об этом подробно. Если у нас была только AS 2345, то <b>laForge </b>получив маршур от <b>Picard </b>рассказал бы его маршрутизаторам <b>Data </b>и <b>Worf</b>, но они не рассказали бы о нем маршрутизатору <b>Crusher </b>. Также маршруты, которые распрастраняет сам маршрутизатор <b>laForge</b>, не были бы переданы <b>Crusher</b> ни <b>Worf</b>-ом, ни <b>Data</b>. <br/>
<br/>
Пришлось бы настраивать Route-Reflector или полносвязые отношения соседства. Разбивая одну AS 2345 на 4 sub-AS ( 2,3,4,5) для каждого маршрутизатора, мы в итоге получаем другую логику работы. Все отлично описано <a href="http://xgu.ru/wiki/BGP_confederation" rel="nofollow">здесь</a>.<br/>
<br/>
Источники:<br/>
<br/>
<ol>
<li>CCIE Routing and Switching v5.0 Official Cert Guide, Volume 2, Fifth Edition, Narbik Kocharians, Terry Vinson.</li>
<li>Сайт<a href="http://xgu.ru/wiki/%D0%97%D0%B0%D0%B3%D0%BB%D0%B0%D0%B2%D0%BD%D0%B0%D1%8F_%D1%81%D1%82%D1%80%D0%B0%D0%BD%D0%B8%D1%86%D0%B0" rel="nofollow"> xgu.ru</a></li>
<li>Сайт <a href="https://gns3vault.com/" rel="nofollow">GNS3Vault</a>. </li>
</ol></div></div> <!----> <!----></div> <div class="tm-article-presenter__meta"><div class="tm-separated-list tm-article-presenter__meta-list"><span class="tm-separated-list__title">Теги:</span> <ul class="tm-separated-list__list"><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bbgp%5D" class="tm-tags-list__link">bgp</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Brouting%5D" class="tm-tags-list__link">routing</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bnetwork%5D" class="tm-tags-list__link">network</a></li></ul></div> <div class="tm-separated-list tm-article-presenter__meta-list"><span class="tm-separated-list__title">Хабы:</span> <ul class="tm-separated-list__list"><li class="tm-separated-list__item"><a href="/ru/hub/cisconetworks/" class="tm-hubs-list__link">
    Cisco
  </a></li><li class="tm-separated-list__item"><a href="/ru/hub/network_technologies/" class="tm-hubs-list__link">
    Сетевые технологии
  </a></li></ul></div></div></article></div> <!----></div> <div class="tm-article-sticky-panel"><div class="tm-data-icons tm-article-sticky-panel__icons"><div class="tm-article-rating tm-data-icons__item"><div class="tm-votes-meter tm-article-rating__votes-switcher"><svg height="16" width="16" class="tm-svg-img tm-votes-meter__icon tm-votes-meter__icon_medium"><title>Всего голосов 21: ↑18 и ↓3</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#counter-rating"></use></svg> <span title="Всего голосов 21: ↑18 и ↓3" class="tm-votes-meter__value tm-votes-meter__value_positive tm-votes-meter__value_medium">+15</span></div> <DIV class="v-portal" style="display:none;"></DIV></div> <!----> <span title="Количество просмотров" class="tm-icon-counter tm-data-icons__item"><svg height="16" width="16" class="tm-svg-img tm-icon-counter__icon"><title>Просмотры</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#counter-views"></use></svg> <span class="tm-icon-counter__value">97K</span></span> <button title="Добавить в закладки" type="button" class="bookmarks-button tm-data-icons__item"><span title="Добавить в закладки" class="tm-svg-icon__wrapper bookmarks-button__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Добавить в закладки</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#counter-favorite"></use></svg></span> <span title="Количество пользователей, добавивших публикацию в закладки" class="bookmarks-button__counter">
    192
  </span></button> <!----> <div title="Поделиться" class="tm-sharing tm-data-icons__item"><button type="button" class="tm-sharing__button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="tm-sharing__icon"><path fill="currentColor" d="M10.33.275l9.047 7.572a.2.2 0 010 .306l-9.048 7.572a.2.2 0 01-.328-.153V11c-8 0-9.94 6-9.94 6S-1 5 10 5V.428a.2.2 0 01.328-.153z"></path></svg></button> <!----></div> <DIV class="v-portal" style="display:none;"></DIV></div> </div></div> <!----> <!----> <div class="tm-article-presenter__footer"><div class="tm-article-blocks"><!----> <section class="tm-block tm-block_spacing-bottom"><!----> <div class="tm-block__body tm-block__body_variant-balanced"><div class="tm-article-author"> <div class="tm-user-card tm-article-author__user-card tm-user-card_variant-article"><div class="tm-user-card__info-container"><div class="tm-user-card__header"><div class="tm-user-card__header-data"><a href="/ru/users/Ruslan_Mammadov/" class="tm-user-card__userpic tm-user-card__userpic_size-40"><div class="tm-entity-image"><img alt="" src="//habrastorage.org/getpro/habr/avatars/5f8/12c/fb5/5f812cfb51ea930aaaf44c03a752f162.jpg" class="tm-entity-image__pic"></div></a> <div class="tm-user-card__meta"><div title=" 28 голосов " class="tm-karma tm-user-card__karma"><div class="tm-karma__votes tm-karma__votes_positive">
    27
  </div> <div class="tm-karma__text">
    Карма
  </div></div> <div title="Рейтинг пользователя" class="tm-rating tm-user-card__rating"><div class="tm-rating__header"> <div class="tm-rating__counter">0</div></div> <div class="tm-rating__text">
    Рейтинг
  </div></div></div></div></div> <div class="tm-user-card__info tm-user-card__info_variant-article"><div class="tm-user-card__title tm-user-card__title_variant-article"><span class="tm-user-card__name tm-user-card__name_variant-article">Руслан Мамедов</span> <a href="/ru/users/Ruslan_Mammadov/" class="tm-user-card__nickname tm-user-card__nickname_variant-article">
          @Ruslan_Mammadov
        </a> <!----></div> <p class="tm-user-card__short-info tm-user-card__short-info_variant-article">Пользователь</p></div></div> <div class="tm-user-card__buttons tm-user-card__buttons_variant-article"><!----> <!----> <!----> <!----> <!----></div></div> <!----></div> <DIV class="v-portal" style="display:none;"></DIV></div> <!----></section> <div class="tm-article-blocks__comments"><div class="tm-article-page-comments"><div class="tm-article-comments-counter-link tm-article-comments-counter-button"><a href="/ru/post/450814/comments/" class="tm-article-comments-counter-link__link tm-article-comments-counter-link__link_button-style"><svg height="16" width="16" class="tm-svg-img tm-article-comments-counter-link__icon tm-article-comments-counter-link__icon_contrasted"><title>Комментарии</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#counter-comments"></use></svg> <span class="tm-article-comments-counter-link__value tm-article-comments-counter-link__value_contrasted">
       Комментарии 8 
    </span></a> <!----></div></div></div> <div class="tm-ad-banner__container tm-page-article__banner"><!----> <div id="articleBottomBanner" class="tm-ad-banner"></div></div> <!----> <!----> <!----> <!----> </div></div></div></div></div> <div class="tm-page__sidebar"><div class="tm-layout-sidebar"><div class="tm-layout-sidebar__ads tm-layout-sidebar__ads_initial"><div class="tm-ad-banner__container tm-layout-sidebar__banner"><!----> <div id="sidebarBanner" class="tm-ad-banner"></div></div></div> <div class="tm-sexy-sidebar tm-sexy-sidebar_initial" style="margin-top:0px;"><!----> <!----></div></div></div></div></div></div></main> <!----></div> <div class="tm-footer-menu"><div class="tm-page-width"><div class="tm-footer-menu__container"><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Ваш аккаунт
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="/kek/v1/auth/habrahabr/?back=/ru/post/450814/&amp;hl=ru" rel="nofollow" target="_self">
                Войти
              </a></li><li class="tm-footer-menu__list-item"><a href="/kek/v1/auth/habrahabr-register/?back=/ru/post/450814/&amp;hl=ru" rel="nofollow" target="_self">
                Регистрация
              </a></li></ul></div></div><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Разделы
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="/ru/" class="footer-menu__item-link router-link-active">
                Публикации
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/news/" class="footer-menu__item-link">
                Новости
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/hubs/" class="footer-menu__item-link">
                Хабы
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/companies/" class="footer-menu__item-link">
                Компании
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/users/" class="footer-menu__item-link">
                Авторы
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/sandbox/" class="footer-menu__item-link">
                Песочница
              </a></li></ul></div></div><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Информация
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="/ru/docs/help/" class="footer-menu__item-link">
                Устройство сайта
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/docs/authors/codex/" class="footer-menu__item-link">
                Для авторов
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/docs/companies/corpblogs/" class="footer-menu__item-link">
                Для компаний
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/docs/docs/transparency/" class="footer-menu__item-link">
                Документы
              </a></li><li class="tm-footer-menu__list-item"><a href="https://account.habr.com/info/agreement" target="_blank">
                Соглашение
              </a></li><li class="tm-footer-menu__list-item"><a href="https://account.habr.com/info/confidential/" target="_blank">
                Конфиденциальность
              </a></li></ul></div></div><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Услуги
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="https://docs.google.com/presentation/d/e/2PACX-1vQLwRfQmXibiUlWaRg-BAc38s7oM3lJiaPju7qmdJsp8ysIvZ_G-Npem0njJLMozE2bPHMpDqiI5hhy/pub?start=false&amp;loop=false&amp;delayms=60000&amp;slide=id.g91a03369cd_4_297" target="_blank">
                Реклама
              </a></li><li class="tm-footer-menu__list-item"><a href="https://habrastorage.org/storage/stuff/habr/service_price.pdf" target="_blank">
                Тарифы
              </a></li><li class="tm-footer-menu__list-item"><a href="https://docs.google.com/presentation/d/e/2PACX-1vQJJds8-Di7BQSP_guHxICN7woVYoN5NP_22ra-BIo4bqnTT9FR6fB-Ku2P0AoRpX0Ds-LRkDeAoD8F/pub?start=false&amp;loop=false&amp;delayms=60000" target="_blank">
                Контент
              </a></li><li class="tm-footer-menu__list-item"><a href="https://tmtm.timepad.ru/" target="_blank">
                Семинары
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/megaprojects/" class="footer-menu__item-link">
                Мегапроекты
              </a></li></ul></div></div></div></div></div> <div class="tm-footer"><div class="tm-page-width"><div class="tm-footer__container"><!----> <div class="tm-footer__social"><a href="https://www.facebook.com/habrahabr.ru" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Facebook</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-facebook"></use></svg></a><a href="https://twitter.com/habr_com" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Twitter</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-twitter"></use></svg></a><a href="https://vk.com/habr" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>VK</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-vkontakte"></use></svg></a><a href="https://telegram.me/habr_com" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Telegram</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-telegram"></use></svg></a><a href="https://www.youtube.com/channel/UCd_sTwKqVrweTt4oAKY5y4w" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Youtube</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-youtube"></use></svg></a><a href="https://zen.yandex.ru/habr" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Яндекс Дзен</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-zen"></use></svg></a></div> <DIV class="v-portal" style="display:none;"></DIV> <button class="tm-footer__link"><!---->
        Настройка языка
      </button> <a href="/ru/about" class="tm-footer__link">
        О сайте
      </a> <a href="/ru/feedback/" class="tm-footer__link">
        Техническая поддержка
      </a> <!----> <a href="/berserk-mode-nope" class="tm-footer__link">
        Вернуться на старую версию
      </a> <div class="tm-footer-copyright"><span class="tm-copyright"><span class="tm-copyright__years">© 2006–2021 </span> <span class="tm-copyright__name">«<a href="https://company.habr.com/" rel="noopener" target="_blank" class="tm-copyright__link">Habr</a>»</span></span></div></div></div></div> <!----> <!----></div> <div class="vue-portal-target"></div></div>
<script>window.__INITIAL_STATE__={"adblock":{"hasAcceptableAdsFilter":false,"hasAdblock":false},"articlesList":{"articlesList":{"450814":{"id":"450814","timePublished":"2019-05-08T06:35:50+00:00","isCorporative":false,"lang":"ru","titleHtml":"Принципы работы протокола BGP","leadData":{"textHtml":"Сегодня мы рассмотрим протокол BGP. Не будем долго говорить зачем он и почему он используется как единственный протокол. Довольно много информации есть на этот счет, например \u003Ca href=\"https:\u002F\u002Fhabrahabr.ru\u002Fpost\u002F184350\u002F\" rel=\"nofollow\"\u003Eтут\u003C\u002Fa\u003E. \u003Cbr\u003E\r\n\u003Cbr\u003E\r\nИтак, что такое BGP? BGP — это протокол динамической маршрутизации, являющийся единственным EGP( External Gateway Protocol) протоколом. Данный протокол используется для построения маршрутизации в интернете. Рассмотрим как строится соседство между двумя маршрутизаторами BGP.\u003Cbr\u003E\r\n\u003Cbr\u003E\r\n\u003Ca href=\"https:\u002F\u002Fi.imgur.com\u002Fqm2GlXn.jpg\" rel=\"nofollow\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fpost_images\u002F3fa\u002Fda6\u002Fdd3\u002F3fada6dd3c41923367af475da9b0ae10.jpg\" alt=\"My Image\"\u003E\u003C\u002Fa\u003E\u003Cbr\u003E\r\nРассмотрим соседство между Router1 и Router3. Настроим их при помощи следующих команд:","imageUrl":null,"buttonTextHtml":"Читать дальше &rarr;","image":null},"editorVersion":"1.0","postType":"article","postLabels":[],"author":{"scoreStats":{"score":27,"votesCount":28},"rating":0,"relatedData":null,"contacts":[],"authorContacts":[],"paymentDetails":{"paymentYandexMoney":null,"paymentPayPalMe":null,"paymentWebmoney":null},"id":"1788889","alias":"Ruslan_Mammadov","fullname":"Руслан Мамедов","avatarUrl":"\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Favatars\u002F5f8\u002F12c\u002Ffb5\u002F5f812cfb51ea930aaaf44c03a752f162.jpg","speciality":"Пользователь"},"statistics":{"commentsCount":8,"favoritesCount":192,"readingCount":96522,"score":15,"votesCount":21},"hubs":[{"relatedData":null,"id":"6900","alias":"cisconetworks","type":"collective","title":"Cisco","titleHtml":"Cisco","isProfiled":true},{"relatedData":null,"id":"17123","alias":"network_technologies","type":"collective","title":"Сетевые технологии","titleHtml":"Сетевые технологии","isProfiled":true}],"flows":[{"id":"6","alias":"admin","title":"Администрирование"}],"relatedData":null,"textHtml":"\u003Cdiv xmlns=\"http:\u002F\u002Fwww.w3.org\u002F1999\u002Fxhtml\"\u003EСегодня мы рассмотрим протокол BGP. Не будем долго говорить зачем он и почему он используется как единственный протокол. Довольно много информации есть на этот счет, например \u003Ca href=\"https:\u002F\u002Fhabrahabr.ru\u002Fpost\u002F184350\u002F\" rel=\"nofollow\"\u003Eтут\u003C\u002Fa\u003E. \u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nИтак, что такое BGP? BGP — это протокол динамической маршрутизации, являющийся единственным EGP( External Gateway Protocol) протоколом. Данный протокол используется для построения маршрутизации в интернете. Рассмотрим как строится соседство между двумя маршрутизаторами BGP.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ca href=\"https:\u002F\u002Fi.imgur.com\u002Fqm2GlXn.jpg\" rel=\"nofollow\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780q1\u002Fgetpro\u002Fhabr\u002Fpost_images\u002F3fa\u002Fda6\u002Fdd3\u002F3fada6dd3c41923367af475da9b0ae10.jpg\" alt=\"My Image\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fpost_images\u002F3fa\u002Fda6\u002Fdd3\u002F3fada6dd3c41923367af475da9b0ae10.jpg\" data-blurred=\"true\"\u002F\u003E\u003C\u002Fa\u003E\u003Cbr\u002F\u003E\r\nРассмотрим соседство между Router1 и Router3. Настроим их при помощи следующих команд: \u003Ca name=\"habracut\"\u003E\u003C\u002Fa\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"plaintext\"\u003Erouter bgp 10\n  network 192.168.12.0\n  network 192.168.13.0\n  neighbor 192.168.13.3 remote-as 10\n\nrouter bgp 10\n  network 192.168.13.0\n  network 192.168.24.0\n  neighbor 192.168.13.1 remote-as 10\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\nСоседство внутри одной автономной системы — AS 10. После ввода данных на маршрутизаторе, например на Router1, данный маршрутизатор пытается настроить отношения соседства с маршрутизатором Router3. Начальное состояние, когда ничего не происходит называется \u003Cb\u003EIdle\u003C\u002Fb\u003E. Как только будет настроен bgp на Router1, он начнет слушать TCP порт 179 — перейдет в состояние \u003Cb\u003EConnect\u003C\u002Fb\u003E, а когда пытается открыть сессию с Router3, то перейдет в состояние \u003Cb\u003EActive\u003C\u002Fb\u003E. \u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nПосле того, как сессия установится между Router1 и Router3, то происходит обмен Open сообщениями. Когда данное сообщение отправит Router1, то данное состояние будет называться \u003Cb\u003EOpen Sent\u003C\u002Fb\u003E. А когда получит Open сообщение от Router3, то перейдет в состояние \u003Cb\u003EOpen Confirm\u003C\u002Fb\u003E. Рассмотрим более подробно сообщение Open:\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ca href=\"https:\u002F\u002Fi.imgur.com\u002FiwXv3hW.jpg\" rel=\"nofollow\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780q1\u002Fgetpro\u002Fhabr\u002Fpost_images\u002Fd9d\u002F231\u002F607\u002Fd9d2316070de22049a24da6d86cecb2b.jpg\" alt=\"My Image\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fpost_images\u002Fd9d\u002F231\u002F607\u002Fd9d2316070de22049a24da6d86cecb2b.jpg\" data-blurred=\"true\"\u002F\u003E\u003C\u002Fa\u003E\u003Cbr\u002F\u003E\r\nВ данном сообщение передается информация о самом протоколе BGP, который использует маршрутизатор. Обмениваясь Open сообщениями, Router1 и Router3 сообщают друг другу информацию о своих настройках. Передаются следующие параметры:\u003Cbr\u002F\u003E\r\n\u003Cblockquote\u003E \u003Cul\u003E\r\n\u003Cli\u003E\u003Cb\u003EVersion\u003C\u002Fb\u003E: this includes the BGP version that the router is using. The current version of BGP is version 4 which is described in RFC 4271. Two BGP routers will try to negotiate a compatible version, when there is a mismatch then there will be no BGP session.\u003C\u002Fli\u003E\r\n\u003Cli\u003E \u003Cb\u003E My AS\u003C\u002Fb\u003E: this includes the AS number of the BGP router, the routers will have to agree on the AS number(s) and it also defines if they will be running iBGP or eBGP.\u003C\u002Fli\u003E\r\n\u003Cli\u003E \u003Cb\u003E Hold Time\u003C\u002Fb\u003E: if BGP doesn’t receive any keepalive or update messages from the other side for the duration of the hold time then it will declare the other side ‘dead’ and it will tear down the BGP session. By default the hold time is set to 180 seconds on Cisco IOS routers, the keepalive message is sent every 60 seconds. Both routers have to agree on the hold time or there won’t be a BGP session.\u003C\u002Fli\u003E\r\n\u003Cli\u003E \u003Cb\u003E BGP Identifier\u003C\u002Fb\u003E: this is the local BGP router ID which is elected just like OSPF does:\u003Cbr\u002F\u003E\r\n\u003Cul\u003E\r\n\u003Cli\u003E Use the router-ID that was configured manually with the bgp router-id command.\u003C\u002Fli\u003E\r\n\u003Cli\u003E Use the highest IP address on a loopback interface.\u003C\u002Fli\u003E\r\n\u003Cli\u003E Use the highest IP address on a physical interface.\u003C\u002Fli\u003E\r\n\u003C\u002Ful\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E \u003Cb\u003EOptional Parameters\u003C\u002Fb\u003E: here you will find some optional capabilities of the BGP router. This field has been added so that new features could be added to BGP without having to create a new version.Things you might find here are:\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cul\u003E\r\n\u003Cli\u003E support for MP-BGP (Multi Protocol BGP).\u003C\u002Fli\u003E\r\n\u003Cli\u003E support for Route Refresh.\u003C\u002Fli\u003E\r\n\u003Cli\u003E support for 4-octet AS numbers.\u003C\u002Fli\u003E\r\n\u003C\u002Ful\u003E\u003C\u002Fli\u003E\r\n\u003C\u002Ful\u003E\u003C\u002Fblockquote\u003E Для установления соседства необходимо выполнения следующих условий:\u003Cbr\u002F\u003E\r\n \u003Cbr\u002F\u003E\r\n\u003Cul\u003E\r\n\u003Cli\u003EНомер версии. Нынешняя версия 4.\u003C\u002Fli\u003E\r\n\u003Cli\u003E Номер AS должен совпадать с тем, что вы настроили \u003Cb\u003Eneighbor 192.168.13.3 remote-as 10\u003C\u002Fb\u003E.\u003C\u002Fli\u003E\r\n\u003Cli\u003E Router ID должен быть отличным от соседа. \u003C\u002Fli\u003E\r\n\u003C\u002Ful\u003E\u003Cbr\u002F\u003E\r\nЕсли какой-то из параметров не удовлетворяет этим условиям, то маршрутизатор отправит \u003Cb\u003ENotification \u003C\u002Fb\u003Eсообщение, где укажет ошибку. После отправки и получения Open сообщений, отношения соседства переходит в состояние \u003Cb\u003EESTABLISHED\u003C\u002Fb\u003E. После этого уже маршрутизаторы могут обмениваться информацией о маршрутах и делают это при помощи \u003Cb\u003EUpdate \u003C\u002Fb\u003Eсообщений. Вот такое Update сообщение отправляет Router1 к Router3:\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ca href=\"https:\u002F\u002Fi.imgur.com\u002F6pcJb93.jpg\" rel=\"nofollow\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780q1\u002Fgetpro\u002Fhabr\u002Fpost_images\u002F853\u002Ff42\u002F1f0\u002F853f421f0a69f407c5ae4eae3423240c.jpg\" alt=\"My Image\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fpost_images\u002F853\u002Ff42\u002F1f0\u002F853f421f0a69f407c5ae4eae3423240c.jpg\" data-blurred=\"true\"\u002F\u003E\u003C\u002Fa\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nЗдесь указывают сети, о которых сообщает Router1 и Path attributes, которые являются аналогом метрик. О Path attributes мы поговорим более подробно. Также внутри TCP сессии передаются Keepalive сообщения. Они передаются, по умолчанию, каждые 60 секунд. Это Keepalive Timer. Если в течении Hold Timer-а не будет получено Keepalive сообщение, то это будет означать потерю связи с соседом. По умолчанию, он равен — 180 секундам.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nПолезная табличка:\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ca href=\"https:\u002F\u002Fi.imgur.com\u002F6pcJb93.jpg\" rel=\"nofollow\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780q1\u002Fgetpro\u002Fhabr\u002Fpost_images\u002F853\u002Ff42\u002F1f0\u002F853f421f0a69f407c5ae4eae3423240c.jpg\" alt=\"My Image\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fpost_images\u002F853\u002Ff42\u002F1f0\u002F853f421f0a69f407c5ae4eae3423240c.jpg\" data-blurred=\"true\"\u002F\u003E\u003C\u002Fa\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nВроде бы разобрались как маршрутизаторы передают друг другу информацию, теперь попытаемся разобраться с логикой работы протокола BGP. \u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nЧтобы анонсировать какой-нибудь маршрут в таблицу BGP, как и в протоколах IGP, используется команда network, но логика работы отличается. Если в IGP, после указание маршрута в команде network, IGP смотрит — какие интерфейсы принадлежат данной подсети и включает их в свою таблицу, то команда network в BGP смотрит в таблицу маршрутизации и ищет \u003Cb\u003Eточное \u003C\u002Fb\u003Eсовпадение с маршрутом в команде network. При нахождении таких, данные маршруты попадут в таблицу BGP.\u003Cbr\u002F\u003E\r\n\u003Cblockquote\u003ELook for a route in the router’s current IP routing table that exactly matches the parameters of the network command; if the IP route exists, put the equivalent NLRI into the local BGP table.\u003C\u002Fblockquote\u003E Теперь поднимем BGP на всех оставшихся и посмотрим как происходит выбор маршрута внутри одной AS. После того, как BGP маршрутизатор получит маршруты от соседа, то начинается выбор оптимального маршрута. Здесь надо понять какого вида соседи могут быть — внутренние и внешние. Маршрутизатор по конфигурации понимает является ли сконфигурированный сосед внутренним или внешним. Если в команде:\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"plaintext\"\u003Eneighbor 192.168.13.3 remote-as 10 \u003C\u002Fcode\u003E\u003C\u002Fpre\u003E \u003Cbr\u002F\u003E\r\nв качестве параметра remote-as указан AS, который сконфигурирован на самом маршрутизаторе в команде router bgp 10. Маршруты, пришедшие из внутренней AS считаются внутренними, а маршруты из внешней соответственно внешними. И по отношению к каждому работает разная логика получения и отправки. Рассмотрим такую топологию:\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ca href=\"https:\u002F\u002Fi.imgur.com\u002FGkFjpUM.jpg\" rel=\"nofollow\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780q1\u002Fgetpro\u002Fhabr\u002Fpost_images\u002Fcea\u002F5f8\u002F2b0\u002Fcea5f82b050662b2632cab01f3de8e24.jpg\" alt=\"My Image\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fpost_images\u002Fcea\u002F5f8\u002F2b0\u002Fcea5f82b050662b2632cab01f3de8e24.jpg\" data-blurred=\"true\"\u002F\u003E\u003C\u002Fa\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nНа каждом маршрутизаторы настроен loopback интрефейс с ip: x.x.x.x 255.255.255.0 — где x номер маршрутизатора. На Router9 у нас есть loopback интерфейс с адресом — 9.9.9.9 255.255.255.0. Его мы будем анонсировать по BGP и посмотрим как он распространяется. Данный маршрут будет передан на Router8 и Router12. С Router8 данный маршрут попадет на Router6, но на Router5 в таблице маршрутизации его не будет. Также и на Router12 данный маршрут попадет в таблицу, но на Router11 его также не будет. Попытаемся разобраться с этим. Рассмотрим какие данные и параметры передается Router9 своим соседям, сообщая об этом маршруте. Пакет внизу будет отправлен с Router9 на Router8.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ca href=\"https:\u002F\u002Fi.imgur.com\u002FMCZqzIn.jpg\" rel=\"nofollow\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780q1\u002Fgetpro\u002Fhabr\u002Fpost_images\u002F5e7\u002F80b\u002Fca0\u002F5e780bca084e8f42dab14d03f62723b6.jpg\" alt=\"My Image\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fpost_images\u002F5e7\u002F80b\u002Fca0\u002F5e780bca084e8f42dab14d03f62723b6.jpg\" data-blurred=\"true\"\u002F\u003E\u003C\u002Fa\u003E\u003Cbr\u002F\u003E\r\nИнформация о маршруте состоит из аттрибутов пути (Path attributes). \u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nАтрибуты пути разделены на 4 категории:\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Col\u003E\r\n\u003Cli\u003E \u003Cb\u003E Well-known mandatory\u003C\u002Fb\u003E — все маршрутизаторы, работающие по протоколу BGP, должны распознавать эти атрибуты. Должны присутствовать во всех обновлениях (update).\u003C\u002Fli\u003E\r\n\u003Cli\u003E \u003Cb\u003E Well-known discretionary\u003C\u002Fb\u003E — все маршрутизаторы, работающие по протоколу BGP, должны распознавать эти атрибуты. Могут присутствовать в обновлениях (update), но их присутствие не обязательно.\u003C\u002Fli\u003E\r\n\u003Cli\u003E \u003Cb\u003EOptional transitive\u003C\u002Fb\u003E — могут не распознаваться всеми реализациями BGP. Если маршрутизатор не распознал атрибут, он помечает обновление как частичное (partial) и отправляет его дальше соседям, сохраняя не распознанный атрибут.\u003C\u002Fli\u003E\r\n\u003Cli\u003E \u003Cb\u003EOptional non-transitive\u003C\u002Fb\u003E — могут не распознаваться всеми реализациями BGP. Если маршрутизатор не распознал атрибут, то атрибут игнорируется и при передаче соседям отбрасывается.\u003C\u002Fli\u003E\r\n\u003C\u002Fol\u003E\u003Cbr\u002F\u003E\r\nПримеры атрибутов BGP:\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cul\u003E\r\n\u003Cli\u003E \u003Cb\u003EWell-known mandatory\u003C\u002Fb\u003E:\u003Cbr\u002F\u003E\r\n\u003Cul\u003E\r\n\u003Cli\u003E Autonomous system path\u003C\u002Fli\u003E\r\n\u003Cli\u003E Next-hop\u003C\u002Fli\u003E\r\n\u003Cli\u003E Origin\u003C\u002Fli\u003E\r\n\u003C\u002Ful\u003E\u003Cbr\u002F\u003E\r\n\u003C\u002Fli\u003E\r\n\u003Cli\u003E \u003Cb\u003EWell-known discretionary\u003C\u002Fb\u003E:\u003Cbr\u002F\u003E\r\n\u003Cul\u003E\r\n\u003Cli\u003E Local preference\u003C\u002Fli\u003E\r\n\u003Cli\u003E Atomic aggregate\u003C\u002Fli\u003E\r\n\u003C\u002Ful\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E \u003Cb\u003E Optional transitive\u003C\u002Fb\u003E:\u003Cbr\u002F\u003E\r\n\u003Cul\u003E\r\n\u003Cli\u003E Aggregator\u003C\u002Fli\u003E\r\n\u003Cli\u003E Communities\u003C\u002Fli\u003E\r\n\u003C\u002Ful\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E \u003Cb\u003E Optional non-transitive\u003C\u002Fb\u003E:\u003Cbr\u002F\u003E\r\n\u003Cul\u003E\r\n\u003Cli\u003E Multi-exit discriminator (MED)\u003C\u002Fli\u003E\r\n\u003Cli\u003E Originator ID\u003C\u002Fli\u003E\r\n\u003Cli\u003E Cluster list\u003C\u002Fli\u003E\r\n\u003C\u002Ful\u003E\u003C\u002Fli\u003E\r\n\u003C\u002Ful\u003E\u003Cbr\u002F\u003E\r\nВ данном случае нас пока будут интересовать Origin, Next-hop, AS Path. Так как маршрут передает между Router8 и Router9, то есть внутри одной AS, то он считается внутренним и обратим внимание на Origin.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nАтрибут Origin — указывает на то, каким образом был получен маршрут в обновлении. Возможные значения атрибута:\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cul\u003E\r\n\u003Cli\u003E 0 — IGP: NLRI получена внутри исходной автономной системы;\u003C\u002Fli\u003E\r\n\u003Cli\u003E 1 — EGP: NLRI выучена по протоколу Exterior Gateway Protocol (EGP). Предшественник BGP, не используется\u003C\u002Fli\u003E\r\n\u003Cli\u003E 2 — Incomplete: NLRI была выучена каким-то другим образом\u003C\u002Fli\u003E\r\n\u003C\u002Ful\u003E\u003Cbr\u002F\u003E\r\n В нашем случае, как видно из пакета равен 0. Когда данный маршрут будет передаваться к Router12, то данный код будет иметь код — 1.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nДалее, Next-hop. Атрибут Next-hop\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cul\u003E\r\n\u003Cli\u003E Это IP-адрес eBGP-маршрутизатора, через который идет путь к сети назначения.\u003C\u002Fli\u003E\r\n\u003Cli\u003E Атрибут меняется при передаче префикса в другую AS.\u003C\u002Fli\u003E\r\n\u003C\u002Ful\u003E\u003Cbr\u002F\u003E\r\nВ случае же iBGP, то есть внутри одной AS, Next-hop будет указан тот, который узнал или рассказал об этом маршруте. В нашем случае, это будет 192.168.89.9. Но когда будет передавать данный маршрут от Router8 к Router6, Router8 его изменит и заменит на свой. Next-hop будет — 192.168.68.8. Это нас приводит к двум правилам:\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Col\u003E\r\n\u003Cli\u003E Если маршрутизатор передает маршрут своему внутреннему соседу, то он не меняет параметр Next-hop.\u003C\u002Fli\u003E\r\n\u003Cli\u003E Если маршрутизатор передает маршрут своему внешнему соседу, то меняет Next-hop на ip интерфейса, с которого передает данный маршрутизатор.\u003C\u002Fli\u003E\r\n\u003C\u002Fol\u003E\u003Cbr\u002F\u003E\r\nЭто приводит нас к пониманию первой проблемы — Почему не будет маршрута в таблице маршрутизации на Router5 и Router11. Рассмотрим более детально. Итак, Router6 получил информацию о маршруте 9.9.9.0\u002F24 и благополучно добавил ее в таблицу маршрутизации:\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"plaintext\"\u003ERouter6#show ip route bgp\nCodes: L - local, C - connected, S - static, R - RIP, M - mobile, B - BGP\n       D - EIGRP, EX - EIGRP external, O - OSPF, IA - OSPF inter area\n       N1 - OSPF NSSA external type 1, N2 - OSPF NSSA external type 2\n       E1 - OSPF external type 1, E2 - OSPF external type 2\n       i - IS-IS, su - IS-IS summary, L1 - IS-IS level-1, L2 - IS-IS level-2\n       ia - IS-IS inter area, * - candidate default, U - per-user static route\n       o - ODR, P - periodic downloaded static route, H - NHRP, l - LISP\n       a - application route\n       + - replicated route, % - next hop override, p - overrides from PfR\n\nGateway of last resort is not set\n\n      9.0.0.0\u002F24 is subnetted, 1 subnets\nB        9.9.9.0 [20\u002F0] via 192.168.68.8, 00:38:25\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\nТеперь Router6 передал маршрут Router5 и первому правилу Next-hop не изменил. То есть, Router5 должен добавить \u003Cb\u003E9.9.9.0 [20\u002F0] via 192.168.68.8\u003C\u002Fb\u003E, но у него нет маршрута до 192.168.68.8 и поэтому данный маршрут добавлен не будет, хотя информация о данном маршруте будет храниться в таблице BGP:\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"plaintext\"\u003E&lt;b\u003ERouter5#show ip bgp\nBGP table version is 1, local router ID is 5.5.5.5\nStatus codes: s suppressed, d damped, h history, * valid, \u003E best, i - internal,\n              r RIB-failure, S Stale, m multipath, b backup-path, f RT-Filter,\n              x best-external, a additional-path, c RIB-compressed,\nOrigin codes: i - IGP, e - EGP, ? - incomplete\nRPKI validation codes: V valid, I invalid, N Not found\n\n     Network          Next Hop            Metric LocPrf Weight Path\n * i 9.9.9.0\u002F24       192.168.68.8             0    100      0 45 i&lt;\u002Fb\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\nТа же самая ситуация произойдет и между Router11-Router12. Чтоб избежать такой ситуации необходимо настроить, чтоб Router6 или Router12, передавая маршрут своим внутренним соседям, подставляли в качестве Next-hop свой ip адрес. Делается при помощи команды:\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"plaintext\"\u003Eneighbor 192.168.56.5 next-hop-self\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\nПосле данной команды, Router6 отправит Update сообщение, где для маршрутов в качества Next-hop будет указан ip интерфейса Gi0\u002F0 Router6 — 192.168.56.6, после чего данный маршрут уже попадет в таблицу маршрутизации. \u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nПойдем дальше и посмотрим появиться ли этот маршрут на Router7 и Router10. В таблице маршрутизации его не окажется и мы могли бы подумать, что проблема как в первом с параметром Next-hop, но если мы посмотрим вывод команды show ip bgp, то увидим, что там маршрут не был получен даже с неправильным Next-hop, что означает, что маршрут даже не передавался. И это нас приведет к существованию еще одного правила:\u003Cbr\u002F\u003E\r\n\u003Cblockquote\u003E Маршруты, полученные от внутренних соседей не передаются другим внутренним соседям. \u003C\u002Fblockquote\u003E Так как, Router5 получил маршрут от Router6, то другому своему внутреннему соседу он передаваться не будет. Для того, чтобы передача произошла необходимо настроить функцию \u003Ca href=\"http:\u002F\u002Fxgu.ru\u002Fwiki\u002FBGP_route_reflector\" rel=\"nofollow\"\u003ERoute Reflector\u003C\u002Fa\u003E, либо настроить полносвязные отношения соседства ( Full Mesh), то есть Router5-7 каждый будет соседом с каждым. Мы будем в данном случае использовать Route Reflector. На Router5 необходимо использовать данную команду:\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"plaintext\"\u003Eneighbor 192.168.57.7 route-reflector-client\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\nRoute-Reflector меняет поведение BGP при передаче маршрута внутреннему соседу. Если внутренний сосед указан как \u003Cb\u003Eroute-reflector-client\u003C\u002Fb\u003E, то данным клиентам будут анонсироваться внутренние маршруты.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nМаршрут не появился на Router7? Не забываем также и про Next-hop. После данных манипуляций маршрут должен и на Router7, но этого не происходит. Это нас подводит к еще одному правилу:\u003Cbr\u002F\u003E\r\n\u003Cblockquote\u003EПравило next-hop работает только для External маршрутов. Для внутренних маршрутов замена атрибута next-hop не происходит.\u003C\u002Fblockquote\u003E\u003Cbr\u002F\u003E\r\nИ мы получаем ситуацию, в которой необходимо создать среду при помощи статичной маршрутизации или протоколов IGP сообщить маршрутизаторам о всех маршрутах внутри AS. Пропишем статические маршруты на Router6 и Router7 и после этого получим нужный маршрут в таблице маршрутизаторе. В AS 678 же мы поступим немного иначе — пропишем статические маршруты для 192.168.112.0\u002F24 на Router10 и 192.168.110.0\u002F24 на Router12. Далее, установим отношения соседства между Router10 и Router12. Также настроим на Router12 отправку своего next-hop для Router10:\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"plaintext\"\u003Eneighbor 192.168.110.10 next-hop-self\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\nИтогом будет то, что Router10 будет получать маршрут 9.9.9.0\u002F24, он будет получен и от Router7 и от Router12. Посмотрим какой выбор сделает Router10:\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"plaintext\"\u003ERouter10#show ip bgp\nBGP table version is 3, local router ID is 6.6.6.6\nStatus codes: s suppressed, d damped, h history, * valid, \u003E best, i - internal,\n              r RIB-failure, S Stale, m multipath, b backup-path, f RT-Filter,\n              x best-external, a additional-path, c RIB-compressed,\nOrigin codes: i - IGP, e - EGP, ? - incomplete\nRPKI validation codes: V valid, I invalid, N Not found\n\n     Network              Next Hop            Metric LocPrf Weight Path\n *\u003Ei 9.9.9.0\u002F24       192.168.112.12           0    100       0      45 i\n\n                               192.168.107.7                                0     123 45 i  \u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\nКак мы видим, два маршрута и стрелка ( \u003E ) означает, что выбран маршрут через 192.168.112.12. \u003Cbr\u002F\u003E\r\nПосмотрим как происходит процесс выбора маршрута:\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Col\u003E\r\n\u003Cli\u003E Первым делом при получении маршрута, проверяется доступность его Next-hop. Именно поэтому, когда мы получали маршрут на Router5 без настройки Next-hop-self, данный маршрут далее не отдавался на обработку.\u003C\u002Fli\u003E\r\n\u003Cli\u003E Далее идет параметр Weight. Данный параметр не является Атрибутом пути ( PA ) и не передается в сообщениях BGP. Он настраивается локально на каждом маршрутизаторе и используется только для манипуляции выбора маршрута на самом маршрутизаторе. Рассмотрим пример. Чуть выше показано, что Router10 выбрал маршрут для 9.9.9.0\u002F24 через Router12 ( 192.168.112.12 ). Чтоб изменить параметр Wieght, можно использовать route-map, чтоб задать для определенных маршрутов, либо присвоить его соседу вес при помощи команды:\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"plaintext\"\u003E neighbor 192.168.107.7 weight 200       \u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\nТеперь все маршруты от данного соседа будут иметь такой вес. Посмотрим как изменится выбор маршрута после данной манипуляции:\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"plaintext\"\u003ERouter10#show bgp\n*Mar  2 11:58:13.956: %SYS-5-CONFIG_I: Configured from console by console\nBGP table version is 2, local router ID is 6.6.6.6\nStatus codes: s suppressed, d damped, h history, * valid, \u003E best, i - internal,\n              r RIB-failure, S Stale, m multipath, b backup-path, f RT-Filter,\n              x best-external, a additional-path, c RIB-compressed,\nOrigin codes: i - IGP, e - EGP, ? - incomplete\nRPKI validation codes: V valid, I invalid, N Not found\n\n     Network          Next Hop            Metric LocPrf Weight      Path\n *\u003E  9.9.9.0\u002F24       192.168.107.7                        200      123 45 i\n * i                          192.168.112.12           0          100      0 45 i\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\nКак видите теперь выбран маршрут через Router7, но никакого эффекта на остальные маршрутизаторы это иметь не будет.\u003C\u002Fli\u003E\r\n\u003Cli\u003E На третьей позиции у нас идет — Local Preference. Данный параметр является Well-known discretionary атрибутом, а это означает, что его присутствие необязательно. Данный параметр имеет силу только внутри одной AS и влияет на выбор пути только для внутренних соседей. Именно поэтому, он передается только в Update сообщениях предназначенных для внутреннего соседа. В Update сообщениях для внешних соседей он отсутствует. Поэтому он и был отнесен к Well-known discretionary. Попытаемся применить его на Router5. На Router5 у нас должно быть два маршрута для 9.9.9.0\u002F24 — один через Router6 и второй через Router7.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nСмотрим:\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"plaintext\"\u003ERouter5#show bgp\nBGP table version is 2, local router ID is 5.5.5.5\nStatus codes: s suppressed, d damped, h history, * valid, \u003E best, i - internal,\n              r RIB-failure, S Stale, m multipath, b backup-path, f RT-Filter,\n              x best-external, a additional-path, c RIB-compressed,\nOrigin codes: i - IGP, e - EGP, ? - incomplete\nRPKI validation codes: V valid, I invalid, N Not found\n\n     Network          Next Hop            Metric LocPrf Weight Path\n *\u003Ei 9.9.9.0\u002F24       192.168.56.6             0    100      0 45 i\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\nНо как видим один маршрут через Router6. А где же маршрут через Router7? Может и на Router7 его нет? Смотрим:\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"plaintext\"\u003ERouter#show bgp\nBGP table version is 10, local router ID is 7.7.7.7\nStatus codes: s suppressed, d damped, h history, * valid, \u003E best, i - internal,\n              r RIB-failure, S Stale, m multipath, b backup-path, f RT-Filter,\n              x best-external, a additional-path, c RIB-compressed,\nOrigin codes: i - IGP, e - EGP, ? - incomplete\nRPKI validation codes: V valid, I invalid, N Not found\n\n     Network                Next Hop            Metric LocPrf  Weight    Path\n *\u003Ei 9.9.9.0\u002F24       192.168.56.6             0     100           0      45 i\n\n                              192.168.107.10                                  0     678 45 i \u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\nСтранно, вроде все в порядке. Почему же он не передается на Router5? Все дело в том, что у BGP есть правило:\u003Cbr\u002F\u003E\r\n\u003Cblockquote\u003EМаршрутизатор передает только те маршруты, которые использует сам.\u003C\u002Fblockquote\u003E\u003Cbr\u002F\u003E\r\nRouter7 используется маршрут через Router5, поэтому маршрут через Router10 передаваться не будет. Вернемся к Local Preference. Давайте зададим Local Preference на Router7 и посмотрим как отреагирует на это Router5:\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"plaintext\"\u003Eroute-map BGP permit 10\n match ip address 10\n set local-preference 250\naccess-list 10 permit any\nrouter bgp 123\n neighbor 192.168.107.10 route-map BGP in&lt;\u002Fb\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\nИтак, мы создали route-map, в который попадаются все маршруты и сказали Router7, чтоб при получение он менял параметр Local Preference на 250, по умолчанию равен 100. Смотрим, что произошло на Router5:\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"plaintext\"\u003ERouter5#show bgp\nBGP table version is 8, local router ID is 5.5.5.5\nStatus codes: s suppressed, d damped, h history, * valid, \u003E best, i - internal,\n              r RIB-failure, S Stale, m multipath, b backup-path, f RT-Filter,\n              x best-external, a additional-path, c RIB-compressed,\nOrigin codes: i - IGP, e - EGP, ? - incomplete\nRPKI validation codes: V valid, I invalid, N Not found\n\n     Network          Next Hop            Metric LocPrf Weight        Path\n *\u003Ei 9.9.9.0\u002F24       192.168.57.7             0          250      0 678 45 i\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\nКак мы видим теперь Router5 предпочитает маршрут через Router7. Такая же картина будет и на Router6, хотя ему выгодней выбрать маршрут через Router8. Добавим также, что изменения данного параметра требует рестарт соседства, чтобы изменение вошло в силу. Читать \u003Ca href=\"http:\u002F\u002Fxgu.ru\u002Fwiki\u002FBGP_%D0%B2_Cisco#.D0.9F.D1.80.D0.B8.D0.BC.D0.B5.D0.BD.D0.B5.D0.BD.D0.B8.D0.B5_.D0.B8.D0.B7.D0.BC.D0.B5.D0.BD.D0.B5.D0.BD.D0.B8.D0.B9_.D0.B2_.D0.BD.D0.B0.D1.81.D1.82.D1.80.D0.BE.D0.B9.D0.BA.D0.B0.D1.85_.D0.BF.D0.BE.D0.BB.D0.B8.D1.82.D0.B8.D0.BA_BGP\" rel=\"nofollow\"\u003Eтут\u003C\u002Fa\u003E. С Local Preference разобрались. Переходим к следующему параметру.\u003C\u002Fli\u003E\r\n\u003Cli\u003E Предпочтение маршрута с параметром Next-hop 0.0.0.0, то есть локальные или агрегированные маршруты. Данным маршрутам автоматически после ввода команды network присуждается параметр Weight равный максимуму — 32678:\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"plaintext\"\u003ERouter#show bgp\nBGP table version is 2, local router ID is 9.9.9.9\nStatus codes: s suppressed, d damped, h history, * valid, \u003E best, i - internal,\n              r RIB-failure, S Stale, m multipath, b backup-path, f RT-Filter,\n              x best-external, a additional-path, c RIB-compressed,\nOrigin codes: i - IGP, e - EGP, ? - incomplete\nRPKI validation codes: V valid, I invalid, N Not found\n\n     Network          Next Hop            Metric LocPrf Weight    Path\n *\u003E  9.9.9.0\u002F24       0.0.0.0                  0            32768    i\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E Кратчайший путь через AS. Выбирается самый короткий параметр AS_Path. Чем через меньшее количество количество AS проходит маршрут, тем он и лучше. Рассмотри маршрут к 9.9.9.0\u002F24 на Router10:\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"plaintext\"\u003ERouter10#show bgp\nBGP table version is 2, local router ID is 6.6.6.6\nStatus codes: s suppressed, d damped, h history, * valid, \u003E best, i - internal,\n              r RIB-failure, S Stale, m multipath, b backup-path, f RT-Filter,\n              x best-external, a additional-path, c RIB-compressed,\nOrigin codes: i - IGP, e - EGP, ? - incomplete\nRPKI validation codes: V valid, I invalid, N Not found\n\n     Network          Next Hop            Metric LocPrf Weight Path\n *   9.9.9.0\u002F24     192.168.107.7                           0           123 45 i\n *\u003Ei                     192.168.112.12           0    100       0       45 i\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\nКак видите, Router10 выбрал маршрут через 192.168.112.12 потому, что для данного маршрута параметр AS_Path содержит только 45, а в другом случае 123 и 45. Интуитивно понятно. \u003C\u002Fli\u003E\r\n\u003Cli\u003EСледующий параметр — Origin. IGP ( маршрут получен при помощи BGP) лучше, чем EGP ( маршрут получен при помощи предшественника BGP, ныне не используется), а EGP лучше Incomplete? (получен каким-либо другим способ, например редистрибуцией).\u003C\u002Fli\u003E\r\n\u003Cli\u003E Следующий параметр — MED. У нас был Wieght, который работал только локально на маршрутизаторе. Был Local Preference, который работал только в пределах одной автономной системе. Как нетрудно догадаться, MED — параметр, который будет передаваться между автономными системами. Очень хорошая \u003Ca href=\"http:\u002F\u002Fxgu.ru\u002Fwiki\u002FBGP_MED\" rel=\"nofollow\"\u003Eстатья\u003C\u002Fa\u003E о данном параметре.\u003C\u002Fli\u003E\r\n\u003C\u002Fol\u003E\u003Cbr\u002F\u003E\r\nБольше атрибутов использоваться не будет, но если у двух маршрутов они одинаковые, то используются следующие правила:\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Col\u003E\r\n\u003Cli\u003EВыбрать путь через ближайшего IGP-соседа.\u003C\u002Fli\u003E\r\n\u003Cli\u003EВыбрать самый старый маршрут для eBGP-пути.\u003C\u002Fli\u003E\r\n\u003Cli\u003EВыбрать путь через соседа с наименьшим BGP router ID.\u003C\u002Fli\u003E\r\n\u003Cli\u003EВыбрать путь через соседа с наименьшим IP-адресом.\u003C\u002Fli\u003E\r\n\u003C\u002Fol\u003E\u003Cbr\u002F\u003E\r\n\u003Cb\u003EТеперь рассмотрим вопрос сходимости BGP. \u003C\u002Fb\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nПосмотрим, что произойдет, если допустим Router6 потеряет маршрут 9.9.9.0\u002F24 через Router9. Отключим интерфейс Gi0\u002F1 Router6, который сразу поймет, что BGP сессия с Router8 оборвана и сосед пропал, а значит и маршрут, полученные от него не действительны. Router6 сразу отправляет Update сообщения, где указывает сеть 9.9.9.0\u002F24 в поле Withdrawn Routes. Как только Router5 получит подобное сообщение, отправит его к Router7. Но так как у Router7 есть маршрут через Router10, то в ответ сразу отправит Update c новым маршрутом. Если детектировать падения соседа по состоянию интерфейса не получается, то придеться ждать срабатывания Hold Timer-а.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cb\u003EКонфедерация.\u003C\u002Fb\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nЕсли помните, то мы говорили о том, что часто приходится использовать полносвязную топологию. С большим количеством маршрутизаторов в одной AS это может доставить большие проблемы, чтоб избежать этого необходимо использовать конфедерации. Одна AS разбивается на несколько sub-AS, что позволяет работать им без требования полносвязной топологии. \u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ca href=\"https:\u002F\u002Fi.imgur.com\u002FARoiylo.jpg\" rel=\"nofollow\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780q1\u002Fgetpro\u002Fhabr\u002Fpost_images\u002Fd55\u002F6a8\u002F741\u002Fd556a874120b70319381332cdddf739b.jpg\" alt=\"My Image\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fpost_images\u002Fd55\u002F6a8\u002F741\u002Fd556a874120b70319381332cdddf739b.jpg\" data-blurred=\"true\"\u002F\u003E\u003C\u002Fa\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nЗдесь ссылка на данную \u003Ca href=\"https:\u002F\u002Fgns3vault.com\u002Fbgp\u002Fbgp-confederations\" rel=\"nofollow\"\u003Eлабу\u003C\u002Fa\u003E, а \u003Ca href=\"https:\u002F\u002Fdrive.google.com\u002Ffile\u002Fd\u002F1dxrFBK5tCKCJzHusQg_4KYcqCF-ZkKvQ\u002Fview?usp=sharing\" rel=\"nofollow\"\u003Eтут \u003C\u002Fa\u003Eконфигурация для GNS3.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nНапример, при такой топологии нам пришлось бы связывать все маршрутизаторы в AS 2345 между собой, но используя Confederation, мы можем установить отношения соседства только между маршрутизаторами непосредственно подключенных друг к другу. Поговорим об этом подробно. Если у нас была только AS 2345, то \u003Cb\u003ElaForge \u003C\u002Fb\u003Eполучив маршур от \u003Cb\u003EPicard \u003C\u002Fb\u003Eрассказал бы его маршрутизаторам \u003Cb\u003EData \u003C\u002Fb\u003Eи \u003Cb\u003EWorf\u003C\u002Fb\u003E, но они не рассказали бы о нем маршрутизатору \u003Cb\u003ECrusher \u003C\u002Fb\u003E. Также маршруты, которые распрастраняет сам маршрутизатор \u003Cb\u003ElaForge\u003C\u002Fb\u003E, не были бы переданы \u003Cb\u003ECrusher\u003C\u002Fb\u003E ни \u003Cb\u003EWorf\u003C\u002Fb\u003E-ом, ни \u003Cb\u003EData\u003C\u002Fb\u003E. \u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nПришлось бы настраивать Route-Reflector или полносвязые отношения соседства. Разбивая одну AS 2345 на 4 sub-AS ( 2,3,4,5) для каждого маршрутизатора, мы в итоге получаем другую логику работы. Все отлично описано \u003Ca href=\"http:\u002F\u002Fxgu.ru\u002Fwiki\u002FBGP_confederation\" rel=\"nofollow\"\u003Eздесь\u003C\u002Fa\u003E.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nИсточники:\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Col\u003E\r\n\u003Cli\u003ECCIE Routing and Switching v5.0 Official Cert Guide, Volume 2, Fifth Edition, Narbik Kocharians, Terry Vinson.\u003C\u002Fli\u003E\r\n\u003Cli\u003EСайт\u003Ca href=\"http:\u002F\u002Fxgu.ru\u002Fwiki\u002F%D0%97%D0%B0%D0%B3%D0%BB%D0%B0%D0%B2%D0%BD%D0%B0%D1%8F_%D1%81%D1%82%D1%80%D0%B0%D0%BD%D0%B8%D1%86%D0%B0\" rel=\"nofollow\"\u003E xgu.ru\u003C\u002Fa\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003EСайт \u003Ca href=\"https:\u002F\u002Fgns3vault.com\u002F\" rel=\"nofollow\"\u003EGNS3Vault\u003C\u002Fa\u003E. \u003C\u002Fli\u003E\r\n\u003C\u002Fol\u003E\u003C\u002Fdiv\u003E","tags":[{"titleHtml":"bgp"},{"titleHtml":"routing"},{"titleHtml":"network"}],"metadata":{"stylesUrls":[],"scriptUrls":[],"shareImageUrl":"https:\u002F\u002Fhabr.com\u002Fshare\u002Fpublication\u002F450814\u002Ff464f1584538946e24ce1d53b2693aba\u002F","shareImageWidth":1200,"shareImageHeight":630,"vkShareImageUrl":"https:\u002F\u002Fhabr.com\u002Fshare\u002Fpublication\u002F450814\u002Ff464f1584538946e24ce1d53b2693aba\u002F?format=vk","schemaJsonLd":"{\"@context\":\"http:\\\u002F\\\u002Fschema.org\",\"@type\":\"Article\",\"mainEntityOfPage\":{\"@type\":\"WebPage\",\"@id\":\"https:\\\u002F\\\u002Fhabr.com\\\u002Fru\\\u002Fpost\\\u002F450814\\\u002F\"},\"headline\":\"Принципы работы протокола BGP\",\"datePublished\":\"2019-05-08T09:35:50+03:00\",\"dateModified\":\"2020-08-08T15:09:16+03:00\",\"author\":{\"@type\":\"Person\",\"name\":\"Руслан Мамедов\"},\"publisher\":{\"@type\":\"Organization\",\"name\":\"Habr\",\"logo\":{\"@type\":\"ImageObject\",\"url\":\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fa_\\\u002Flk\\\u002F9m\\\u002Fa_lk9mjkccjox-zccjrpfolmkmq.png\"}},\"description\":\"Сегодня мы рассмотрим протокол BGP. Не будем долго говорить зачем он и почему он используется как единственный протокол. Довольно много информации есть на этот с...\",\"url\":\"https:\\\u002F\\\u002Fhabr.com\\\u002Fru\\\u002Fpost\\\u002F450814\\\u002F#post-content-body\",\"about\":[\"h_cisconetworks\",\"h_network_technologies\",\"f_admin\"],\"image\":[\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fpost_images\\\u002F3fa\\\u002Fda6\\\u002Fdd3\\\u002F3fada6dd3c41923367af475da9b0ae10.jpg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fpost_images\\\u002Fd9d\\\u002F231\\\u002F607\\\u002Fd9d2316070de22049a24da6d86cecb2b.jpg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fpost_images\\\u002F853\\\u002Ff42\\\u002F1f0\\\u002F853f421f0a69f407c5ae4eae3423240c.jpg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fpost_images\\\u002Fcea\\\u002F5f8\\\u002F2b0\\\u002Fcea5f82b050662b2632cab01f3de8e24.jpg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fpost_images\\\u002F5e7\\\u002F80b\\\u002Fca0\\\u002F5e780bca084e8f42dab14d03f62723b6.jpg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fpost_images\\\u002Fd55\\\u002F6a8\\\u002F741\\\u002Fd556a874120b70319381332cdddf739b.jpg\"]}","metaDescription":"Сегодня мы рассмотрим протокол BGP. Не будем долго говорить зачем он и почему он используется как единственный протокол. Довольно много информации есть на этот счет, например тут. \r\n\r\nИтак, что такое...","mainImageUrl":null,"amp":false},"polls":[],"commentsEnabled":true,"rulesRemindEnabled":false,"votesEnabled":true,"status":"published","plannedPublishTime":null,"checked":null,"isEditorial":false}},"articlesIds":{},"isLoading":false,"pagesCount":{},"route":{},"reasonsList":null,"view":"cards","lastVisitedRoute":{},"ssrCommentsArticleIds":[""],"karma":{}},"authorContribution":{"authors":{}},"betaTest":{"currentAnnouncement":null,"announcements":{},"announcementCards":null,"announcementComments":{},"announcementCommentThreads":{},"announcementCommentingStatuses":{},"archivedList":[]},"authorStatistics":{"articleRefs":{},"articleIds":{},"pagesCount":{},"route":{},"viewsCount":[],"maxStatsCount":{}},"career":{"seoLandings":[],"hubs":"cisconetworks,network_technologies"},"comments":{"articleComments":{},"searchCommentsResults":null,"previewComment":null,"pagesCount":null,"commentAccess":{},"scrollParents":{},"pageArticleComments":{"lastViewedComment":0,"postId":null,"lastCommentTimestamp":"","moderated":[],"moderatedIds":[],"commentRoute":""}},"companies":{"companyRefs":{},"companyIds":{},"companyTopIds":{},"pagesCount":{},"companyProfiles":{},"companiesCategories":[],"companiesCategoriesTotalCount":0,"companiesWidgets":{},"companiesWorkers":{},"companiesFans":{},"route":{},"isLoading":false,"companyWorkersLoading":false,"companyFansLoading":false,"vacancies":{}},"companiesContribution":{"hubs":{},"flows":{},"companyRefs":{}},"companyHubsContribution":{"contributionRefs":{"hubRefs":{},"hubIds":{}}},"conversation":{"messages":[],"respondent":null,"isLoadMore":false},"conversations":{"conversations":[],"unreadCount":0,"pagesCount":0,"isLoadMore":false},"desktopState":{"desktopFl":null,"desktopHl":null,"isChecked":false,"isLoginDemanded":false},"dfp":{"slotsDict":{}},"docs":{"menu":{},"articles":{},"mainMenu":[],"loading":{"main":false,"dropdown":false,"article":false}},"feature":{"isProbablyVisible":"true"},"flows":{"flows":[{"alias":"develop","id":1,"route":{"name":"FLOW_PAGE","params":{"flowName":"develop"}}},{"alias":"admin","id":6,"route":{"name":"FLOW_PAGE","params":{"flowName":"admin"}}},{"alias":"design","id":2,"route":{"name":"FLOW_PAGE","params":{"flowName":"design"}}},{"alias":"management","id":3,"route":{"name":"FLOW_PAGE","params":{"flowName":"management"}}},{"alias":"marketing","id":4,"route":{"name":"FLOW_PAGE","params":{"flowName":"marketing"}}},{"alias":"popsci","id":7,"route":{"name":"FLOW_PAGE","params":{"flowName":"popsci"}}}]},"global":{"isPwa":false,"device":"desktop","isHabrCom":true},"hubs":{"hubRefs":{},"hubIds":{},"pagesCount":{},"isLoading":false,"route":{}},"hubsBlock":{"hubRefs":{},"hubIds":{}},"i18n":{"fl":"ru","hl":"ru"},"info":{"infoPage":{},"isLoading":true},"location":{"urlStruct":{"protocol":null,"slashes":null,"auth":null,"host":null,"port":null,"hostname":null,"hash":null,"search":null,"query":{},"pathname":null,"path":null,"href":""},"searchQuery":null},"me":{"user":null,"ppgDemanded":false,"karmaResetInfo":{"canReincarnate":null,"wasReincarnated":null,"currentScore":null},"notes":null},"mostReadingList":{"mostReadingListIds":[],"mostReadingListRefs":null,"promoPost":null},"pinnedPost":{"pinnedPost":null},"ppa":{"articles":{},"card":null,"transactions":null,"totalTransactions":null,"isAccessible":null},"projectsBlocks":{"activeBlocks":{}},"pullRefresh":{"shouldRefresh":false},"sandbox":{"articleIds":[],"articleRefs":{},"pagesCount":null,"route":{},"lastVisitedRoute":{},"isLoading":false},"settingsOther":{"inputs":{"uiLang":{"errors":[],"ref":null,"value":""},"articlesLangEnglish":{"errors":[],"ref":null,"value":false},"articlesLangRussian":{"errors":[],"ref":null,"value":false},"agreement":{"errors":[],"ref":null,"value":false},"email":{"errors":[],"ref":null,"value":true},"digest":{"errors":[],"ref":null,"value":true}}},"similarList":{"similarListIds":[],"similarListRefs":null},"ssr":{"error":null,"isDataLoaded":false,"isDataLoading":false,"isHydrationFailed":false,"isServer":false},"userHubsContribution":{"contributionRefs":{"hubRefs":{},"hubIds":{}}},"userInvites":{"availableInvites":0,"usedInvitesIds":[],"usedInvitesRefs":{},"usedInvitesPagesCount":0,"unusedInvitesIds":[],"unusedInvitesRefs":{},"unusedInvitesPagesCount":0},"users":{"authorRefs":{},"authorIds":{},"pagesCount":{},"authorProfiles":{},"userHubs":{},"userInvitations":{},"authorFollowers":{},"authorFollowed":{},"karmaStats":[],"statistics":null,"isLoading":false,"authorFollowersLoading":false,"authorFollowedLoading":false,"userHubsLoading":false,"userInvitationsLoading":false,"route":{}},"viewport":{"prevScrollY":{},"scrollY":0,"width":0},"tracker":{"items":{},"pagesCache":{},"markedViewedSilently":{},"markedRead":{},"unreadCounters":{"applications":null,"system":null,"mentions":null,"subscribers":null,"posts_and_comments":null},"unviewedCounters":{"applications":null,"system":null,"mentions":null,"subscribers":null,"posts_and_comments":null}}};(function(){var s;(s=document.currentScript||document.scripts[document.scripts.length-1]).parentNode.removeChild(s);}());</script>
<script src="https://assets.habr.com/habr-web/js/chunk-vendors.c2c3fc9a.js" defer></script><script src="https://assets.habr.com/habr-web/js/app.c0af73e7.js" defer></script>



    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    </script>
  
  <script type="text/javascript" >
    (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
    m[i].l=1*new Date();k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
    (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

    ym(24049213, "init", {
      defer:true,
      trackLinks:true,
      accurateTrackBounce:true,
      webvisor:false,
    });
  </script>
  <noscript>
    <div>
      <img src="https://mc.yandex.ru/watch/24049213" style="position:absolute; left:-9999px;" alt="" />
    </div>
  </noscript>
  
    <script type="text/javascript">
      window.addEventListener('load', function () {
        setTimeout(() => {
          const img = new Image();
          img.src = 'https://vk.com/rtrg?p=VK-RTRG-421343-57vKE';
        }, 0);
      });
    </script>
  
</body>
</html>
