<!DOCTYPE html>
<html lang="ru" data-vue-meta="%7B%22lang%22:%7B%22ssr%22:%22ru%22%7D%7D">
<head >
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover">
  <title>Принципы работы протокола PIM / Хабр</title>
  <style>
    /* cyrillic-ext */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveSxf6TF0.woff2) format('woff2');
      unicode-range: U+0460-052F, U+1C80-1C88, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
    }

    /* cyrillic */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveQhf6TF0.woff2) format('woff2');
      unicode-range: U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
    }

    /* latin-ext */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveSBf6TF0.woff2) format('woff2');
      unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
    }

    /* latin */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveRhf6.woff2) format('woff2');
      unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
    }
  </style>
  <link rel="preload" href="https://assets.habr.com/habr-web/css/chunk-vendors.e7843cc0.css" as="style"><link rel="preload" href="https://assets.habr.com/habr-web/js/chunk-vendors.c2c3fc9a.js" as="script"><link rel="preload" href="https://assets.habr.com/habr-web/css/app.02ee25a4.css" as="style"><link rel="preload" href="https://assets.habr.com/habr-web/js/app.c0af73e7.js" as="script">
  <link rel="stylesheet" href="https://assets.habr.com/habr-web/css/chunk-vendors.e7843cc0.css"><link rel="stylesheet" href="https://assets.habr.com/habr-web/css/app.02ee25a4.css">
  <script>window.i18nFetch = new Promise((res, rej) => {
          const xhr = new XMLHttpRequest();
          xhr.open('GET', '/js/i18n/ru-compiled.85eb77f0b17c8235e7b64b9f81ea5ec2.json');
          xhr.responseType = 'json';
          xhr.onload = function(e) {
            if (this.status === 200) {
              res({ru: xhr.response});
            } else {
              rej(e);
            }
          };
          xhr.send();
        });</script>
  
  <script data-vue-meta="ssr" src="/js/ads.js" onload="window['zhY4i4nJ9K'] = true" data-vmid="checkad"></script><script data-vue-meta="ssr" type="application/ld+json" data-vmid="ldjson-schema">{"@context":"http:\/\/schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/habr.com\/ru\/post\/450582\/"},"headline":"Принципы работы протокола PIM","datePublished":"2019-05-07T09:12:56+03:00","dateModified":"2019-05-07T13:42:50+03:00","author":{"@type":"Person","name":"Руслан Мамедов"},"publisher":{"@type":"Organization","name":"Habr","logo":{"@type":"ImageObject","url":"https:\/\/habrastorage.org\/webt\/a_\/lk\/9m\/a_lk9mjkccjox-zccjrpfolmkmq.png"}},"description":"Протокол PIM &mdash; это набор протоколов для передачи мультикаста в сети между маршрутизаторами. Отношения соседства строится аналогично как и в случае динамических п...","url":"https:\/\/habr.com\/ru\/post\/450582\/#post-content-body","about":["h_cisconetworks","h_network_technologies","f_admin"],"image":["https:\/\/habrastorage.org\/getpro\/habr\/post_images\/e67\/8a0\/1fc\/e678a01fc7879ecf22bc6f9a3825f9a6.jpg","https:\/\/habrastorage.org\/getpro\/habr\/post_images\/6cd\/08c\/fb6\/6cd08cfb6842680447d56860334af52c.png","https:\/\/habrastorage.org\/getpro\/habr\/post_images\/bc7\/1d0\/e9f\/bc71d0e9f81b292e75d4a016a9b657ef.png","https:\/\/habrastorage.org\/getpro\/habr\/post_images\/f1d\/9d1\/d68\/f1d9d1d6855fdc188deb28c75bde2d0d.png","https:\/\/habrastorage.org\/getpro\/habr\/post_images\/3de\/e1a\/c84\/3dee1ac8448b1fceaa9f1972eff802b7.png","https:\/\/habrastorage.org\/getpro\/habr\/post_images\/afd\/3ed\/52c\/afd3ed52cef0f9f105a0b58dff18edee.jpg","https:\/\/habrastorage.org\/getpro\/habr\/post_images\/a78\/cf2\/332\/a78cf23325ddc6e0c3d65322340d7ff6.jpg","https:\/\/habrastorage.org\/getpro\/habr\/post_images\/025\/d45\/651\/025d4565117dce5f8da07609c823c63e.jpg","https:\/\/habrastorage.org\/getpro\/habr\/post_images\/9f7\/730\/678\/9f7730678743efb4e9670d18fcd54525.jpg","https:\/\/habrastorage.org\/getpro\/habr\/post_images\/afd\/113\/eb0\/afd113eb01e7deda4c389fbb1a02060a.jpg","https:\/\/habrastorage.org\/getpro\/habr\/post_images\/aae\/ae2\/565\/aaeae25659fbacd4ba49ae4c5486f46f.jpg","https:\/\/habrastorage.org\/getpro\/habr\/post_images\/fb8\/e44\/7c2\/fb8e447c26e33ecda18cb82c5f05c938.jpg","https:\/\/habrastorage.org\/getpro\/habr\/post_images\/729\/3a4\/ad1\/7293a4ad164ed8342ff42ceffee9a32b.jpg","https:\/\/habrastorage.org\/getpro\/habr\/post_images\/5ed\/217\/8c1\/5ed2178c151886f79c1e6197b9b5385b.jpg","https:\/\/habrastorage.org\/getpro\/habr\/post_images\/406\/51a\/032\/40651a032dadaaf6e0c51cbf06c3fbf3.png","https:\/\/habrastorage.org\/getpro\/habr\/post_images\/2ba\/f2d\/dc4\/2baf2ddc4deb54ebb671a6fb52282a41.jpg"]}</script>
  <script src="//www.googletagservices.com/tag/js/gpt.js" async></script>
  <style>.grecaptcha-badge{visibility: hidden;}</style>
  <meta name="habr-version" content="2.49.0">
  
  <meta data-vue-meta="ssr" property="fb:app_id" content="444736788986613"><meta data-vue-meta="ssr" property="fb:pages" content="472597926099084"><meta data-vue-meta="ssr" name="twitter:card" content="summary_large_image"><meta data-vue-meta="ssr" name="twitter:site" content="@habr_eng"><meta data-vue-meta="ssr" property="og:title" content="Принципы работы протокола PIM" data-vmid="og:title"><meta data-vue-meta="ssr" name="twitter:title" content="Принципы работы протокола PIM" data-vmid="twitter:title"><meta data-vue-meta="ssr" name="aiturec:title" content="Принципы работы протокола PIM" data-vmid="aiturec:title"><meta data-vue-meta="ssr" name="description" content="Протокол PIM — это набор протоколов для передачи мультикаста в сети между маршрутизаторами. Отношения соседства строится аналогично как и в случае динамических протоколов маршрутизации. PIMv2..." data-vmid="description"><meta data-vue-meta="ssr" itemprop="description" content="Протокол PIM — это набор протоколов для передачи мультикаста в сети между маршрутизаторами. Отношения соседства строится аналогично как и в случае динамических протоколов маршрутизации. PIMv2..." data-vmid="description:itemprop"><meta data-vue-meta="ssr" property="og:description" content="Протокол PIM — это набор протоколов для передачи мультикаста в сети между маршрутизаторами. Отношения соседства строится аналогично как и в случае динамических протоколов маршрутизации. PIMv2..." data-vmid="og:description"><meta data-vue-meta="ssr" name="twitter:description" content="Протокол PIM — это набор протоколов для передачи мультикаста в сети между маршрутизаторами. Отношения соседства строится аналогично как и в случае динамических протоколов маршрутизации. PIMv2..." data-vmid="twitter:description"><meta data-vue-meta="ssr" property="aiturec:description" content="Протокол PIM — это набор протоколов для передачи мультикаста в сети между маршрутизаторами. Отношения соседства строится аналогично как и в случае динамических протоколов маршрутизации. PIMv2..." data-vmid="aiturec:description"><meta data-vue-meta="ssr" itemprop="image" content="https://habr.com/share/publication/450582/644125adbb6bdb7ea9e95fbc09cc05dc/" data-vmid="image:itemprop"><meta data-vue-meta="ssr" property="og:image" content="https://habr.com/share/publication/450582/644125adbb6bdb7ea9e95fbc09cc05dc/" data-vmid="og:image"><meta data-vue-meta="ssr" property="aiturec:image" content="https://habr.com/share/publication/450582/644125adbb6bdb7ea9e95fbc09cc05dc/" data-vmid="aiturec:image"><meta data-vue-meta="ssr" name="twitter:image" content="https://habr.com/share/publication/450582/644125adbb6bdb7ea9e95fbc09cc05dc/" data-vmid="twitter:image"><meta data-vue-meta="ssr" property="vk:image" content="https://habr.com/share/publication/450582/644125adbb6bdb7ea9e95fbc09cc05dc/" data-vmid="vk:image"><meta data-vue-meta="ssr" property="aiturec:item_id" content="450582" data-vmid="aiturec:item_id"><meta data-vue-meta="ssr" property="aiturec:datetime" content="2019-05-07T06:12:56.000Z" data-vmid="aiturec:datetime"><meta data-vue-meta="ssr" property="og:type" content="article" data-vmid="og:type"><meta data-vue-meta="ssr" property="og:locale" content="ru_RU" data-vmid="og:locale"><meta data-vue-meta="ssr" property="og:image:width" content="1200" data-vmid="og:image:width"><meta data-vue-meta="ssr" property="og:image:height" content="630" data-vmid="og:image:height">
  <link data-vue-meta="ssr" href="https://habr.com/ru/rss/post/450582/?fl=ru" type="application/rss+xml" title="" rel="alternate" name="rss"><link data-vue-meta="ssr" href="https://habr.com/ru/post/450582/" rel="canonical" data-vmid="canonical"><link data-vue-meta="ssr" data-vmid="hreflang"><link data-vue-meta="ssr" image_src="image" href="https://habr.com/share/publication/450582/644125adbb6bdb7ea9e95fbc09cc05dc/" data-vmid="image:href"><link data-vue-meta="ssr" rel="amphtml" href="https://habr.com/ru/amp/post/450582/">
  <meta name="apple-mobile-web-app-status-bar-style" content="#303b44">
  <meta name="msapplication-TileColor" content="#629FBC">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <link
    rel="shortcut icon"
    type="image/png"
    sizes="16x16"
    href="https://assets.habr.com/habr-web/img/favicons/favicon-16.png"
  >
  <link
    rel="shortcut icon"
    type="image/png"
    sizes="32x32"
    href="https://assets.habr.com/habr-web/img/favicons/favicon-32.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="76x76"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-76.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="120x120"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-120.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="152x152"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-152.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="180x180"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-180.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="256x256"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-256.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1136x640.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2436x1125.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1792x828.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_828x1792.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1334x750.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1242x2668.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2208x1242.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1125x2436.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1242x2208.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2732x2048.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2688x1242.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2224x1668.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_750x1334.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2048x2732.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2388x1668.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1668x2224.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_640x1136.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1668x2388.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2048x1536.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1536x2048.png"
  >
  <link
    rel="mask-icon"
    color="#77a2b6"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-120.svg"
  >
  <link
    crossorigin="use-credentials"
    href="/manifest.webmanifest"
    rel="manifest"
  >
</head>
<body>


<div id="app" data-server-rendered="true" data-async-called="true"><div class="tm-layout__wrapper"><!----> <div></div> <!----> <header class="tm-header"><div class="tm-page-width"><div class="tm-header__container"><!----> <span class="tm-header__logo-wrap"><a href="/ru/" class="tm-header__logo tm-header__logo_ru"><svg height="16" width="16" class="tm-svg-img tm-header__icon"><title>Хабр</title> <use xlink:href="/img/habr-logo-ru.svg#logo"></use></svg></a> <span class="tm-header__beta-sign" style="display:none;">β</span></span> <div class="tm-dropdown tm-header__projects"><div class="tm-dropdown__head"><button class="tm-header__dropdown-toggle"><svg height="16" width="16" class="tm-svg-img tm-header__icon tm-header__icon_dropdown"><title>Открыть список</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#arrow-down"></use></svg></button></div> <!----></div> <a href="/ru/sandbox/start/" class="tm-header__become-author-btn">
            Как стать автором
          </a> <div class="tm-feature tm-header__feature tm-feature_variant-inline"><!----></div> <!----> <!----></div></div></header> <div class="tm-layout"><div class="tm-page-progress-bar"></div> <div data-menu-sticky="true" class="tm-base-layout__header tm-base-layout__header_is-sticky"><div class="tm-page-width"><div class="tm-base-layout__header-wrapper"><div class="tm-main-menu"><div class="tm-main-menu__section"><nav class="tm-main-menu__section-content"><!----> <a href="/ru/all/" class="tm-main-menu__item">
        Все потоки
      </a> <a href="/ru/flows/develop/" class="tm-main-menu__item">
          Разработка
        </a><a href="/ru/flows/admin/" class="tm-main-menu__item">
          Администрирование
        </a><a href="/ru/flows/design/" class="tm-main-menu__item">
          Дизайн
        </a><a href="/ru/flows/management/" class="tm-main-menu__item">
          Менеджмент
        </a><a href="/ru/flows/marketing/" class="tm-main-menu__item">
          Маркетинг
        </a><a href="/ru/flows/popsci/" class="tm-main-menu__item">
          Научпоп
        </a></nav></div></div> <div class="tm-header-user-menu tm-base-layout__user-menu"><a href="/ru/search/" class="tm-header-user-menu__item tm-header-user-menu__search"><svg height="24" width="24" class="tm-svg-img tm-header-user-menu__icon tm-header-user-menu__icon_search tm-header-user-menu__icon_dark"><title>Поиск</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#search"></use></svg></a> <!----> <!----> <!----> <div class="tm-header-user-menu__item tm-header-user-menu__user_desktop"><div class="tm-dropdown"><div class="tm-dropdown__head"><svg height="24" width="24" data-test-id="menu-toggle-guest" class="tm-svg-img tm-header-user-menu__icon"><title>Профиль</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#header-user"></use></svg> <!----></div> <!----></div> <!----></div> <!----></div></div></div></div> <!----> <div class="tm-page-width"></div> <main class="tm-layout__container"><div hl="ru" data-async-called="true" class="tm-page"><div class="tm-page-width"><!----> <div class="tm-page__wrapper"><div class="tm-page__main tm-page__main_has-sidebar"><div class="pull-down"><div class="pull-down__header" style="height:0px;"><div class="pull-down__content" style="bottom:10px;"><svg height="24" width="24" class="tm-svg-img pull-down__arrow"><title>Обновить</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#pull-arrow"></use></svg></div></div> <div class="tm-article-presenter"> <div class="tm-article-presenter__body"><div class="tm-misprint-area"><div class="tm-misprint-area__wrapper"><article class="tm-article-presenter__content tm-article-presenter__content_narrow"><div class="tm-article-presenter__header"> <div class="tm-article-snippet tm-article-presenter__snippet"><div class="tm-article-snippet__meta-container"><div class="tm-article-snippet__meta"><span class="tm-user-info tm-article-snippet__author"><a href="/ru/users/Ruslan_Mammadov/" title="Ruslan_Mammadov" class="tm-user-info__userpic"><div class="tm-entity-image"><img alt="" height="24" loading="lazy" src="//habrastorage.org/r/w32/getpro/habr/avatars/5f8/12c/fb5/5f812cfb51ea930aaaf44c03a752f162.jpg" width="24" class="tm-entity-image__pic"></div></a> <span class="tm-user-info__user"><a href="/ru/users/Ruslan_Mammadov/" class="tm-user-info__username">
      Ruslan_Mammadov
    </a> </span></span> <span class="tm-article-snippet__datetime-published"><time datetime="2019-05-07T06:12:56.000Z" title="2019-05-07, 09:12">7  мая  2019 в 09:12</time></span></div> <!----></div> <h1 lang="ru" class="tm-article-snippet__title tm-article-snippet__title_h1"><span>Принципы работы протокола PIM</span></h1> <div class="tm-article-snippet__hubs"><span class="tm-article-snippet__hubs-item"><a href="/ru/hub/cisconetworks/" class="tm-article-snippet__hubs-item-link"><span>Cisco</span> <span title="Профильный хаб" class="tm-article-snippet__profiled-hub">*</span></a></span><span class="tm-article-snippet__hubs-item"><a href="/ru/hub/network_technologies/" class="tm-article-snippet__hubs-item-link"><span>Сетевые технологии</span> <span title="Профильный хаб" class="tm-article-snippet__profiled-hub">*</span></a></span></div> <!----> <!----> <!----></div></div> <!----> <div data-gallery-root="" lang="ru" class="tm-article-body"><div id="post-content-body" class="article-formatted-body article-formatted-body_version-1"><div xmlns="http://www.w3.org/1999/xhtml">Протокол PIM — это набор протоколов для передачи мультикаста в сети между маршрутизаторами. Отношения соседства строится аналогично как и в случае динамических протоколов маршрутизации. PIMv2 отправляет каждые 30 секунд Hello сообщения на зарезервированный мультикаст адрес 224.0.0.13 ( All-PIM-Routers ). Сообщение содержит в себе Hold Timers — обычно равен 3.5*Hello Timer, то есть 105 секунд по умолчанию.<br/>
<a href="https://i.imgur.com/AqjQmPR.jpg"><img src="https://habrastorage.org/r/w780q1/getpro/habr/post_images/e67/8a0/1fc/e678a01fc7879ecf22bc6f9a3825f9a6.jpg" alt="My Image" data-src="https://habrastorage.org/getpro/habr/post_images/e67/8a0/1fc/e678a01fc7879ecf22bc6f9a3825f9a6.jpg" data-blurred="true"/></a><br/>
 PIM использует два основных режима работы — Dense и Sparse mode. Начнем c Dense mode. <a name="habracut"></a><br/>
<b>Source-Based Distribution Trees.</b><br/>
Dense-mode режим целесообразно использовать в случае большого количества клиентов различных мультикаст групп. Когда маршрутизатор получает мулькаст трафик, то первым делом он проверяет его на правило RPF. RPF — данное правило используется для проверки источника мультикаста с юникастовой таблицей маршрутизации. Необходимо, чтоб трафик приходил на тот интерфейс, за которым скрывается данный хост по версии юникастовой таблицы маршрутизации. Этот механизм решает проблему возникновения петли при передаче мультикаста.<br/>
 <a href="https://i.imgur.com/RE54lnP.png"><img src="/img/image-loader.svg" alt="My Image" data-src="https://habrastorage.org/getpro/habr/post_images/6cd/08c/fb6/6cd08cfb6842680447d56860334af52c.png"/></a><br/>
R3 из мультикаст сообщения узнает источник мультикаста ( Source IP ) и проверит два потока от R1 и R2 по своей юникастовой таблице. Поток с того интерфейса, на который указывает таблица ( R1 к R3 ), будет передан дальше, а поток от R2 будет дропнут, так как, чтоб добраться до источника мультикаста, надо отправлять пакеты по S0/1.<br/>
Вопрос, что будет если у вас два эквивалентных маршрута с одинаковой метрикой? В этом случае маршрутизатор будет выбирать по next-hop у данных маршрутов. У кого выше ip адрес, тот и победил. Если необходимо изменить данное поведение, то можно использовать ECMP. Подробнее <a href="https://drive.google.com/file/d/1yiam4-OwlDoXrfdfdienMN_nQaOJGi29/view?usp=sharing">тут</a>.<br/>
После проверки правила RPF, маршрутизатор отправляет мультикаст пакет всем своим PIM соседям, за исключением того, от кого был получен данный пакет. Остальные PIM маршрутизаторы повторяют данный процесс. Путь, который прошел мультикаст пакет от источника до конечных получателей, образует дерево, которое называется — source-based distribution tree, shortest-path tree (SPT), source tree. Три разных названия, выбирайте любое.<br/>
Как решить вопрос с тем, что некоторым маршрутизаторам не сдался какой-то мультикастовый поток и отправлять его некому, а ему вышестоящий маршрутизатор шлет. Для это придуман Prune механизм. <br/>
<b>Prune Message.</b><br/>
Например, R2 будет продолжать слать R3 мультикаст, хотя R3 по правилу RPF дропает его. Зачем нагружать канал? R3 шлет PIM Prune Message и R2, при получении данного сообщения, удалит интерфейс S0/1 из списка ( outgoing interface list ) для данного потока, список интерфейсов, с которых надо посылать данный трафик. <br/>
<blockquote>The following is a more formal definition of a PIM Prune message:<br/>
The PIM Prune message is sent by one router to a second router to cause the second router to remove the link on which the Prune is received from a particular (S,G) SPT.</blockquote><br/>
После получения Prune сообщения, R2 выставляет Prune таймер в 3 минуты. Через три минуты он начнет отправлять трафик опять, пока не получит очередное Prune сообщение. Это в PIMv1.<br/>
А в PIMv2 добавлен State Refresh таймер ( по умолчанию 60 секунд ). Как только было отправлено Prune сообщение с R3, запускается данный таймер на R3. По истечении данного таймера, R3 будет отправлять State Refresh сообщение, которое будет сбрасывать 3-ех минутный Prune Timer на R2 для данной группы. <br/>
Причины отправки сообщения Prune:<br/>
<ul>
<li> Когда мультикаст пакет не прошел проверку RPF.</li>
<li> Когда нет локально подключенных клиентов, который запросил мультикастовую группу ( IGMP Join) и нет PIM соседей, которым можно отправлять мультикастовый трафик ( Non-prune Interface).</li>
</ul> <br/>
<b>Graft Message.</b><br/>
Представим, что R3 не захотел трафик от R2, отправил Prune и получал мультикаст от R1. Но вдруг, упал канал между R1-R3 и R3 остался без мультикаста. Можно ждать 3 минуты, пока на R2 не истечет Prune Timer. 3 минуты ждать долго, чтоб не ждать, необходимо послать сообщение, которое моментально выведет данный интерфейс S0/1 на R2 из pruned состояния. Таким сообщением будет Graft сообщение. После получения Graft сообщения, R2 отправит в ответ Graft-ACK.<br/>
<b>Prune Override.</b><br/>
 <a href="https://i.imgur.com/zfo0Dx5.png"><img src="/img/image-loader.svg" alt="My Image" data-src="https://habrastorage.org/getpro/habr/post_images/bc7/1d0/e9f/bc71d0e9f81b292e75d4a016a9b657ef.png"/></a><br/>
Посмотрим на данную схему. R1 вещает мультикаст в сегмент с двумя маршрутизаторами. R3 получает и вещает трафик, R2 получает, но вещать трафик ему некому. Он отправляет Prune сообщение к R1 в данный сегмент. R1 должен удалить Fa0/0 из списка и перестать вещать в данный сегмент, но что будет c R3? А R3 находится в том же сегменте, тоже получил данное Prune сообщение и понял всю трагичность ситуации. Перед тем как R1 перестанет вещать, он устанавливает таймер в 3 секунды и перестанет вещать через 3 секунды. 3 секунды — именно столько времени у R3, чтоб не потерять свой мультикаст. Поэтому R3, как можно скорее, отправляет Pim Join сообщение для данной группы и R1 уже не думает переставать вещать. О Join сообщениях ниже.<br/>
<b>Assert Message.</b><br/>
 <a href="https://i.imgur.com/rliwmNF.png"><img src="/img/image-loader.svg" alt="My Image" data-src="https://habrastorage.org/getpro/habr/post_images/f1d/9d1/d68/f1d9d1d6855fdc188deb28c75bde2d0d.png"/></a><br/>
Представим такую ситуацию: в одну сеть вещают сразу два маршрутизатора. Получают один и тот же поток от источника, и оба вещают его в одну сеть за интерфейсом e0. Поэтому им надо определить кто же будет одним единственным вещателем для данной сети. Для этого используются сообщения Assert. Когда R2 и R3 детектируют дупликацию мультикаст трафика, то есть на R2 и R3 приходит мультикаст, который они сами вещают, маршрутизаторы понимают, что тут что-то не так. Маршрутизаторы отправляют в этом случае Assert сообщения, в которые включены Administrative Distance и метрика маршрута при помощи которого достигается источник мультикаста — 10.1.1.10. Победитель определяется так:<br/>
<ol>
<li>Тот у кого ниже AD.</li>
<li>Если AD равны, то у кого ниже метрика.</li>
<li>Если и тут равенство, то тот у кого выше IP в сети, в которую они вещают этот мультикаст.</li>
</ol><br/>
Победивший в этом голосовании, маршрутизатор становится Designated Router-ом. Для выбора DR также используются Pim Hello. В начале статьи было показано PIM Hello сообщение, там можно заметить DR поле. Побеждает тот, у кого выше IP адреса на этом линке.<br/>
Полезная табличка:<br/>
 <a href="https://i.imgur.com/Et1kP7h.png"><img src="/img/image-loader.svg" alt="My Image" data-src="https://habrastorage.org/getpro/habr/post_images/3de/e1a/c84/3dee1ac8448b1fceaa9f1972eff802b7.png"/></a><br/>
<b>MROUTE Table.</b><br/>
После первоначального рассмотрения работы протокола PIM, нам необходимо разобраться с тем, как работать с мультикастовой таблицей маршрутизации. В таблице mroute храниться информация о том, какие потоки были запрошены со стороны клиентов и какие потоки льются с мультикаст серверов. <br/>
Например, при получения IGMP Membership Report или PIM Join на каком-то интерфейсе, в таблицу маршрутизации добавляется запись типа ( *, G ):<br/>
 <a href="https://i.imgur.com/ufXsgnR.jpg"><img src="https://habrastorage.org/r/w780q1/getpro/habr/post_images/afd/3ed/52c/afd3ed52cef0f9f105a0b58dff18edee.jpg" alt="My Image" data-src="https://habrastorage.org/getpro/habr/post_images/afd/3ed/52c/afd3ed52cef0f9f105a0b58dff18edee.jpg" data-blurred="true"/></a><br/>
Данная запись означает, что был получен запрос на трафик с адресом 238.38.38.38. Флаг DC означает, что мультикаст будет работать в режиме Dense mode и С означает, что получатель непосредственно подключен к маршрутизатору, то есть маршрутизатор получил IGMP Membership Report, а PIM Join.<br/>
Если есть запись типа (S,G) означает, что у нас есть мультикаст поток:<br/>
 <a href="https://i.imgur.com/QJCZZwf.jpg"><img src="https://habrastorage.org/r/w780q1/getpro/habr/post_images/a78/cf2/332/a78cf23325ddc6e0c3d65322340d7ff6.jpg" alt="My Image" data-src="https://habrastorage.org/getpro/habr/post_images/a78/cf2/332/a78cf23325ddc6e0c3d65322340d7ff6.jpg" data-blurred="true"/></a><br/>
В поле S — 192.168.1.11, у нас прописан IP адрес источника мультикаста, именно он будет проверяться правилом RPF. При проблемах, первым делом необходимо проверить юникастовую таблицу на маршрут к источнику. В поле Incoming Interface указывает интерфейс, на который поступает мультикаст. В юникастовой таблице маршрутизации, маршрут до источника должен ссылаться на интерфейс, указанный здесь. В Outgoing Interface указывается куда будет мультикаст перенаправлен. Если он пуст, значит к маршрутизатору не поступало запросов на данный трафик. Более подробную информацию о всех флагах можно найти <a href="https://drive.google.com/file/d/1ArBLFJdyN8tCangB5GL2JaS47FEZaad-/view?usp=sharing">здесь</a>.<br/>
<b>PIM Sparse-mode.</b><br/>
Стратегия Sparse-mode противоположна Dense-mode. Когда Sparse-mode получает мультикаст трафик, он будет отправлять трафик только через те интерфейсы, где были запросы на данный поток, например Pim Join или IGMP Report сообщения с запросом на данный трафик.<br/>
Cхожие элементы у SM и DM:<br/>
<ul>
<li> Отношения соседства строятся также, как и в PIM DM.</li>
<li> Работает правило RPF.</li>
<li> Выбор DR аналогичен.</li>
<li> Механизм Prune Overrides и сообщения Assert аналогичены.</li>
</ul><br/>
Для контроля того, кому, где и какой мультикаст трафик нужен в сети, необходимо общий информационный центр. Таким центром у нас будет Rendezvous Point ( RP ). Все, кто хочет какой-то мультикаст трафик или кто-то начал получать мультикаст трафик от источника, то он отправляет его на RP.<br/>
Когда RP получит мультикаст трафик, то отправит его тем маршрутизаторам, которые запросили до этого этот трафик. <br/>
 <a href="https://i.imgur.com/5AErtbS.jpg"><img src="https://habrastorage.org/r/w780q1/getpro/habr/post_images/025/d45/651/025d4565117dce5f8da07609c823c63e.jpg" alt="My Image" data-src="https://habrastorage.org/getpro/habr/post_images/025/d45/651/025d4565117dce5f8da07609c823c63e.jpg" data-blurred="true"/></a><br/>
Представим такую топологию, где RP это R3. Как только R1 получит трафик от S1, то он инкапсулирует данный мультикаст пакет в юникастовое PIM Register сообщение и отправит его на RP. Откуда он знает кто RP? В данном случае, он настроен статически, а о динамической настройке RP поговорим позже. <br/>
<blockquote>ip pim rp-address 3.3.3.3</blockquote><br/>
RP посмотрит — а была ли информация от кого-то, кто хотел бы получать этот трафик? Предположим, что не было. Тогда RP отправит R1 сообщение PIM Register-Stop, что означает — никому не нужен этот мультикаст, в регистрации отказано. R1 не будет посылать мультикаст. Но хост-источник мультикаста будет слать его, так что R1 после получения Register-Stop, запустит таймер Register-Suppression timer, равный 60 секундам. За 5 секунд до истечения данного таймера, R1 будет посылать пустое Register сообщение с Null-Register bit ( то есть без инкапсулированного мультикаст пакета) в сторону RP. RP в свою очередь будет действовать так:<br/>
<ul>
<li> Если получателей как не было, так и нет, то он будет отвечать Register-Stop сообщением.</li>
<li> Если получатели появились, то он никак не ответит на него. R1 не получив на свою регистрацию отказа в течении 5 секунд, обрадуется и отправит Register сообщение с инкапсулированным мультикаст на RP.</li>
</ul><br/>
Как мультикаст доходит до RP вроде бы разобрались, теперь попытаемся ответить на вопрос как RP доводит трафик до получателей. Здесь необходимо ввести новое понятие — root-path tree (RPT). RPT — это дерево с корнем в RP, растущее в сторону получателей, разветвляющиеся на каждом PIM-SM маршрутизаторе. RP создает его, получая PIM Join сообщения и добавляет в дерево новую ветвь. И так, делает каждый нижестоящий маршрутизатор. Общее правило выглядит так:<br/>
<ul>
<li> Когда PIM-SM маршрутизатор получает PIM Join сообщение на каком-либо интерфейсе, за исключением интерфейса за котором скрывается RP, он добавляет в дерево новую ветвь.</li>
<li> Также ветвь добавляется, когда PIM-SM маршрутизатор получает IGMP Membership Report с непосредственно подключенного хоста. </li>
</ul><br/>
Представим, что у нас появился клиент мультикаста на маршрутизаторе R5 на группу 228.8.8.8. Как только R5 получит IGMP Membership Report от хоста, R5 отправляет PIM Join в направлении RP, а сам добавляет в дерево интерфейс, смотрящий на хост. Далее, R4 получает PIM Join от R5, добавляет в дерево интерфейс Gi0/1 и отправляет PIM Join в направлении RP. Наконец то, RP ( R3 ) получает PIM Join и добавляет Gi0/0 в дерево. Таким образом, получается регистрация получателя мультикаста. У нас строится дерево с корнем R3-Gi0/0 → R4-Gi0/1 → R5-Gi0/0.<br/>
После этого, будет отправлен PIM Join к R1 и R1 начнет слать мультикаст трафик. Важно заметить, что если хост запросил трафик до того, как началось вещание мультикаста, то RP не будет отправлять PIM Join и вообще не будет ничего отправлять в строну R1.<br/>
Если вдруг пока отправляется мультикаст, хост перестанет хотеть его получать, как только RP получит PIM Prune на интерфейс Gi0/0, то сразу отправит PIM Register-Stop непосредственно на R1, а затем и PIM Prune сообщение через интерфейс Gi0/1. PIM Register-stop отправляется юникастом на тот адрес, с которого поступило PIM Register.<br/>
Как мы говорили раньше, как только маршрутизатор отправляет PIM Join другому, например R5 на R4, то на R4 добавляется запись:<br/>
 <a href="https://i.imgur.com/msZjbr8.jpg"><img src="https://habrastorage.org/r/w780q1/getpro/habr/post_images/9f7/730/678/9f7730678743efb4e9670d18fcd54525.jpg" alt="My Image" data-src="https://habrastorage.org/getpro/habr/post_images/9f7/730/678/9f7730678743efb4e9670d18fcd54525.jpg" data-blurred="true"/></a><br/>
И запускается таймер, что сбросить данный таймер R5 должен постоянно PIM Join сообщения постоянно, а то R4 исключит из outgoing list. R5 будет отправлять каждые 60 PIM Join сообщения.<br/>
<b>Shortest-Path Tree Switchover.</b><br/>
Мы добавим интерфейс между R1 и R5, посмотрим как будет литься трафик при такой топологии. <br/>
 <a href="https://i.imgur.com/wLKEyyg.jpg"><img src="https://habrastorage.org/r/w780q1/getpro/habr/post_images/afd/113/eb0/afd113eb01e7deda4c389fbb1a02060a.jpg" alt="My Image" data-src="https://habrastorage.org/getpro/habr/post_images/afd/113/eb0/afd113eb01e7deda4c389fbb1a02060a.jpg" data-blurred="true"/></a><br/>
Допустим, что трафик отправлялся и получался по старой схеме R1-R2-R3-R4-R5 и тут мы подключили и настроили интерфейс между R1 и R5.<br/>
Первым делом, у нас перестроиться юникастовая таблица маршрутизации на R5 и теперь сеть 192.168.1.0/24 достигается через интерфейс R5 Gi0/2. Теперь R5 получая мультикаст на интерфейсе Gi0/1, понимает, что правило RPF не удовлетворяется и мультикаст логичнее бы получать на Gi0/2. Он должен отключиться от RPT и построить более короткое дерево, которое называется Shortest-Path Tree ( SPT ). Для этого он через Gi0/2 отправляет PIM Join на R1 и R1 начинает слать мультикаст еще и через Gi0/2. Теперь R5 надо отписаться от RPT, чтоб не получать две копии. Для этого он отправляет Prune сообщение указывая ip адрес источника и вставляя специальный бит — RPT-bit. Это значит, что не надо мне посылать трафик, у меня здесь дерево получше. RP также отправляет в сторону R1 PIM Prune сообщения, но не отправляет Register-Stop сообщение. Еще одна особенность: R5 теперь будет постоянно отправлять PIM Prune на RP, так как R1 продолжает отправлять PIM Register на RP каждую минуту. RP пока не будет новых желающих данного трафика будет отвечать ему отказом. R5 уведомляет RP, что он продолжает получать мультикаст через SPT.<br/>
<b>Динамический поиск RP. <br/>
Auto-RP.</b><br/>
Данная технология является проприетарной от Cisco и не пользуется особой популярной, но все еще жива. Работа Auto-RP состоит из двух основных этапов:<br/>
1) RP шлет RP-Announce сообщения на зарезервированный адрес — 224.0.1.39, объявляя себя RP либо для всех либо для определенных групп. Отправляется данное сообщение каждую минуту.<br/>
2) Необходим RP mapping agent, который будет слать RP-Discovery сообщения с указанием для каких групп какой RP необходимо слушать. Именно из этого сообщения, обычные PIM маршрутизаторы будут определять для себя RP. Mapping Agent может быть как сам RP маршрутизатор, так и какой-либо отдельный PIM маршрутизатор. RP-Discovery отправляется на адрес 224.0.1.40 c таймером в одну минуту.<br/>
Посмотрим на процесс поподробнее:<br/>
Настроим R3 как RP:<br/>
<blockquote>ip pim send-rp-announce loopback 0 scope 10</blockquote><br/>
R2 как mapping agent:<br/>
<blockquote>ip pim send-rp-discovery loopback 0 scope 10</blockquote><br/>
А на всех остальных будем ожидать RP через Auto-RP:<br/>
<blockquote>ip pim autorp listener</blockquote><br/>
Как только мы настроим R3, он начнет отправлять RP-Announce:<br/>
 <a href="https://i.imgur.com/6c4WucN.jpg"><img src="https://habrastorage.org/r/w780q1/getpro/habr/post_images/aae/ae2/565/aaeae25659fbacd4ba49ae4c5486f46f.jpg" alt="My Image" data-src="https://habrastorage.org/getpro/habr/post_images/aae/ae2/565/aaeae25659fbacd4ba49ae4c5486f46f.jpg" data-blurred="true"/></a><br/>
А R2 после настройки mapping agent-ом, начнет ждать сообщения RP-Announce. Только когда он найдет хотя бы один RP, то начнет отправлять RP-Discovery:<br/>
 <a href="https://i.imgur.com/lw2JuDD.jpg"><img src="https://habrastorage.org/r/w780q1/getpro/habr/post_images/fb8/e44/7c2/fb8e447c26e33ecda18cb82c5f05c938.jpg" alt="My Image" data-src="https://habrastorage.org/getpro/habr/post_images/fb8/e44/7c2/fb8e447c26e33ecda18cb82c5f05c938.jpg" data-blurred="true"/></a><br/>
Таким образом, как только обычные маршрутизаторы ( PIM RP Listener ) получат данное сообщения, они будут знать где искать RP.<br/>
Одна из основных проблем Auto-RP заключается в том, что чтобы получать сообщения RP-Announce и RP-Discovery необходимо отправлять PIM Join на адреса 224.0.1.39-40, а для того, чтобы отправить, надо знать где находится RP. Классическая проблема курицы и яйца. Для решение это проблемы, был придуман режим PIM Sparse-Dense-Mode. Если маршрутизатор не знает RP, то он работает в режиме Dense-mode, если знает, то в режиме Sparse-mode. Когда на интерфейсах обычных маршрутизаторов настроен PIM Sparse-mode и команда ip pim autorp listener, то маршрутизатор будет работать в режиме Dense-mode только для мультикаста непосредственно Auto-RP протокола ( 224.0.1.39-40 ).<br/>
<b>BootStrap Router (BSR).</b><br/>
Данный функция работает похоже на Auto-RP. Каждый RP шлет сообщение mapping agent-у, который собирает маппинг информацию и далее рассказывает всем остальным маршрутизаторам. Опишем процесс аналогично Auto-RP:<br/>
1) Как только мы настроим R3 в качестве кандидата быть RP, командой:<br/>
<blockquote>ip pim rp-candidate loopback 0</blockquote><br/>
То R3 ничего делать не будет, для того, чтобы начать слать специальные сообщение, ему, для начала, надо найти mapping agent-а. Таким образом, переходим ко второму шагу.<br/>
2) Настраиваем R2 как mapping agent:<br/>
<blockquote>ip pim bsr-candidate loopback 0</blockquote><br/>
R2 начинает рассылать PIM Bootstrap сообщения, где указывает себя в качестве mapping agent-а:<br/>
<a href="https://i.imgur.com/uAj49oT.jpg"><img src="https://habrastorage.org/r/w780q1/getpro/habr/post_images/729/3a4/ad1/7293a4ad164ed8342ff42ceffee9a32b.jpg" alt="My Image" data-src="https://habrastorage.org/getpro/habr/post_images/729/3a4/ad1/7293a4ad164ed8342ff42ceffee9a32b.jpg" data-blurred="true"/></a><br/>
Отправляется данное сообщение на адрес 224.0.013, которое PIM протокол использует и для других своих сообщений. Он отправляет их во все стороны и поэтому нет проблемы курицы и яйца, как было в Auto-RP.<br/>
3) Как только RP получит сообщение от BSR маршрутизатора, он сразу отправит юникастовое сообщение на адрес BSR маршрутизатора:<br/>
<a href="https://i.imgur.com/qwtXY88.jpg"><img src="https://habrastorage.org/r/w780q1/getpro/habr/post_images/5ed/217/8c1/5ed2178c151886f79c1e6197b9b5385b.jpg" alt="My Image" data-src="https://habrastorage.org/getpro/habr/post_images/5ed/217/8c1/5ed2178c151886f79c1e6197b9b5385b.jpg" data-blurred="true"/></a><br/>
После чего, BSR получив информацию о RP, разошлет их мультикастом на адрес 224.0.0.13, который слушают все PIM маршрутизаторы. Поэтому, аналога команды <i>ip pim autorp listener</i> для обычных маршрутизаторов нет в BSR.<br/>
<b>Anycast RP with Multicast Source Discovery Protocol (MSDP).</b><br/>
Auto-RP и BSR нам позволяют распредилить нагрузку на RP следующим образом: У каждой мультикаст группы есть только один активный RP. Не получится сделать распределение нагрузки для одной мультикаст группы несколько RP. MSDP делает это при помощи выдачи RP маршрутизаторам одинакового ip адреса с маской 255.255.255.255. MSDP узнает информацию при помощи одного из методов: статики, Auto-RP или BSR.<br/>
<a href="https://i.imgur.com/U4aDz5H.png"><img src="/img/image-loader.svg" alt="My Image" data-src="https://habrastorage.org/getpro/habr/post_images/406/51a/032/40651a032dadaaf6e0c51cbf06c3fbf3.png"/></a><br/>
На картинке у нас Auto-RP конфигурация с MSDP. Оба RP настроены с ip адресом 172.16.1.1/32 на Loopback 1 интерфейсе и используется для всех групп. При RP-Announce оба маршрутизатора рассказывают о себе, ссылаясь на этот адрес. Auto-RP mapping agent, получив информацию, рассылает RP-Discovery об RP c адресом 172.16.1.1/32. Про сеть 172.16.1.1/32, маршрутизаторам мы рассказываем при помощи IGP и, соответственно. Таким образом, PIM маршрутизаторы запрашивают или регистрируют потоки с того RP, к который указан как next-hop у маршрута к сети 172.16.1.1/32. Cам протокол MSDP же призван для самих RP, чтоб обмениваться сообщениями о информации про мультикаст.<br/>
Рассмотрим такую топологию:<br/>
<a href="https://i.imgur.com/zgkGDOP.jpg"><img src="https://habrastorage.org/r/w780q1/getpro/habr/post_images/2ba/f2d/dc4/2baf2ddc4deb54ebb671a6fb52282a41.jpg" alt="My Image" data-src="https://habrastorage.org/getpro/habr/post_images/2ba/f2d/dc4/2baf2ddc4deb54ebb671a6fb52282a41.jpg" data-blurred="true"/></a><br/>
Switch6 вещает трафик на адрес 238.38.38.38 и о нем пока знает только RP-R1. Вот Switch7 и Switch8 запросили данную группу. Маршрутизаторы R5 и R4 отправят PIM Join на R1 и R3, соответственно. Почему? Маршрут до 13.13.13.13 у R5 будет ссылаться на R1 по метрике IGP, как и у R4.<br/>
RP-R1 знает о потоке и начнет вещать его в сторону R5, а вот R4 ничего о нем не знает, так как R1 просто так его отправлять не будет. Поэтому необходим MSDP. Настраиваем его на R1 и R5:<br/>
<blockquote>ip msdp peer 3.3.3.3 connect-source Loopback1 на R1</blockquote><br/>
<blockquote>ip msdp peer 1.1.1.1 connect-source Loopback3 на R3</blockquote><br/>
Они поднимут сессию между друг другом и при получении какого-либо потока будут сообщать о нем своему RP соседу.<br/>
RP-R1 как только получит поток от Switch6, сразу отправит юникастом MSDP Source-Active сообщение, где будет содержаться информация типа ( S, G) — информация о источнике и назначении мультикаста. Теперь, когда RP-R3 будет знать, что такой источник как Switch6, он при получении запроса от R4 на данный поток, будет слать в сторону Switch6 PIM Join, руководстваясь таблицей маршрутизации. Следовательно, R1 получив такой PIM Join, начнет слать трафик в сторону RP-R3.<br/>
MSDP работает по TCP, RP посылают друг другу keepalive сообщения для проверки жизнеспособности. Таймер равен 60 cекундам.<br/>
Остается непонятной функция разделения MSDP пиров в различные домены, так как в сообщениях Keepalive и SA не указывается принадлежность какому-либо домену. Также в данной топологии тестировалась конфигурация с указанием различных доменов — разницы в работе не было. <br/>
Если кто-то может внести ясность, с радостью почитаю в комментариях.<br/>
<br/>
На этом думаю закончить статью. Внизу полезный материалы и ссылки, которые использовались:<br/>
<ol>
<li>CCIE Routing and Switching v5.0 Official Cert Guide, Volume 2, Fifth Edition, Narbik Kocharians, Terry Vinson.</li>
<li><a href="https://habr.com/ru/post/217585/#L2_Multicast">Сети для самых маленьких. Часть девятая. Мультикаст</a></li>
</ol></div></div> <!----> <!----></div> <div class="tm-article-presenter__meta"><div class="tm-separated-list tm-article-presenter__meta-list"><span class="tm-separated-list__title">Теги:</span> <ul class="tm-separated-list__list"><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bcisco%20multicast%20pim%5D" class="tm-tags-list__link">cisco multicast pim</a></li></ul></div> <div class="tm-separated-list tm-article-presenter__meta-list"><span class="tm-separated-list__title">Хабы:</span> <ul class="tm-separated-list__list"><li class="tm-separated-list__item"><a href="/ru/hub/cisconetworks/" class="tm-hubs-list__link">
    Cisco
  </a></li><li class="tm-separated-list__item"><a href="/ru/hub/network_technologies/" class="tm-hubs-list__link">
    Сетевые технологии
  </a></li></ul></div></div></article></div> <!----></div> <div class="tm-article-sticky-panel"><div class="tm-data-icons tm-article-sticky-panel__icons"><div class="tm-article-rating tm-data-icons__item"><div class="tm-votes-meter tm-article-rating__votes-switcher"><svg height="16" width="16" class="tm-svg-img tm-votes-meter__icon tm-votes-meter__icon_medium"><title>Всего голосов 11: ↑11 и ↓0</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#counter-rating"></use></svg> <span title="Всего голосов 11: ↑11 и ↓0" class="tm-votes-meter__value tm-votes-meter__value_positive tm-votes-meter__value_medium">+11</span></div> <DIV class="v-portal" style="display:none;"></DIV></div> <!----> <span title="Количество просмотров" class="tm-icon-counter tm-data-icons__item"><svg height="16" width="16" class="tm-svg-img tm-icon-counter__icon"><title>Просмотры</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#counter-views"></use></svg> <span class="tm-icon-counter__value">16K</span></span> <button title="Добавить в закладки" type="button" class="bookmarks-button tm-data-icons__item"><span title="Добавить в закладки" class="tm-svg-icon__wrapper bookmarks-button__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Добавить в закладки</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#counter-favorite"></use></svg></span> <span title="Количество пользователей, добавивших публикацию в закладки" class="bookmarks-button__counter">
    52
  </span></button> <!----> <div title="Поделиться" class="tm-sharing tm-data-icons__item"><button type="button" class="tm-sharing__button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="tm-sharing__icon"><path fill="currentColor" d="M10.33.275l9.047 7.572a.2.2 0 010 .306l-9.048 7.572a.2.2 0 01-.328-.153V11c-8 0-9.94 6-9.94 6S-1 5 10 5V.428a.2.2 0 01.328-.153z"></path></svg></button> <!----></div> <DIV class="v-portal" style="display:none;"></DIV></div> </div></div> <!----> <!----> <div class="tm-article-presenter__footer"><div class="tm-article-blocks"><!----> <section class="tm-block tm-block_spacing-bottom"><!----> <div class="tm-block__body tm-block__body_variant-balanced"><div class="tm-article-author"> <div class="tm-user-card tm-article-author__user-card tm-user-card_variant-article"><div class="tm-user-card__info-container"><div class="tm-user-card__header"><div class="tm-user-card__header-data"><a href="/ru/users/Ruslan_Mammadov/" class="tm-user-card__userpic tm-user-card__userpic_size-40"><div class="tm-entity-image"><img alt="" src="//habrastorage.org/getpro/habr/avatars/5f8/12c/fb5/5f812cfb51ea930aaaf44c03a752f162.jpg" class="tm-entity-image__pic"></div></a> <div class="tm-user-card__meta"><div title=" 28 голосов " class="tm-karma tm-user-card__karma"><div class="tm-karma__votes tm-karma__votes_positive">
    27
  </div> <div class="tm-karma__text">
    Карма
  </div></div> <div title="Рейтинг пользователя" class="tm-rating tm-user-card__rating"><div class="tm-rating__header"> <div class="tm-rating__counter">0</div></div> <div class="tm-rating__text">
    Рейтинг
  </div></div></div></div></div> <div class="tm-user-card__info tm-user-card__info_variant-article"><div class="tm-user-card__title tm-user-card__title_variant-article"><span class="tm-user-card__name tm-user-card__name_variant-article">Руслан Мамедов</span> <a href="/ru/users/Ruslan_Mammadov/" class="tm-user-card__nickname tm-user-card__nickname_variant-article">
          @Ruslan_Mammadov
        </a> <!----></div> <p class="tm-user-card__short-info tm-user-card__short-info_variant-article">Пользователь</p></div></div> <div class="tm-user-card__buttons tm-user-card__buttons_variant-article"><!----> <!----> <!----> <!----> <!----></div></div> <!----></div> <DIV class="v-portal" style="display:none;"></DIV></div> <!----></section> <div class="tm-article-blocks__comments"><div class="tm-article-page-comments"><div class="tm-article-comments-counter-link tm-article-comments-counter-button"><a href="/ru/post/450582/comments/" class="tm-article-comments-counter-link__link tm-article-comments-counter-link__link_button-style"><svg height="16" width="16" class="tm-svg-img tm-article-comments-counter-link__icon tm-article-comments-counter-link__icon_contrasted"><title>Комментарии</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#counter-comments"></use></svg> <span class="tm-article-comments-counter-link__value tm-article-comments-counter-link__value_contrasted">
       Комментарии 2 
    </span></a> <!----></div></div></div> <div class="tm-ad-banner__container tm-page-article__banner"><!----> <div id="articleBottomBanner" class="tm-ad-banner"></div></div> <!----> <!----> <!----> <!----> </div></div></div></div></div> <div class="tm-page__sidebar"><div class="tm-layout-sidebar"><div class="tm-layout-sidebar__ads tm-layout-sidebar__ads_initial"><div class="tm-ad-banner__container tm-layout-sidebar__banner"><!----> <div id="sidebarBanner" class="tm-ad-banner"></div></div></div> <div class="tm-sexy-sidebar tm-sexy-sidebar_initial" style="margin-top:0px;"><!----> <!----></div></div></div></div></div></div></main> <!----></div> <div class="tm-footer-menu"><div class="tm-page-width"><div class="tm-footer-menu__container"><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Ваш аккаунт
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="/kek/v1/auth/habrahabr/?back=/ru/post/450582/&amp;hl=ru" rel="nofollow" target="_self">
                Войти
              </a></li><li class="tm-footer-menu__list-item"><a href="/kek/v1/auth/habrahabr-register/?back=/ru/post/450582/&amp;hl=ru" rel="nofollow" target="_self">
                Регистрация
              </a></li></ul></div></div><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Разделы
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="/ru/" class="footer-menu__item-link router-link-active">
                Публикации
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/news/" class="footer-menu__item-link">
                Новости
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/hubs/" class="footer-menu__item-link">
                Хабы
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/companies/" class="footer-menu__item-link">
                Компании
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/users/" class="footer-menu__item-link">
                Авторы
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/sandbox/" class="footer-menu__item-link">
                Песочница
              </a></li></ul></div></div><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Информация
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="/ru/docs/help/" class="footer-menu__item-link">
                Устройство сайта
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/docs/authors/codex/" class="footer-menu__item-link">
                Для авторов
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/docs/companies/corpblogs/" class="footer-menu__item-link">
                Для компаний
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/docs/docs/transparency/" class="footer-menu__item-link">
                Документы
              </a></li><li class="tm-footer-menu__list-item"><a href="https://account.habr.com/info/agreement" target="_blank">
                Соглашение
              </a></li><li class="tm-footer-menu__list-item"><a href="https://account.habr.com/info/confidential/" target="_blank">
                Конфиденциальность
              </a></li></ul></div></div><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Услуги
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="https://docs.google.com/presentation/d/e/2PACX-1vQLwRfQmXibiUlWaRg-BAc38s7oM3lJiaPju7qmdJsp8ysIvZ_G-Npem0njJLMozE2bPHMpDqiI5hhy/pub?start=false&amp;loop=false&amp;delayms=60000&amp;slide=id.g91a03369cd_4_297" target="_blank">
                Реклама
              </a></li><li class="tm-footer-menu__list-item"><a href="https://habrastorage.org/storage/stuff/habr/service_price.pdf" target="_blank">
                Тарифы
              </a></li><li class="tm-footer-menu__list-item"><a href="https://docs.google.com/presentation/d/e/2PACX-1vQJJds8-Di7BQSP_guHxICN7woVYoN5NP_22ra-BIo4bqnTT9FR6fB-Ku2P0AoRpX0Ds-LRkDeAoD8F/pub?start=false&amp;loop=false&amp;delayms=60000" target="_blank">
                Контент
              </a></li><li class="tm-footer-menu__list-item"><a href="https://tmtm.timepad.ru/" target="_blank">
                Семинары
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/megaprojects/" class="footer-menu__item-link">
                Мегапроекты
              </a></li></ul></div></div></div></div></div> <div class="tm-footer"><div class="tm-page-width"><div class="tm-footer__container"><!----> <div class="tm-footer__social"><a href="https://www.facebook.com/habrahabr.ru" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Facebook</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-facebook"></use></svg></a><a href="https://twitter.com/habr_com" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Twitter</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-twitter"></use></svg></a><a href="https://vk.com/habr" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>VK</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-vkontakte"></use></svg></a><a href="https://telegram.me/habr_com" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Telegram</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-telegram"></use></svg></a><a href="https://www.youtube.com/channel/UCd_sTwKqVrweTt4oAKY5y4w" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Youtube</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-youtube"></use></svg></a><a href="https://zen.yandex.ru/habr" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Яндекс Дзен</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-zen"></use></svg></a></div> <DIV class="v-portal" style="display:none;"></DIV> <button class="tm-footer__link"><!---->
        Настройка языка
      </button> <a href="/ru/about" class="tm-footer__link">
        О сайте
      </a> <a href="/ru/feedback/" class="tm-footer__link">
        Техническая поддержка
      </a> <!----> <a href="/berserk-mode-nope" class="tm-footer__link">
        Вернуться на старую версию
      </a> <div class="tm-footer-copyright"><span class="tm-copyright"><span class="tm-copyright__years">© 2006–2021 </span> <span class="tm-copyright__name">«<a href="https://company.habr.com/" rel="noopener" target="_blank" class="tm-copyright__link">Habr</a>»</span></span></div></div></div></div> <!----> <!----></div> <div class="vue-portal-target"></div></div>
<script>window.__INITIAL_STATE__={"adblock":{"hasAcceptableAdsFilter":false,"hasAdblock":false},"articlesList":{"articlesList":{"450582":{"id":"450582","timePublished":"2019-05-07T06:12:56+00:00","isCorporative":false,"lang":"ru","titleHtml":"Принципы работы протокола PIM","leadData":{"textHtml":"Протокол PIM — это набор протоколов для передачи мультикаста в сети между маршрутизаторами. Отношения соседства строится аналогично как и в случае динамических протоколов маршрутизации. PIMv2 отправляет каждые 30 секунд Hello сообщения на зарезервированный мультикаст адрес 224.0.0.13 ( All-PIM-Routers ). Сообщение содержит в себе Hold Timers — обычно равен 3.5*Hello Timer, то есть 105 секунд по умолчанию.\u003Cbr\u003E\r\n\u003Ca href=\"https:\u002F\u002Fi.imgur.com\u002FAqjQmPR.jpg\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fpost_images\u002Fe67\u002F8a0\u002F1fc\u002Fe678a01fc7879ecf22bc6f9a3825f9a6.jpg\" alt=\"My Image\"\u003E\u003C\u002Fa\u003E\u003Cbr\u003E\r\n PIM использует два основных режима работы — Dense и Sparse mode. Начнем c Dense mode.","imageUrl":null,"buttonTextHtml":"Читать дальше →","image":null},"editorVersion":"1.0","postType":"article","postLabels":[],"author":{"scoreStats":{"score":27,"votesCount":28},"rating":0,"relatedData":null,"contacts":[],"authorContacts":[],"paymentDetails":{"paymentYandexMoney":null,"paymentPayPalMe":null,"paymentWebmoney":null},"id":"1788889","alias":"Ruslan_Mammadov","fullname":"Руслан Мамедов","avatarUrl":"\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Favatars\u002F5f8\u002F12c\u002Ffb5\u002F5f812cfb51ea930aaaf44c03a752f162.jpg","speciality":"Пользователь"},"statistics":{"commentsCount":2,"favoritesCount":52,"readingCount":16439,"score":11,"votesCount":11},"hubs":[{"relatedData":null,"id":"6900","alias":"cisconetworks","type":"collective","title":"Cisco","titleHtml":"Cisco","isProfiled":true},{"relatedData":null,"id":"17123","alias":"network_technologies","type":"collective","title":"Сетевые технологии","titleHtml":"Сетевые технологии","isProfiled":true}],"flows":[{"id":"6","alias":"admin","title":"Администрирование"}],"relatedData":null,"textHtml":"\u003Cdiv xmlns=\"http:\u002F\u002Fwww.w3.org\u002F1999\u002Fxhtml\"\u003EПротокол PIM — это набор протоколов для передачи мультикаста в сети между маршрутизаторами. Отношения соседства строится аналогично как и в случае динамических протоколов маршрутизации. PIMv2 отправляет каждые 30 секунд Hello сообщения на зарезервированный мультикаст адрес 224.0.0.13 ( All-PIM-Routers ). Сообщение содержит в себе Hold Timers — обычно равен 3.5*Hello Timer, то есть 105 секунд по умолчанию.\u003Cbr\u002F\u003E\r\n\u003Ca href=\"https:\u002F\u002Fi.imgur.com\u002FAqjQmPR.jpg\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780q1\u002Fgetpro\u002Fhabr\u002Fpost_images\u002Fe67\u002F8a0\u002F1fc\u002Fe678a01fc7879ecf22bc6f9a3825f9a6.jpg\" alt=\"My Image\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fpost_images\u002Fe67\u002F8a0\u002F1fc\u002Fe678a01fc7879ecf22bc6f9a3825f9a6.jpg\" data-blurred=\"true\"\u002F\u003E\u003C\u002Fa\u003E\u003Cbr\u002F\u003E\r\n PIM использует два основных режима работы — Dense и Sparse mode. Начнем c Dense mode. \u003Ca name=\"habracut\"\u003E\u003C\u002Fa\u003E\u003Cbr\u002F\u003E\r\n\u003Cb\u003ESource-Based Distribution Trees.\u003C\u002Fb\u003E\u003Cbr\u002F\u003E\r\nDense-mode режим целесообразно использовать в случае большого количества клиентов различных мультикаст групп. Когда маршрутизатор получает мулькаст трафик, то первым делом он проверяет его на правило RPF. RPF — данное правило используется для проверки источника мультикаста с юникастовой таблицей маршрутизации. Необходимо, чтоб трафик приходил на тот интерфейс, за которым скрывается данный хост по версии юникастовой таблицы маршрутизации. Этот механизм решает проблему возникновения петли при передаче мультикаста.\u003Cbr\u002F\u003E\r\n \u003Ca href=\"https:\u002F\u002Fi.imgur.com\u002FRE54lnP.png\"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" alt=\"My Image\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fpost_images\u002F6cd\u002F08c\u002Ffb6\u002F6cd08cfb6842680447d56860334af52c.png\"\u002F\u003E\u003C\u002Fa\u003E\u003Cbr\u002F\u003E\r\nR3 из мультикаст сообщения узнает источник мультикаста ( Source IP ) и проверит два потока от R1 и R2 по своей юникастовой таблице. Поток с того интерфейса, на который указывает таблица ( R1 к R3 ), будет передан дальше, а поток от R2 будет дропнут, так как, чтоб добраться до источника мультикаста, надо отправлять пакеты по S0\u002F1.\u003Cbr\u002F\u003E\r\nВопрос, что будет если у вас два эквивалентных маршрута с одинаковой метрикой? В этом случае маршрутизатор будет выбирать по next-hop у данных маршрутов. У кого выше ip адрес, тот и победил. Если необходимо изменить данное поведение, то можно использовать ECMP. Подробнее \u003Ca href=\"https:\u002F\u002Fdrive.google.com\u002Ffile\u002Fd\u002F1yiam4-OwlDoXrfdfdienMN_nQaOJGi29\u002Fview?usp=sharing\"\u003Eтут\u003C\u002Fa\u003E.\u003Cbr\u002F\u003E\r\nПосле проверки правила RPF, маршрутизатор отправляет мультикаст пакет всем своим PIM соседям, за исключением того, от кого был получен данный пакет. Остальные PIM маршрутизаторы повторяют данный процесс. Путь, который прошел мультикаст пакет от источника до конечных получателей, образует дерево, которое называется — source-based distribution tree, shortest-path tree (SPT), source tree. Три разных названия, выбирайте любое.\u003Cbr\u002F\u003E\r\nКак решить вопрос с тем, что некоторым маршрутизаторам не сдался какой-то мультикастовый поток и отправлять его некому, а ему вышестоящий маршрутизатор шлет. Для это придуман Prune механизм. \u003Cbr\u002F\u003E\r\n\u003Cb\u003EPrune Message.\u003C\u002Fb\u003E\u003Cbr\u002F\u003E\r\nНапример, R2 будет продолжать слать R3 мультикаст, хотя R3 по правилу RPF дропает его. Зачем нагружать канал? R3 шлет PIM Prune Message и R2, при получении данного сообщения, удалит интерфейс S0\u002F1 из списка ( outgoing interface list ) для данного потока, список интерфейсов, с которых надо посылать данный трафик. \u003Cbr\u002F\u003E\r\n\u003Cblockquote\u003EThe following is a more formal definition of a PIM Prune message:\u003Cbr\u002F\u003E\r\nThe PIM Prune message is sent by one router to a second router to cause the second router to remove the link on which the Prune is received from a particular (S,G) SPT.\u003C\u002Fblockquote\u003E\u003Cbr\u002F\u003E\r\nПосле получения Prune сообщения, R2 выставляет Prune таймер в 3 минуты. Через три минуты он начнет отправлять трафик опять, пока не получит очередное Prune сообщение. Это в PIMv1.\u003Cbr\u002F\u003E\r\nА в PIMv2 добавлен State Refresh таймер ( по умолчанию 60 секунд ). Как только было отправлено Prune сообщение с R3, запускается данный таймер на R3. По истечении данного таймера, R3 будет отправлять State Refresh сообщение, которое будет сбрасывать 3-ех минутный Prune Timer на R2 для данной группы. \u003Cbr\u002F\u003E\r\nПричины отправки сообщения Prune:\u003Cbr\u002F\u003E\r\n\u003Cul\u003E\r\n\u003Cli\u003E Когда мультикаст пакет не прошел проверку RPF.\u003C\u002Fli\u003E\r\n\u003Cli\u003E Когда нет локально подключенных клиентов, который запросил мультикастовую группу ( IGMP Join) и нет PIM соседей, которым можно отправлять мультикастовый трафик ( Non-prune Interface).\u003C\u002Fli\u003E\r\n\u003C\u002Ful\u003E \u003Cbr\u002F\u003E\r\n\u003Cb\u003EGraft Message.\u003C\u002Fb\u003E\u003Cbr\u002F\u003E\r\nПредставим, что R3 не захотел трафик от R2, отправил Prune и получал мультикаст от R1. Но вдруг, упал канал между R1-R3 и R3 остался без мультикаста. Можно ждать 3 минуты, пока на R2 не истечет Prune Timer. 3 минуты ждать долго, чтоб не ждать, необходимо послать сообщение, которое моментально выведет данный интерфейс S0\u002F1 на R2 из pruned состояния. Таким сообщением будет Graft сообщение. После получения Graft сообщения, R2 отправит в ответ Graft-ACK.\u003Cbr\u002F\u003E\r\n\u003Cb\u003EPrune Override.\u003C\u002Fb\u003E\u003Cbr\u002F\u003E\r\n \u003Ca href=\"https:\u002F\u002Fi.imgur.com\u002Fzfo0Dx5.png\"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" alt=\"My Image\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fpost_images\u002Fbc7\u002F1d0\u002Fe9f\u002Fbc71d0e9f81b292e75d4a016a9b657ef.png\"\u002F\u003E\u003C\u002Fa\u003E\u003Cbr\u002F\u003E\r\nПосмотрим на данную схему. R1 вещает мультикаст в сегмент с двумя маршрутизаторами. R3 получает и вещает трафик, R2 получает, но вещать трафик ему некому. Он отправляет Prune сообщение к R1 в данный сегмент. R1 должен удалить Fa0\u002F0 из списка и перестать вещать в данный сегмент, но что будет c R3? А R3 находится в том же сегменте, тоже получил данное Prune сообщение и понял всю трагичность ситуации. Перед тем как R1 перестанет вещать, он устанавливает таймер в 3 секунды и перестанет вещать через 3 секунды. 3 секунды — именно столько времени у R3, чтоб не потерять свой мультикаст. Поэтому R3, как можно скорее, отправляет Pim Join сообщение для данной группы и R1 уже не думает переставать вещать. О Join сообщениях ниже.\u003Cbr\u002F\u003E\r\n\u003Cb\u003EAssert Message.\u003C\u002Fb\u003E\u003Cbr\u002F\u003E\r\n \u003Ca href=\"https:\u002F\u002Fi.imgur.com\u002FrliwmNF.png\"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" alt=\"My Image\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fpost_images\u002Ff1d\u002F9d1\u002Fd68\u002Ff1d9d1d6855fdc188deb28c75bde2d0d.png\"\u002F\u003E\u003C\u002Fa\u003E\u003Cbr\u002F\u003E\r\nПредставим такую ситуацию: в одну сеть вещают сразу два маршрутизатора. Получают один и тот же поток от источника, и оба вещают его в одну сеть за интерфейсом e0. Поэтому им надо определить кто же будет одним единственным вещателем для данной сети. Для этого используются сообщения Assert. Когда R2 и R3 детектируют дупликацию мультикаст трафика, то есть на R2 и R3 приходит мультикаст, который они сами вещают, маршрутизаторы понимают, что тут что-то не так. Маршрутизаторы отправляют в этом случае Assert сообщения, в которые включены Administrative Distance и метрика маршрута при помощи которого достигается источник мультикаста — 10.1.1.10. Победитель определяется так:\u003Cbr\u002F\u003E\r\n\u003Col\u003E\r\n\u003Cli\u003EТот у кого ниже AD.\u003C\u002Fli\u003E\r\n\u003Cli\u003EЕсли AD равны, то у кого ниже метрика.\u003C\u002Fli\u003E\r\n\u003Cli\u003EЕсли и тут равенство, то тот у кого выше IP в сети, в которую они вещают этот мультикаст.\u003C\u002Fli\u003E\r\n\u003C\u002Fol\u003E\u003Cbr\u002F\u003E\r\nПобедивший в этом голосовании, маршрутизатор становится Designated Router-ом. Для выбора DR также используются Pim Hello. В начале статьи было показано PIM Hello сообщение, там можно заметить DR поле. Побеждает тот, у кого выше IP адреса на этом линке.\u003Cbr\u002F\u003E\r\nПолезная табличка:\u003Cbr\u002F\u003E\r\n \u003Ca href=\"https:\u002F\u002Fi.imgur.com\u002FEt1kP7h.png\"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" alt=\"My Image\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fpost_images\u002F3de\u002Fe1a\u002Fc84\u002F3dee1ac8448b1fceaa9f1972eff802b7.png\"\u002F\u003E\u003C\u002Fa\u003E\u003Cbr\u002F\u003E\r\n\u003Cb\u003EMROUTE Table.\u003C\u002Fb\u003E\u003Cbr\u002F\u003E\r\nПосле первоначального рассмотрения работы протокола PIM, нам необходимо разобраться с тем, как работать с мультикастовой таблицей маршрутизации. В таблице mroute храниться информация о том, какие потоки были запрошены со стороны клиентов и какие потоки льются с мультикаст серверов. \u003Cbr\u002F\u003E\r\nНапример, при получения IGMP Membership Report или PIM Join на каком-то интерфейсе, в таблицу маршрутизации добавляется запись типа ( *, G ):\u003Cbr\u002F\u003E\r\n \u003Ca href=\"https:\u002F\u002Fi.imgur.com\u002FufXsgnR.jpg\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780q1\u002Fgetpro\u002Fhabr\u002Fpost_images\u002Fafd\u002F3ed\u002F52c\u002Fafd3ed52cef0f9f105a0b58dff18edee.jpg\" alt=\"My Image\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fpost_images\u002Fafd\u002F3ed\u002F52c\u002Fafd3ed52cef0f9f105a0b58dff18edee.jpg\" data-blurred=\"true\"\u002F\u003E\u003C\u002Fa\u003E\u003Cbr\u002F\u003E\r\nДанная запись означает, что был получен запрос на трафик с адресом 238.38.38.38. Флаг DC означает, что мультикаст будет работать в режиме Dense mode и С означает, что получатель непосредственно подключен к маршрутизатору, то есть маршрутизатор получил IGMP Membership Report, а PIM Join.\u003Cbr\u002F\u003E\r\nЕсли есть запись типа (S,G) означает, что у нас есть мультикаст поток:\u003Cbr\u002F\u003E\r\n \u003Ca href=\"https:\u002F\u002Fi.imgur.com\u002FQJCZZwf.jpg\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780q1\u002Fgetpro\u002Fhabr\u002Fpost_images\u002Fa78\u002Fcf2\u002F332\u002Fa78cf23325ddc6e0c3d65322340d7ff6.jpg\" alt=\"My Image\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fpost_images\u002Fa78\u002Fcf2\u002F332\u002Fa78cf23325ddc6e0c3d65322340d7ff6.jpg\" data-blurred=\"true\"\u002F\u003E\u003C\u002Fa\u003E\u003Cbr\u002F\u003E\r\nВ поле S — 192.168.1.11, у нас прописан IP адрес источника мультикаста, именно он будет проверяться правилом RPF. При проблемах, первым делом необходимо проверить юникастовую таблицу на маршрут к источнику. В поле Incoming Interface указывает интерфейс, на который поступает мультикаст. В юникастовой таблице маршрутизации, маршрут до источника должен ссылаться на интерфейс, указанный здесь. В Outgoing Interface указывается куда будет мультикаст перенаправлен. Если он пуст, значит к маршрутизатору не поступало запросов на данный трафик. Более подробную информацию о всех флагах можно найти \u003Ca href=\"https:\u002F\u002Fdrive.google.com\u002Ffile\u002Fd\u002F1ArBLFJdyN8tCangB5GL2JaS47FEZaad-\u002Fview?usp=sharing\"\u003Eздесь\u003C\u002Fa\u003E.\u003Cbr\u002F\u003E\r\n\u003Cb\u003EPIM Sparse-mode.\u003C\u002Fb\u003E\u003Cbr\u002F\u003E\r\nСтратегия Sparse-mode противоположна Dense-mode. Когда Sparse-mode получает мультикаст трафик, он будет отправлять трафик только через те интерфейсы, где были запросы на данный поток, например Pim Join или IGMP Report сообщения с запросом на данный трафик.\u003Cbr\u002F\u003E\r\nCхожие элементы у SM и DM:\u003Cbr\u002F\u003E\r\n\u003Cul\u003E\r\n\u003Cli\u003E Отношения соседства строятся также, как и в PIM DM.\u003C\u002Fli\u003E\r\n\u003Cli\u003E Работает правило RPF.\u003C\u002Fli\u003E\r\n\u003Cli\u003E Выбор DR аналогичен.\u003C\u002Fli\u003E\r\n\u003Cli\u003E Механизм Prune Overrides и сообщения Assert аналогичены.\u003C\u002Fli\u003E\r\n\u003C\u002Ful\u003E\u003Cbr\u002F\u003E\r\nДля контроля того, кому, где и какой мультикаст трафик нужен в сети, необходимо общий информационный центр. Таким центром у нас будет Rendezvous Point ( RP ). Все, кто хочет какой-то мультикаст трафик или кто-то начал получать мультикаст трафик от источника, то он отправляет его на RP.\u003Cbr\u002F\u003E\r\nКогда RP получит мультикаст трафик, то отправит его тем маршрутизаторам, которые запросили до этого этот трафик. \u003Cbr\u002F\u003E\r\n \u003Ca href=\"https:\u002F\u002Fi.imgur.com\u002F5AErtbS.jpg\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780q1\u002Fgetpro\u002Fhabr\u002Fpost_images\u002F025\u002Fd45\u002F651\u002F025d4565117dce5f8da07609c823c63e.jpg\" alt=\"My Image\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fpost_images\u002F025\u002Fd45\u002F651\u002F025d4565117dce5f8da07609c823c63e.jpg\" data-blurred=\"true\"\u002F\u003E\u003C\u002Fa\u003E\u003Cbr\u002F\u003E\r\nПредставим такую топологию, где RP это R3. Как только R1 получит трафик от S1, то он инкапсулирует данный мультикаст пакет в юникастовое PIM Register сообщение и отправит его на RP. Откуда он знает кто RP? В данном случае, он настроен статически, а о динамической настройке RP поговорим позже. \u003Cbr\u002F\u003E\r\n\u003Cblockquote\u003Eip pim rp-address 3.3.3.3\u003C\u002Fblockquote\u003E\u003Cbr\u002F\u003E\r\nRP посмотрит — а была ли информация от кого-то, кто хотел бы получать этот трафик? Предположим, что не было. Тогда RP отправит R1 сообщение PIM Register-Stop, что означает — никому не нужен этот мультикаст, в регистрации отказано. R1 не будет посылать мультикаст. Но хост-источник мультикаста будет слать его, так что R1 после получения Register-Stop, запустит таймер Register-Suppression timer, равный 60 секундам. За 5 секунд до истечения данного таймера, R1 будет посылать пустое Register сообщение с Null-Register bit ( то есть без инкапсулированного мультикаст пакета) в сторону RP. RP в свою очередь будет действовать так:\u003Cbr\u002F\u003E\r\n\u003Cul\u003E\r\n\u003Cli\u003E Если получателей как не было, так и нет, то он будет отвечать Register-Stop сообщением.\u003C\u002Fli\u003E\r\n\u003Cli\u003E Если получатели появились, то он никак не ответит на него. R1 не получив на свою регистрацию отказа в течении 5 секунд, обрадуется и отправит Register сообщение с инкапсулированным мультикаст на RP.\u003C\u002Fli\u003E\r\n\u003C\u002Ful\u003E\u003Cbr\u002F\u003E\r\nКак мультикаст доходит до RP вроде бы разобрались, теперь попытаемся ответить на вопрос как RP доводит трафик до получателей. Здесь необходимо ввести новое понятие — root-path tree (RPT). RPT — это дерево с корнем в RP, растущее в сторону получателей, разветвляющиеся на каждом PIM-SM маршрутизаторе. RP создает его, получая PIM Join сообщения и добавляет в дерево новую ветвь. И так, делает каждый нижестоящий маршрутизатор. Общее правило выглядит так:\u003Cbr\u002F\u003E\r\n\u003Cul\u003E\r\n\u003Cli\u003E Когда PIM-SM маршрутизатор получает PIM Join сообщение на каком-либо интерфейсе, за исключением интерфейса за котором скрывается RP, он добавляет в дерево новую ветвь.\u003C\u002Fli\u003E\r\n\u003Cli\u003E Также ветвь добавляется, когда PIM-SM маршрутизатор получает IGMP Membership Report с непосредственно подключенного хоста. \u003C\u002Fli\u003E\r\n\u003C\u002Ful\u003E\u003Cbr\u002F\u003E\r\nПредставим, что у нас появился клиент мультикаста на маршрутизаторе R5 на группу 228.8.8.8. Как только R5 получит IGMP Membership Report от хоста, R5 отправляет PIM Join в направлении RP, а сам добавляет в дерево интерфейс, смотрящий на хост. Далее, R4 получает PIM Join от R5, добавляет в дерево интерфейс Gi0\u002F1 и отправляет PIM Join в направлении RP. Наконец то, RP ( R3 ) получает PIM Join и добавляет Gi0\u002F0 в дерево. Таким образом, получается регистрация получателя мультикаста. У нас строится дерево с корнем R3-Gi0\u002F0 → R4-Gi0\u002F1 → R5-Gi0\u002F0.\u003Cbr\u002F\u003E\r\nПосле этого, будет отправлен PIM Join к R1 и R1 начнет слать мультикаст трафик. Важно заметить, что если хост запросил трафик до того, как началось вещание мультикаста, то RP не будет отправлять PIM Join и вообще не будет ничего отправлять в строну R1.\u003Cbr\u002F\u003E\r\nЕсли вдруг пока отправляется мультикаст, хост перестанет хотеть его получать, как только RP получит PIM Prune на интерфейс Gi0\u002F0, то сразу отправит PIM Register-Stop непосредственно на R1, а затем и PIM Prune сообщение через интерфейс Gi0\u002F1. PIM Register-stop отправляется юникастом на тот адрес, с которого поступило PIM Register.\u003Cbr\u002F\u003E\r\nКак мы говорили раньше, как только маршрутизатор отправляет PIM Join другому, например R5 на R4, то на R4 добавляется запись:\u003Cbr\u002F\u003E\r\n \u003Ca href=\"https:\u002F\u002Fi.imgur.com\u002FmsZjbr8.jpg\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780q1\u002Fgetpro\u002Fhabr\u002Fpost_images\u002F9f7\u002F730\u002F678\u002F9f7730678743efb4e9670d18fcd54525.jpg\" alt=\"My Image\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fpost_images\u002F9f7\u002F730\u002F678\u002F9f7730678743efb4e9670d18fcd54525.jpg\" data-blurred=\"true\"\u002F\u003E\u003C\u002Fa\u003E\u003Cbr\u002F\u003E\r\nИ запускается таймер, что сбросить данный таймер R5 должен постоянно PIM Join сообщения постоянно, а то R4 исключит из outgoing list. R5 будет отправлять каждые 60 PIM Join сообщения.\u003Cbr\u002F\u003E\r\n\u003Cb\u003EShortest-Path Tree Switchover.\u003C\u002Fb\u003E\u003Cbr\u002F\u003E\r\nМы добавим интерфейс между R1 и R5, посмотрим как будет литься трафик при такой топологии. \u003Cbr\u002F\u003E\r\n \u003Ca href=\"https:\u002F\u002Fi.imgur.com\u002FwLKEyyg.jpg\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780q1\u002Fgetpro\u002Fhabr\u002Fpost_images\u002Fafd\u002F113\u002Feb0\u002Fafd113eb01e7deda4c389fbb1a02060a.jpg\" alt=\"My Image\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fpost_images\u002Fafd\u002F113\u002Feb0\u002Fafd113eb01e7deda4c389fbb1a02060a.jpg\" data-blurred=\"true\"\u002F\u003E\u003C\u002Fa\u003E\u003Cbr\u002F\u003E\r\nДопустим, что трафик отправлялся и получался по старой схеме R1-R2-R3-R4-R5 и тут мы подключили и настроили интерфейс между R1 и R5.\u003Cbr\u002F\u003E\r\nПервым делом, у нас перестроиться юникастовая таблица маршрутизации на R5 и теперь сеть 192.168.1.0\u002F24 достигается через интерфейс R5 Gi0\u002F2. Теперь R5 получая мультикаст на интерфейсе Gi0\u002F1, понимает, что правило RPF не удовлетворяется и мультикаст логичнее бы получать на Gi0\u002F2. Он должен отключиться от RPT и построить более короткое дерево, которое называется Shortest-Path Tree ( SPT ). Для этого он через Gi0\u002F2 отправляет PIM Join на R1 и R1 начинает слать мультикаст еще и через Gi0\u002F2. Теперь R5 надо отписаться от RPT, чтоб не получать две копии. Для этого он отправляет Prune сообщение указывая ip адрес источника и вставляя специальный бит — RPT-bit. Это значит, что не надо мне посылать трафик, у меня здесь дерево получше. RP также отправляет в сторону R1 PIM Prune сообщения, но не отправляет Register-Stop сообщение. Еще одна особенность: R5 теперь будет постоянно отправлять PIM Prune на RP, так как R1 продолжает отправлять PIM Register на RP каждую минуту. RP пока не будет новых желающих данного трафика будет отвечать ему отказом. R5 уведомляет RP, что он продолжает получать мультикаст через SPT.\u003Cbr\u002F\u003E\r\n\u003Cb\u003EДинамический поиск RP. \u003Cbr\u002F\u003E\r\nAuto-RP.\u003C\u002Fb\u003E\u003Cbr\u002F\u003E\r\nДанная технология является проприетарной от Cisco и не пользуется особой популярной, но все еще жива. Работа Auto-RP состоит из двух основных этапов:\u003Cbr\u002F\u003E\r\n1) RP шлет RP-Announce сообщения на зарезервированный адрес — 224.0.1.39, объявляя себя RP либо для всех либо для определенных групп. Отправляется данное сообщение каждую минуту.\u003Cbr\u002F\u003E\r\n2) Необходим RP mapping agent, который будет слать RP-Discovery сообщения с указанием для каких групп какой RP необходимо слушать. Именно из этого сообщения, обычные PIM маршрутизаторы будут определять для себя RP. Mapping Agent может быть как сам RP маршрутизатор, так и какой-либо отдельный PIM маршрутизатор. RP-Discovery отправляется на адрес 224.0.1.40 c таймером в одну минуту.\u003Cbr\u002F\u003E\r\nПосмотрим на процесс поподробнее:\u003Cbr\u002F\u003E\r\nНастроим R3 как RP:\u003Cbr\u002F\u003E\r\n\u003Cblockquote\u003Eip pim send-rp-announce loopback 0 scope 10\u003C\u002Fblockquote\u003E\u003Cbr\u002F\u003E\r\nR2 как mapping agent:\u003Cbr\u002F\u003E\r\n\u003Cblockquote\u003Eip pim send-rp-discovery loopback 0 scope 10\u003C\u002Fblockquote\u003E\u003Cbr\u002F\u003E\r\nА на всех остальных будем ожидать RP через Auto-RP:\u003Cbr\u002F\u003E\r\n\u003Cblockquote\u003Eip pim autorp listener\u003C\u002Fblockquote\u003E\u003Cbr\u002F\u003E\r\nКак только мы настроим R3, он начнет отправлять RP-Announce:\u003Cbr\u002F\u003E\r\n \u003Ca href=\"https:\u002F\u002Fi.imgur.com\u002F6c4WucN.jpg\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780q1\u002Fgetpro\u002Fhabr\u002Fpost_images\u002Faae\u002Fae2\u002F565\u002Faaeae25659fbacd4ba49ae4c5486f46f.jpg\" alt=\"My Image\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fpost_images\u002Faae\u002Fae2\u002F565\u002Faaeae25659fbacd4ba49ae4c5486f46f.jpg\" data-blurred=\"true\"\u002F\u003E\u003C\u002Fa\u003E\u003Cbr\u002F\u003E\r\nА R2 после настройки mapping agent-ом, начнет ждать сообщения RP-Announce. Только когда он найдет хотя бы один RP, то начнет отправлять RP-Discovery:\u003Cbr\u002F\u003E\r\n \u003Ca href=\"https:\u002F\u002Fi.imgur.com\u002Flw2JuDD.jpg\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780q1\u002Fgetpro\u002Fhabr\u002Fpost_images\u002Ffb8\u002Fe44\u002F7c2\u002Ffb8e447c26e33ecda18cb82c5f05c938.jpg\" alt=\"My Image\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fpost_images\u002Ffb8\u002Fe44\u002F7c2\u002Ffb8e447c26e33ecda18cb82c5f05c938.jpg\" data-blurred=\"true\"\u002F\u003E\u003C\u002Fa\u003E\u003Cbr\u002F\u003E\r\nТаким образом, как только обычные маршрутизаторы ( PIM RP Listener ) получат данное сообщения, они будут знать где искать RP.\u003Cbr\u002F\u003E\r\nОдна из основных проблем Auto-RP заключается в том, что чтобы получать сообщения RP-Announce и RP-Discovery необходимо отправлять PIM Join на адреса 224.0.1.39-40, а для того, чтобы отправить, надо знать где находится RP. Классическая проблема курицы и яйца. Для решение это проблемы, был придуман режим PIM Sparse-Dense-Mode. Если маршрутизатор не знает RP, то он работает в режиме Dense-mode, если знает, то в режиме Sparse-mode. Когда на интерфейсах обычных маршрутизаторов настроен PIM Sparse-mode и команда ip pim autorp listener, то маршрутизатор будет работать в режиме Dense-mode только для мультикаста непосредственно Auto-RP протокола ( 224.0.1.39-40 ).\u003Cbr\u002F\u003E\r\n\u003Cb\u003EBootStrap Router (BSR).\u003C\u002Fb\u003E\u003Cbr\u002F\u003E\r\nДанный функция работает похоже на Auto-RP. Каждый RP шлет сообщение mapping agent-у, который собирает маппинг информацию и далее рассказывает всем остальным маршрутизаторам. Опишем процесс аналогично Auto-RP:\u003Cbr\u002F\u003E\r\n1) Как только мы настроим R3 в качестве кандидата быть RP, командой:\u003Cbr\u002F\u003E\r\n\u003Cblockquote\u003Eip pim rp-candidate loopback 0\u003C\u002Fblockquote\u003E\u003Cbr\u002F\u003E\r\nТо R3 ничего делать не будет, для того, чтобы начать слать специальные сообщение, ему, для начала, надо найти mapping agent-а. Таким образом, переходим ко второму шагу.\u003Cbr\u002F\u003E\r\n2) Настраиваем R2 как mapping agent:\u003Cbr\u002F\u003E\r\n\u003Cblockquote\u003Eip pim bsr-candidate loopback 0\u003C\u002Fblockquote\u003E\u003Cbr\u002F\u003E\r\nR2 начинает рассылать PIM Bootstrap сообщения, где указывает себя в качестве mapping agent-а:\u003Cbr\u002F\u003E\r\n\u003Ca href=\"https:\u002F\u002Fi.imgur.com\u002FuAj49oT.jpg\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780q1\u002Fgetpro\u002Fhabr\u002Fpost_images\u002F729\u002F3a4\u002Fad1\u002F7293a4ad164ed8342ff42ceffee9a32b.jpg\" alt=\"My Image\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fpost_images\u002F729\u002F3a4\u002Fad1\u002F7293a4ad164ed8342ff42ceffee9a32b.jpg\" data-blurred=\"true\"\u002F\u003E\u003C\u002Fa\u003E\u003Cbr\u002F\u003E\r\nОтправляется данное сообщение на адрес 224.0.013, которое PIM протокол использует и для других своих сообщений. Он отправляет их во все стороны и поэтому нет проблемы курицы и яйца, как было в Auto-RP.\u003Cbr\u002F\u003E\r\n3) Как только RP получит сообщение от BSR маршрутизатора, он сразу отправит юникастовое сообщение на адрес BSR маршрутизатора:\u003Cbr\u002F\u003E\r\n\u003Ca href=\"https:\u002F\u002Fi.imgur.com\u002FqwtXY88.jpg\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780q1\u002Fgetpro\u002Fhabr\u002Fpost_images\u002F5ed\u002F217\u002F8c1\u002F5ed2178c151886f79c1e6197b9b5385b.jpg\" alt=\"My Image\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fpost_images\u002F5ed\u002F217\u002F8c1\u002F5ed2178c151886f79c1e6197b9b5385b.jpg\" data-blurred=\"true\"\u002F\u003E\u003C\u002Fa\u003E\u003Cbr\u002F\u003E\r\nПосле чего, BSR получив информацию о RP, разошлет их мультикастом на адрес 224.0.0.13, который слушают все PIM маршрутизаторы. Поэтому, аналога команды \u003Ci\u003Eip pim autorp listener\u003C\u002Fi\u003E для обычных маршрутизаторов нет в BSR.\u003Cbr\u002F\u003E\r\n\u003Cb\u003EAnycast RP with Multicast Source Discovery Protocol (MSDP).\u003C\u002Fb\u003E\u003Cbr\u002F\u003E\r\nAuto-RP и BSR нам позволяют распредилить нагрузку на RP следующим образом: У каждой мультикаст группы есть только один активный RP. Не получится сделать распределение нагрузки для одной мультикаст группы несколько RP. MSDP делает это при помощи выдачи RP маршрутизаторам одинакового ip адреса с маской 255.255.255.255. MSDP узнает информацию при помощи одного из методов: статики, Auto-RP или BSR.\u003Cbr\u002F\u003E\r\n\u003Ca href=\"https:\u002F\u002Fi.imgur.com\u002FU4aDz5H.png\"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" alt=\"My Image\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fpost_images\u002F406\u002F51a\u002F032\u002F40651a032dadaaf6e0c51cbf06c3fbf3.png\"\u002F\u003E\u003C\u002Fa\u003E\u003Cbr\u002F\u003E\r\nНа картинке у нас Auto-RP конфигурация с MSDP. Оба RP настроены с ip адресом 172.16.1.1\u002F32 на Loopback 1 интерфейсе и используется для всех групп. При RP-Announce оба маршрутизатора рассказывают о себе, ссылаясь на этот адрес. Auto-RP mapping agent, получив информацию, рассылает RP-Discovery об RP c адресом 172.16.1.1\u002F32. Про сеть 172.16.1.1\u002F32, маршрутизаторам мы рассказываем при помощи IGP и, соответственно. Таким образом, PIM маршрутизаторы запрашивают или регистрируют потоки с того RP, к который указан как next-hop у маршрута к сети 172.16.1.1\u002F32. Cам протокол MSDP же призван для самих RP, чтоб обмениваться сообщениями о информации про мультикаст.\u003Cbr\u002F\u003E\r\nРассмотрим такую топологию:\u003Cbr\u002F\u003E\r\n\u003Ca href=\"https:\u002F\u002Fi.imgur.com\u002FzgkGDOP.jpg\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780q1\u002Fgetpro\u002Fhabr\u002Fpost_images\u002F2ba\u002Ff2d\u002Fdc4\u002F2baf2ddc4deb54ebb671a6fb52282a41.jpg\" alt=\"My Image\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fpost_images\u002F2ba\u002Ff2d\u002Fdc4\u002F2baf2ddc4deb54ebb671a6fb52282a41.jpg\" data-blurred=\"true\"\u002F\u003E\u003C\u002Fa\u003E\u003Cbr\u002F\u003E\r\nSwitch6 вещает трафик на адрес 238.38.38.38 и о нем пока знает только RP-R1. Вот Switch7 и Switch8 запросили данную группу. Маршрутизаторы R5 и R4 отправят PIM Join на R1 и R3, соответственно. Почему? Маршрут до 13.13.13.13 у R5 будет ссылаться на R1 по метрике IGP, как и у R4.\u003Cbr\u002F\u003E\r\nRP-R1 знает о потоке и начнет вещать его в сторону R5, а вот R4 ничего о нем не знает, так как R1 просто так его отправлять не будет. Поэтому необходим MSDP. Настраиваем его на R1 и R5:\u003Cbr\u002F\u003E\r\n\u003Cblockquote\u003Eip msdp peer 3.3.3.3 connect-source Loopback1 на R1\u003C\u002Fblockquote\u003E\u003Cbr\u002F\u003E\r\n\u003Cblockquote\u003Eip msdp peer 1.1.1.1 connect-source Loopback3 на R3\u003C\u002Fblockquote\u003E\u003Cbr\u002F\u003E\r\nОни поднимут сессию между друг другом и при получении какого-либо потока будут сообщать о нем своему RP соседу.\u003Cbr\u002F\u003E\r\nRP-R1 как только получит поток от Switch6, сразу отправит юникастом MSDP Source-Active сообщение, где будет содержаться информация типа ( S, G) — информация о источнике и назначении мультикаста. Теперь, когда RP-R3 будет знать, что такой источник как Switch6, он при получении запроса от R4 на данный поток, будет слать в сторону Switch6 PIM Join, руководстваясь таблицей маршрутизации. Следовательно, R1 получив такой PIM Join, начнет слать трафик в сторону RP-R3.\u003Cbr\u002F\u003E\r\nMSDP работает по TCP, RP посылают друг другу keepalive сообщения для проверки жизнеспособности. Таймер равен 60 cекундам.\u003Cbr\u002F\u003E\r\nОстается непонятной функция разделения MSDP пиров в различные домены, так как в сообщениях Keepalive и SA не указывается принадлежность какому-либо домену. Также в данной топологии тестировалась конфигурация с указанием различных доменов — разницы в работе не было. \u003Cbr\u002F\u003E\r\nЕсли кто-то может внести ясность, с радостью почитаю в комментариях.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nНа этом думаю закончить статью. Внизу полезный материалы и ссылки, которые использовались:\u003Cbr\u002F\u003E\r\n\u003Col\u003E\r\n\u003Cli\u003ECCIE Routing and Switching v5.0 Official Cert Guide, Volume 2, Fifth Edition, Narbik Kocharians, Terry Vinson.\u003C\u002Fli\u003E\r\n\u003Cli\u003E\u003Ca href=\"https:\u002F\u002Fhabr.com\u002Fru\u002Fpost\u002F217585\u002F#L2_Multicast\"\u003EСети для самых маленьких. Часть девятая. Мультикаст\u003C\u002Fa\u003E\u003C\u002Fli\u003E\r\n\u003C\u002Fol\u003E\u003C\u002Fdiv\u003E","tags":[{"titleHtml":"cisco multicast pim"}],"metadata":{"stylesUrls":[],"scriptUrls":[],"shareImageUrl":"https:\u002F\u002Fhabr.com\u002Fshare\u002Fpublication\u002F450582\u002F644125adbb6bdb7ea9e95fbc09cc05dc\u002F","shareImageWidth":1200,"shareImageHeight":630,"vkShareImageUrl":"https:\u002F\u002Fhabr.com\u002Fshare\u002Fpublication\u002F450582\u002F644125adbb6bdb7ea9e95fbc09cc05dc\u002F?format=vk","schemaJsonLd":"{\"@context\":\"http:\\\u002F\\\u002Fschema.org\",\"@type\":\"Article\",\"mainEntityOfPage\":{\"@type\":\"WebPage\",\"@id\":\"https:\\\u002F\\\u002Fhabr.com\\\u002Fru\\\u002Fpost\\\u002F450582\\\u002F\"},\"headline\":\"Принципы работы протокола PIM\",\"datePublished\":\"2019-05-07T09:12:56+03:00\",\"dateModified\":\"2019-05-07T13:42:50+03:00\",\"author\":{\"@type\":\"Person\",\"name\":\"Руслан Мамедов\"},\"publisher\":{\"@type\":\"Organization\",\"name\":\"Habr\",\"logo\":{\"@type\":\"ImageObject\",\"url\":\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fa_\\\u002Flk\\\u002F9m\\\u002Fa_lk9mjkccjox-zccjrpfolmkmq.png\"}},\"description\":\"Протокол PIM &mdash; это набор протоколов для передачи мультикаста в сети между маршрутизаторами. Отношения соседства строится аналогично как и в случае динамических п...\",\"url\":\"https:\\\u002F\\\u002Fhabr.com\\\u002Fru\\\u002Fpost\\\u002F450582\\\u002F#post-content-body\",\"about\":[\"h_cisconetworks\",\"h_network_technologies\",\"f_admin\"],\"image\":[\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fpost_images\\\u002Fe67\\\u002F8a0\\\u002F1fc\\\u002Fe678a01fc7879ecf22bc6f9a3825f9a6.jpg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fpost_images\\\u002F6cd\\\u002F08c\\\u002Ffb6\\\u002F6cd08cfb6842680447d56860334af52c.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fpost_images\\\u002Fbc7\\\u002F1d0\\\u002Fe9f\\\u002Fbc71d0e9f81b292e75d4a016a9b657ef.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fpost_images\\\u002Ff1d\\\u002F9d1\\\u002Fd68\\\u002Ff1d9d1d6855fdc188deb28c75bde2d0d.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fpost_images\\\u002F3de\\\u002Fe1a\\\u002Fc84\\\u002F3dee1ac8448b1fceaa9f1972eff802b7.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fpost_images\\\u002Fafd\\\u002F3ed\\\u002F52c\\\u002Fafd3ed52cef0f9f105a0b58dff18edee.jpg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fpost_images\\\u002Fa78\\\u002Fcf2\\\u002F332\\\u002Fa78cf23325ddc6e0c3d65322340d7ff6.jpg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fpost_images\\\u002F025\\\u002Fd45\\\u002F651\\\u002F025d4565117dce5f8da07609c823c63e.jpg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fpost_images\\\u002F9f7\\\u002F730\\\u002F678\\\u002F9f7730678743efb4e9670d18fcd54525.jpg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fpost_images\\\u002Fafd\\\u002F113\\\u002Feb0\\\u002Fafd113eb01e7deda4c389fbb1a02060a.jpg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fpost_images\\\u002Faae\\\u002Fae2\\\u002F565\\\u002Faaeae25659fbacd4ba49ae4c5486f46f.jpg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fpost_images\\\u002Ffb8\\\u002Fe44\\\u002F7c2\\\u002Ffb8e447c26e33ecda18cb82c5f05c938.jpg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fpost_images\\\u002F729\\\u002F3a4\\\u002Fad1\\\u002F7293a4ad164ed8342ff42ceffee9a32b.jpg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fpost_images\\\u002F5ed\\\u002F217\\\u002F8c1\\\u002F5ed2178c151886f79c1e6197b9b5385b.jpg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fpost_images\\\u002F406\\\u002F51a\\\u002F032\\\u002F40651a032dadaaf6e0c51cbf06c3fbf3.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fpost_images\\\u002F2ba\\\u002Ff2d\\\u002Fdc4\\\u002F2baf2ddc4deb54ebb671a6fb52282a41.jpg\"]}","metaDescription":"Протокол PIM — это набор протоколов для передачи мультикаста в сети между маршрутизаторами. Отношения соседства строится аналогично как и в случае динамических протоколов маршрутизации. PIMv2...","mainImageUrl":null,"amp":true},"polls":[],"commentsEnabled":true,"rulesRemindEnabled":false,"votesEnabled":true,"status":"published","plannedPublishTime":null,"checked":null,"isEditorial":false}},"articlesIds":{},"isLoading":false,"pagesCount":{},"route":{},"reasonsList":null,"view":"cards","lastVisitedRoute":{},"ssrCommentsArticleIds":[""],"karma":{}},"authorContribution":{"authors":{}},"betaTest":{"currentAnnouncement":null,"announcements":{},"announcementCards":null,"announcementComments":{},"announcementCommentThreads":{},"announcementCommentingStatuses":{},"archivedList":[]},"authorStatistics":{"articleRefs":{},"articleIds":{},"pagesCount":{},"route":{},"viewsCount":[],"maxStatsCount":{}},"career":{"seoLandings":[],"hubs":"cisconetworks,network_technologies"},"comments":{"articleComments":{},"searchCommentsResults":null,"previewComment":null,"pagesCount":null,"commentAccess":{},"scrollParents":{},"pageArticleComments":{"lastViewedComment":0,"postId":null,"lastCommentTimestamp":"","moderated":[],"moderatedIds":[],"commentRoute":""}},"companies":{"companyRefs":{},"companyIds":{},"companyTopIds":{},"pagesCount":{},"companyProfiles":{},"companiesCategories":[],"companiesCategoriesTotalCount":0,"companiesWidgets":{},"companiesWorkers":{},"companiesFans":{},"route":{},"isLoading":false,"companyWorkersLoading":false,"companyFansLoading":false,"vacancies":{}},"companiesContribution":{"hubs":{},"flows":{},"companyRefs":{}},"companyHubsContribution":{"contributionRefs":{"hubRefs":{},"hubIds":{}}},"conversation":{"messages":[],"respondent":null,"isLoadMore":false},"conversations":{"conversations":[],"unreadCount":0,"pagesCount":0,"isLoadMore":false},"desktopState":{"desktopFl":null,"desktopHl":null,"isChecked":false,"isLoginDemanded":false},"dfp":{"slotsDict":{}},"docs":{"menu":{},"articles":{},"mainMenu":[],"loading":{"main":false,"dropdown":false,"article":false}},"feature":{"isProbablyVisible":"true"},"flows":{"flows":[{"alias":"develop","id":1,"route":{"name":"FLOW_PAGE","params":{"flowName":"develop"}}},{"alias":"admin","id":6,"route":{"name":"FLOW_PAGE","params":{"flowName":"admin"}}},{"alias":"design","id":2,"route":{"name":"FLOW_PAGE","params":{"flowName":"design"}}},{"alias":"management","id":3,"route":{"name":"FLOW_PAGE","params":{"flowName":"management"}}},{"alias":"marketing","id":4,"route":{"name":"FLOW_PAGE","params":{"flowName":"marketing"}}},{"alias":"popsci","id":7,"route":{"name":"FLOW_PAGE","params":{"flowName":"popsci"}}}]},"global":{"isPwa":false,"device":"desktop","isHabrCom":true},"hubs":{"hubRefs":{},"hubIds":{},"pagesCount":{},"isLoading":false,"route":{}},"hubsBlock":{"hubRefs":{},"hubIds":{}},"i18n":{"fl":"ru","hl":"ru"},"info":{"infoPage":{},"isLoading":true},"location":{"urlStruct":{"protocol":null,"slashes":null,"auth":null,"host":null,"port":null,"hostname":null,"hash":null,"search":null,"query":{},"pathname":null,"path":null,"href":""},"searchQuery":null},"me":{"user":null,"ppgDemanded":false,"karmaResetInfo":{"canReincarnate":null,"wasReincarnated":null,"currentScore":null},"notes":null},"mostReadingList":{"mostReadingListIds":[],"mostReadingListRefs":null,"promoPost":null},"pinnedPost":{"pinnedPost":null},"ppa":{"articles":{},"card":null,"transactions":null,"totalTransactions":null,"isAccessible":null},"projectsBlocks":{"activeBlocks":{}},"pullRefresh":{"shouldRefresh":false},"sandbox":{"articleIds":[],"articleRefs":{},"pagesCount":null,"route":{},"lastVisitedRoute":{},"isLoading":false},"settingsOther":{"inputs":{"uiLang":{"errors":[],"ref":null,"value":""},"articlesLangEnglish":{"errors":[],"ref":null,"value":false},"articlesLangRussian":{"errors":[],"ref":null,"value":false},"agreement":{"errors":[],"ref":null,"value":false},"email":{"errors":[],"ref":null,"value":true},"digest":{"errors":[],"ref":null,"value":true}}},"similarList":{"similarListIds":[],"similarListRefs":null},"ssr":{"error":null,"isDataLoaded":false,"isDataLoading":false,"isHydrationFailed":false,"isServer":false},"userHubsContribution":{"contributionRefs":{"hubRefs":{},"hubIds":{}}},"userInvites":{"availableInvites":0,"usedInvitesIds":[],"usedInvitesRefs":{},"usedInvitesPagesCount":0,"unusedInvitesIds":[],"unusedInvitesRefs":{},"unusedInvitesPagesCount":0},"users":{"authorRefs":{},"authorIds":{},"pagesCount":{},"authorProfiles":{},"userHubs":{},"userInvitations":{},"authorFollowers":{},"authorFollowed":{},"karmaStats":[],"statistics":null,"isLoading":false,"authorFollowersLoading":false,"authorFollowedLoading":false,"userHubsLoading":false,"userInvitationsLoading":false,"route":{}},"viewport":{"prevScrollY":{},"scrollY":0,"width":0},"tracker":{"items":{},"pagesCache":{},"markedViewedSilently":{},"markedRead":{},"unreadCounters":{"applications":null,"system":null,"mentions":null,"subscribers":null,"posts_and_comments":null},"unviewedCounters":{"applications":null,"system":null,"mentions":null,"subscribers":null,"posts_and_comments":null}}};(function(){var s;(s=document.currentScript||document.scripts[document.scripts.length-1]).parentNode.removeChild(s);}());</script>
<script src="https://assets.habr.com/habr-web/js/chunk-vendors.c2c3fc9a.js" defer></script><script src="https://assets.habr.com/habr-web/js/app.c0af73e7.js" defer></script>



    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    </script>
  
  <script type="text/javascript" >
    (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
    m[i].l=1*new Date();k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
    (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

    ym(24049213, "init", {
      defer:true,
      trackLinks:true,
      accurateTrackBounce:true,
      webvisor:false,
    });
  </script>
  <noscript>
    <div>
      <img src="https://mc.yandex.ru/watch/24049213" style="position:absolute; left:-9999px;" alt="" />
    </div>
  </noscript>
  
    <script type="text/javascript">
      window.addEventListener('load', function () {
        setTimeout(() => {
          const img = new Image();
          img.src = 'https://vk.com/rtrg?p=VK-RTRG-421343-57vKE';
        }, 0);
      });
    </script>
  
</body>
</html>
